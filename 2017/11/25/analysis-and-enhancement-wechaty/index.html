<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      解析WebWxApp代码来增强wechaty功能（一） | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>解析WebWxApp代码来增强wechaty功能（一） | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="解析WebWxApp代码来增强wechaty功能（一）" />
<meta name="author" content="binsee" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Conversational RPA SDK for Chatbot Makers" />
<meta property="og:description" content="Conversational RPA SDK for Chatbot Makers" />
<link rel="canonical" href="https://wechaty.js.org/2017/11/25/analysis-and-enhancement-wechaty/" />
<meta property="og:url" content="https://wechaty.js.org/2017/11/25/analysis-and-enhancement-wechaty/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2017/binsee-wechaty-structure.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-11-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2017/binsee-wechaty-structure.webp" />
<meta property="twitter:title" content="解析WebWxApp代码来增强wechaty功能（一）" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"binsee"},"dateModified":"2017-11-25T00:00:00+00:00","datePublished":"2017-11-25T00:00:00+00:00","description":"Conversational RPA SDK for Chatbot Makers","headline":"解析WebWxApp代码来增强wechaty功能（一）","image":"https://wechaty.js.org/assets/2017/binsee-wechaty-structure.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2017/11/25/analysis-and-enhancement-wechaty/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"binsee"},"url":"https://wechaty.js.org/2017/11/25/analysis-and-enhancement-wechaty/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#hacking">hacking</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">解析WebWxApp代码来增强wechaty功能（一）</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/binsee">
                            <img class="rounded-circle" src="/assets/contributors/binsee/avatar.webp" alt="Binsee" width="70"/>
                          </a>
                        
						<small class="ml-3"> Binsee <span><a target="_blank" href="" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Nov 25, 2017 · <span class="reading-time">
  
  
    15 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2017/binsee-wechaty-structure.webp" alt="解析WebWxApp代码来增强wechaty功能（一）">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p><img src="/assets/2017/binsee-wechaty-structure.webp" alt="wechaty结构脑图" /></p>

<p>一个菜鸟如何通过解析webWxApp与wechaty代码，来给wechaty增加新特性的回顾。</p>

<h2 id="简述">简述</h2>

<p>我对wechaty一开始是因为兴趣，而并非是项目需要，因此只是观望。直到看到美女<a href="https://github.com/lijiarui">lijiarui</a>提出的issue<a href="https://github.com/wechaty/wechaty/issues/710">#710 Cannot send pdf file using MediaMessage</a>，被赏金诱惑才尝试着手来解决这个问题(:joy:)，并陆续提交了一些pr来增强wechaty的功能(论激励的重要性:joy:)。</p>

<blockquote>
  <p>Pull requests list:
<a href="https://github.com/wechaty/wechaty/pull/714">#714 send any type file</a>
<a href="https://github.com/wechaty/wechaty/pull/727">#727 Add Message.forward() forward message</a>
<a href="https://github.com/wechaty/wechaty/pull/744">#744 emit RECALLED type msg(fix #8)</a>
<a href="https://github.com/wechaty/wechaty/pull/771">#771 Support for send 25Mb+ files</a></p>
</blockquote>

<p>在这个过程过，为了实现这些功能，不得不尝试去阅读WebWxApp及wechaty的源码，来了解他们的功能结构，以及学习typesrcipt。
本文通过记录解决这几个问题的过程，来对WebWxApp和Wechaty的进行一些解读。</p>

<p>我接触wechaty时是在V0.8.x版本，此文提及的pr代码及对wechaty结构的理解适用于V0.8.x版本，最新的0.10.x版本的<code class="language-plaintext highlighter-rouge">puttet-web</code>进行了重构，一些地方会有不同，因此仅做参考。</p>

<p>作为一个菜鸟，对一些知识的理解认识不足或错误的地方，希望大佬们指正。</p>

<h2 id="计划内容">计划内容</h2>

<ul>
  <li>wechaty结构的简单分析</li>
  <li>捕捉撤消信息事件</li>
  <li>实现转发信息功能（在下篇文章中写）</li>
  <li>完善发送文件功能（在下篇文章中写）</li>
</ul>

<h2 id="webwxapp与wechaty的大概框架结构">WebWxApp与wechaty的大概框架结构</h2>

<h3 id="webwxapp">WebWxApp</h3>

<p>WebWxApp是基于angular开发，使用webpack打包的前端项目，可在Chatie的<code class="language-plaintext highlighter-rouge">webwx-app-tracker</code>项目查看其<a href="https://github.com/wechaty/webwx-app-tracker/blob/master/formatted/webwxApp.js">格式化过的代码</a>。</p>

<p>WebWxApp内定义了一些功能模块，下面列举一些涉及主要功能的:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">loginController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">contentChatController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">contentContactController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">chatSenderController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">emojiController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">createChatroomController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Controllers</span><span class="dl">"</span><span class="p">).</span><span class="nf">controller</span><span class="p">(</span><span class="dl">"</span><span class="s2">transpondDialogController</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">appFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">chatFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">chatroomFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">accountFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">confFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">contactFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">loginFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">utilFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">emojiFactory</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
<span class="nx">angular</span><span class="p">.</span><span class="nf">module</span><span class="p">(</span><span class="dl">"</span><span class="s2">Services</span><span class="dl">"</span><span class="p">).</span><span class="nf">factory</span><span class="p">(</span><span class="dl">"</span><span class="s2">mmHttp</span><span class="dl">"</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></div>

<p>我对angular并没有什么研究，有兴趣的朋友可以自行阅读相关源码。</p>

<p>在wechaty中，我们要实现、完善一些功能，需要参考webwxapp中相关代码的逻辑结构和流程。</p>

<p>需要说明的是，webwxapp中并没有对所有事件、信息进行同样的处理，某些特性是wechaty默认捕捉不到的。比如<code class="language-plaintext highlighter-rouge">撤回信息的 RECALLED类型信息</code>，因此我们就必须要阅读webwxapp的源码，梳理其代码流程，来找到切入点解决问题。</p>

<h3 id="wechaty">wechaty</h3>

<p>wechaty设计进行分层、抽象化封装。</p>

<ul>
  <li>如将联系人Contact、信息Message、群Room、好友请求friend-request 按功能进行封装，提取主要数据并通过方法及<code class="language-plaintext highlighter-rouge">obj</code>属性对外暴露，以供访问使用。（可查看Contact、Message、Room这三个类中定义的rawObj及obj属性。前者为原始数据结构，后者为封装提取后的数据）</li>
  <li>另外实现了Puppet类接口，作为实现操纵微信的通道。目前仅有puppet-web，基于webWxApp操作微信的实现。而未来，我们会尝试实现基于微信PC版的puppet，甚至是ipad版的puppet，那样会比Web版微信能做的更多。</li>
</ul>

<h4 id="puppet功能">puppet功能</h4>

<p>这里以puppet-web来简单说明一下，puppet的功能。</p>

<p>简单来说，puppet-web通过浏览器驱动(<code class="language-plaintext highlighter-rouge">selenium-webdriver</code>、<code class="language-plaintext highlighter-rouge">puppeteer</code>)创建一个浏览器环境（下称web环境）来加载WebWxApp(<code class="language-plaintext highlighter-rouge">wx.qq.com</code>)，并通过浏览器驱动将代码注入进web环境。
注入web环境的代码（以下称wechatyBro）会通过websocket来连接wechaty创建的websocket服务端，这样就可以在WebWxApp与wechaty之间进行通讯了。由于websocket协议是异步请求，因此对webWxApp的操作仍需要使用浏览器驱动将代码注入web环境执行的方式，来确保对webWxApp操作的同步性。</p>

<p><em>关于浏览器驱动：</em> puppet-web先后使用过<code class="language-plaintext highlighter-rouge">selenium-webdriver</code>和<code class="language-plaintext highlighter-rouge">puppeteer</code>，最新版本中使用的是<code class="language-plaintext highlighter-rouge">puppeteer</code>。</p>

<hr />

<h5 id="puppet-web的模块化">puppet-web的模块化</h5>

<p>puppet-web中对将功能拆分为不同模块：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">puppet-web</code> puppet-web的主体部分，初始化并调度其他模块的操作，实现上传文件功能。</li>
  <li><code class="language-plaintext highlighter-rouge">bridge</code> 封装需要注入web环境的代码，为<code class="language-plaintext highlighter-rouge">puppet-web</code>提供各项功能操作的方法。如<code class="language-plaintext highlighter-rouge">send()</code>方法</li>
  <li><code class="language-plaintext highlighter-rouge">browser</code> 封装对浏览器驱动的操作。如<code class="language-plaintext highlighter-rouge">bridge</code>需要通过<code class="language-plaintext highlighter-rouge">browser</code>封装的<code class="language-plaintext highlighter-rouge">execute</code>方法将js代码注入到web环境执行。</li>
  <li><code class="language-plaintext highlighter-rouge">firer</code> 封装一些信息解析、事件检查工作。</li>
  <li><code class="language-plaintext highlighter-rouge">friend-request</code> 封装好友请求操作。</li>
  <li><code class="language-plaintext highlighter-rouge">server</code> 封装了websocket服务端操作，并继承EventEmitter，将websocket接收到的信息以event方式广播。</li>
  <li><code class="language-plaintext highlighter-rouge">event</code> 封装了对server事件的监听处理。</li>
  <li><code class="language-plaintext highlighter-rouge">watchdog</code></li>
  <li><code class="language-plaintext highlighter-rouge">wechatyBro</code> 注入web环境运行的代码，实现对webWxApp的各种操作。</li>
</ul>

<p>wechatyBro中监听webWxApp中的信息事件，然后通过websocket把事件信息发送给puppet-web。而wechaty通过puppet-web操纵webWxApp。由于websocket不能同步返回处理结果，因此需要通过浏览器驱动将js代码注入进web环境执行（调用wechatyBro中的方法来操作webWxApp），并返回Promise将操作同步化。(可见<code class="language-plaintext highlighter-rouge">/src/puppet-web/bridge.ts</code>中<code class="language-plaintext highlighter-rouge">proxyWechaty()</code>)</p>

<p><strong>例如：</strong>
wechaty中发送一条信息，会按以下顺序执行：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//伪代码，标记调用过程</span>
<span class="nx">Message</span><span class="p">.</span><span class="nf">say</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">puppetInstance</span><span class="p">.</span><span class="nf">send</span><span class="p">()</span> <span class="c1">// 调用puppet的send()方法</span>

<span class="nx">PuppetWeb</span><span class="p">.</span><span class="nf">send</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">bridge</span><span class="p">.</span><span class="nf">send</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">bridge</span><span class="p">.</span><span class="nf">proxyWechaty</span><span class="p">()</span>
<span class="c1">// proxyWechaty() 中会封装代码，调用wechatyBro中对应的方法，以操作webWxApp</span>
<span class="c1">// 可见`/src/puppet-web/bridge.ts`中`proxyWechaty()`</span>

<span class="nx">bridge</span><span class="p">.</span><span class="nf">proxyWechaty</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">bridge</span><span class="p">.</span><span class="nf">execute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nx">browser</span><span class="p">.</span><span class="nf">execute</span><span class="p">()</span>
<span class="o">-&gt;</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">executeScript</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">driver</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
<span class="c1">// 最终调用浏览器驱动的`executeScript`或`executeAsyncScript`方法</span>
<span class="c1">// 将js代码注入web环境执行，并Promise以返回执行结果</span>
</code></pre></div></div>

<h5 id="puppet-web功能简述">puppet-web功能简述</h5>

<ol>
  <li>puppet-web创建一个websocket服务端用来接收wechatyBro的通信</li>
  <li>puppet-web通过浏览器驱动将wechatyBro的js代码注入进入web环境执行。</li>
  <li>WechatyBro进行初始化工作：连接puppet-web的websocket服务端，监听webWxApp的事件并进行处理后通过websocket发送给puppet-web。</li>
  <li>wechaty通过puppet-web执行各项功能时（如发送信息、创建群、拉人、踢人等主动操作），puppet-web会通过浏览器驱动将代码注入进web环境执行，以Promise返回执行结果</li>
</ol>

<p>以上对wechaty进行一个大概的了解，下边来以几个pr的实现来进一步了解wechaty。</p>

<h5 id="puttet-web操作webwxapp的关键点">puttet-web操作webWxApp的关键点</h5>

<p>WebWxApp内部实现了一些功能模块，来封装不同的功能代码。
在<code class="language-plaintext highlighter-rouge">wechaty-bro</code>的<code class="language-plaintext highlighter-rouge">glueToAngular()</code>方法中，通过使用<code class="language-plaintext highlighter-rouge">angular.element(document).injector().get(name)</code>来获取不同的功能模块并保存在<code class="language-plaintext highlighter-rouge">WechatyBro.glue</code>中，使在<code class="language-plaintext highlighter-rouge">WechatyBro</code>中可以调用<code class="language-plaintext highlighter-rouge">WebWxApp</code>的功能代码，来实现不同的功能。</p>

<p><code class="language-plaintext highlighter-rouge">WechatyBro</code>初始化时会调用<code class="language-plaintext highlighter-rouge">hookEvents()</code>来监听<code class="language-plaintext highlighter-rouge">WebWxapp</code>的事件，如页面初始化<code class="language-plaintext highlighter-rouge">root:pageInit:success</code>、新信息<code class="language-plaintext highlighter-rouge">message:add:success</code>，并通过websocket将信息发送到<code class="language-plaintext highlighter-rouge">puppet-web</code>。</p>

<p>而<code class="language-plaintext highlighter-rouge">wechatyBro</code>中封装了一些操作，需要puppet-web通过浏览器驱动将代码注入web环境来调用，并返回其运行结果，浏览器驱动会将运行结果以Promise返回隔天puppet-web。</p>

<p>webwxApp中的工厂<code class="language-plaintext highlighter-rouge">factory</code>有很多，WechatyBro获取了一些需要用到的保存在内部，以便调用：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//此部分代码从 WechatyBro 中摘出</span>
<span class="kd">var</span> <span class="nx">injector</span>  <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nf">element</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nf">injector</span><span class="p">()</span>

<span class="kd">var</span> <span class="nx">accountFactory</span>  <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">accountFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">appFactory</span>      <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">appFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">chatroomFactory</span> <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">chatroomFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">chatFactory</span>     <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">chatFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">contactFactory</span>  <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">contactFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">confFactory</span>     <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">confFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">emojiFactory</span>    <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">emojiFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">loginFactory</span>    <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">loginFactory</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">utilFactory</span>     <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">utilFactory</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">http</span>            <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">$http</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">state</span>           <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">$state</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">mmHttp</span>          <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">mmHttp</span><span class="dl">'</span><span class="p">)</span>

<span class="c1">// 保存到WechatyBro.glue</span>
<span class="nx">WechatyBro</span><span class="p">.</span><span class="nx">glue</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">injector</span><span class="p">:</span>       <span class="nx">injector</span>
  <span class="p">,</span> <span class="na">http</span><span class="p">:</span>         <span class="nx">http</span>
  <span class="p">,</span> <span class="na">mmHttp</span><span class="p">:</span>       <span class="nx">mmHttp</span>
  <span class="p">,</span> <span class="na">state</span><span class="p">:</span>        <span class="nx">state</span>
  <span class="p">,</span> <span class="na">accountFactory</span><span class="p">:</span>  <span class="nx">accountFactory</span>
  <span class="p">,</span> <span class="na">chatroomFactory</span><span class="p">:</span> <span class="nx">chatroomFactory</span>
  <span class="p">,</span> <span class="na">chatFactory</span><span class="p">:</span>     <span class="nx">chatFactory</span>
  <span class="p">,</span> <span class="na">confFactory</span><span class="p">:</span>     <span class="nx">confFactory</span>
  <span class="p">,</span> <span class="na">contactFactory</span><span class="p">:</span>  <span class="nx">contactFactory</span>
  <span class="p">,</span> <span class="na">emojiFactory</span><span class="p">:</span>    <span class="nx">emojiFactory</span>
  <span class="p">,</span> <span class="na">loginFactory</span><span class="p">:</span>    <span class="nx">loginFactory</span>
  <span class="p">,</span> <span class="na">utilFactory</span><span class="p">:</span>     <span class="nx">utilFactory</span>
  <span class="p">,</span> <span class="na">rootScope</span><span class="p">:</span>    <span class="nx">rootScope</span>
  <span class="p">,</span> <span class="na">appScope</span><span class="p">:</span>     <span class="nx">appScope</span>
  <span class="p">,</span> <span class="na">loginScope</span><span class="p">:</span>   <span class="nx">loginScope</span>
  <span class="p">,</span> <span class="na">contentChatScope</span><span class="p">:</span> <span class="nx">contentChatScope</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="捕捉撤消信息事件">捕捉撤消信息事件</h3>

<p>以前wechaty是捕捉不到撤回消息的RECALLED事件的（最早见<a href="https://github.com/wechaty/wechaty/issues/8">issues#8</a>），原因在于webWxApp的<code class="language-plaintext highlighter-rouge">messageProcess</code>中，对RECALLED事件的处理与其他类型的信息事件不一致。</p>

<p>我们看下webWxApp中处理消息的<code class="language-plaintext highlighter-rouge">messageProcess()</code>方法代码：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">messageProcess</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">contactFactory</span><span class="p">.</span><span class="nf">getContact</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">FromUserName</span><span class="p">,</span> <span class="dl">""</span><span class="p">,</span> <span class="o">!</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">a</span> <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nf">isMuted</span><span class="p">()</span> <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nf">isSelf</span><span class="p">()</span> <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nf">isShieldUser</span><span class="p">()</span> <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nf">isBrandContact</span><span class="p">()</span> <span class="o">||</span> <span class="nx">titleRemind</span><span class="p">.</span><span class="nf">increaseUnreadMsgNum</span><span class="p">(),</span> <span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_getMessagePeerUserName</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span> <span class="nx">e</span><span class="p">.</span><span class="nx">MsgType</span> <span class="o">==</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_STATUSNOTIFY</span><span class="p">)</span> <span class="k">return</span> <span class="k">void</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_statusNotifyProcessor</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MsgType</span> <span class="o">!=</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_SYSNOTICE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">utilFactory</span><span class="p">.</span><span class="nf">isShieldUser</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">FromUserName</span><span class="p">)</span> <span class="o">||</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">isShieldUser</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ToUserName</span><span class="p">)</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">MsgType</span> <span class="o">==</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VERIFYMSG</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">RecommendInfo</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">RecommendInfo</span><span class="p">.</span><span class="nx">UserName</span> <span class="o">==</span> <span class="nx">accountFactory</span><span class="p">.</span><span class="nf">getUserInfo</span><span class="p">().</span><span class="nx">UserName</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">switch </span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">_commonMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span> <span class="nx">e</span><span class="p">.</span><span class="nx">MsgType</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_APP</span><span class="p">:</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">MMIsAppMsg</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_appMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_EMOTICON</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_emojiMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_IMAGE</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_imageMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VOICE</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_voiceMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VIDEO</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_videoMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_MICROVIDEO</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_mircovideoMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_TEXT</span><span class="p">:</span>
        <span class="dl">"</span><span class="s2">newsapp</span><span class="dl">"</span> <span class="o">==</span> <span class="nx">e</span><span class="p">.</span><span class="nx">FromUserName</span> <span class="p">?</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_newsMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">AppMsgType</span> <span class="o">==</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">APPMSGTYPE_RED_ENVELOPES</span> <span class="p">?</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MsgType</span> <span class="o">=</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_APP</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_appMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">SubMsgType</span> <span class="o">==</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_LOCATION</span> <span class="p">?</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_locationMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_textMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_RECALLED</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">void</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_recalledMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> <span class="c1">//注意这里是return</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_LOCATION</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_locationMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VOIPMSG</span><span class="p">:</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VOIPNOTIFY</span><span class="p">:</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VOIPINVITE</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_voipMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_POSSIBLEFRIEND_MSG</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_recommendMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_VERIFYMSG</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_verifyMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_SHARECARD</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_shareCardProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_SYS</span><span class="p">:</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">_systemMsgProcess</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="nl">default</span><span class="p">:</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">MMDigest</span> <span class="o">=</span> <span class="nf">_</span><span class="p">(</span><span class="dl">"</span><span class="s2">938b111</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">MMActualContent</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">hrefEncode</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMActualContent</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">contactFactory</span><span class="p">.</span><span class="nf">getContact</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">MMIsSend</span> <span class="o">||</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nf">isMuted</span><span class="p">()</span> <span class="o">||</span> <span class="nx">n</span><span class="p">.</span><span class="nf">isBrandContact</span><span class="p">())</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">MsgType</span> <span class="o">==</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_SYS</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">accountFactory</span><span class="p">.</span><span class="nf">isNotifyOpen</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nf">_notify</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span> <span class="nx">accountFactory</span><span class="p">.</span><span class="nf">isSoundOpen</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">initMsgNoticePlayer</span><span class="p">(</span><span class="nx">confFactory</span><span class="p">.</span><span class="nx">RES_SOUND_RECEIVE_MSG</span><span class="p">)),</span>
      <span class="nx">t</span><span class="p">.</span><span class="nf">addChatMessage</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span>
      <span class="nx">t</span><span class="p">.</span><span class="nf">addChatList</span><span class="p">([</span><span class="nx">e</span><span class="p">])</span>
  <span class="p">}</span>
<span class="p">},</span>
</code></pre></div></div>

<p>注意代码中处理<code class="language-plaintext highlighter-rouge">confFactory.MSGTYPE_RECALLED</code>类型信息的方式，是使用了<code class="language-plaintext highlighter-rouge">return</code>的，不会再执行下边的<code class="language-plaintext highlighter-rouge">t.addChatMessage(e)</code>。</p>

<p>我们看下webWxApp中 <code class="language-plaintext highlighter-rouge">addChatMessage()</code>的代码：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addChatMessage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">FromUserName</span><span class="p">,</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">ToUserName</span><span class="p">,</span>
        <span class="nx">_chatMessages</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">_chatMessages</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]));</span>
    <span class="nx">_addedMsgIdsMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">MsgId</span><span class="p">]</span> <span class="o">||</span>
      <span class="p">(</span><span class="nx">_addedMsgIdsMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">MsgId</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
        <span class="nx">_msgMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">MsgId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">e</span><span class="p">,</span>
        <span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span>
        <span class="nx">$rootScope</span><span class="p">.</span><span class="nf">$broadcast</span><span class="p">(</span><span class="dl">"</span><span class="s2">message:add:success</span><span class="dl">"</span><span class="p">,</span> <span class="nx">e</span><span class="p">),</span>
        <span class="nx">t</span><span class="p">.</span><span class="nf">getChatList</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">},</span>
</code></pre></div></div>

<p>wechatyBro中监听webWxApp事件的代码如下：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">rootScope</span><span class="p">.</span><span class="nf">$on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message:add:success</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nf">isLogin</span><span class="p">())</span> <span class="p">{</span> <span class="c1">// in case of we missed the pageInit event</span>
    <span class="nf">login</span><span class="p">(</span><span class="dl">'</span><span class="s1">by event[message:add:success]</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">WechatyBro</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">addChatMessage()</code>中使用<code class="language-plaintext highlighter-rouge">$rootScope.$broadcast("message:add:success", e)</code>来广播信息事件，而wechatyBro通过<code class="language-plaintext highlighter-rouge">rootScope.$on('message:add:success', function(event, data) {})</code>监听信息事件，从而获得webWxApp的信息（包含系统信息事件）。</p>

<p>而由于<code class="language-plaintext highlighter-rouge">messageProcess()</code>中对<code class="language-plaintext highlighter-rouge">confFactory.MSGTYPE_RECALLED</code>类型的信息使用了<code class="language-plaintext highlighter-rouge">return</code>，因此wechatyBro捕捉不到<code class="language-plaintext highlighter-rouge">RECALLED</code>事件的信息，wechaty自然也就无法得知某条消息被撤消了。</p>

<h4 id="解决方案">解决方案</h4>

<p>既然<code class="language-plaintext highlighter-rouge">messageProcess()</code>中对<code class="language-plaintext highlighter-rouge">RECALLED</code>类型信息使用了return，但先调用了<code class="language-plaintext highlighter-rouge">t._recalledMsgProcess(e)</code>，那么我们可以使用在wechatyBro中hook <code class="language-plaintext highlighter-rouge">t._recalledMsgProcess()</code> 的方式来获得<code class="language-plaintext highlighter-rouge">RECALLED</code>类型的事件信息。</p>

<p>通过分析webWxApp代码，得知<code class="language-plaintext highlighter-rouge">_recalledMsgProcess()</code>是<code class="language-plaintext highlighter-rouge">chatFactory</code>中的方法（善用搜索）。那么我们在wechatyBro中，就要hook<code class="language-plaintext highlighter-rouge">chatFactory._recalledMsgProcess()</code>方法了。</p>

<p>在wechatyBro中，使用<code class="language-plaintext highlighter-rouge">WechatyBro.glue.chatFactory</code>来获得webWxApp的<code class="language-plaintext highlighter-rouge">chatFactory</code>。</p>

<p>我们添加以下代码：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">hookRecalledMsgProcess</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">chatFactory</span> <span class="o">=</span> <span class="nx">WechatyBro</span><span class="p">.</span><span class="nx">glue</span><span class="p">.</span><span class="nx">chatFactory</span>
  <span class="c1">// 保存webWxApp自身的处理代码副本</span>
  <span class="nx">chatFactory</span><span class="p">.</span><span class="nx">__recalledMsgProcess</span> <span class="o">=</span> <span class="nx">chatFactory</span><span class="p">.</span><span class="nx">_recalledMsgProcess</span>
  <span class="c1">// 定义一个新的处理方法替换原始处理代码</span>
  <span class="nx">chatFactory</span><span class="p">.</span><span class="nx">_recalledMsgProcess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chatFactory</span><span class="p">.</span><span class="nf">__recalledMsgProcess</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="c1">//调用原始处理代码</span>
    <span class="c1">//...下边就可以写我们的处理代码了</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// init()方法中需要添加调用 hookRecalledMsgProcess()</span>
<span class="kd">function</span> <span class="nf">init</span><span class="p">(){</span>
  <span class="c1">// ...</span>
    <span class="nf">hookEvents</span><span class="p">()</span>
    <span class="nf">hookRecalledMsgProcess</span><span class="p">()</span>  <span class="c1">//添加到hookEvents()后边</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>webwxApp中<code class="language-plaintext highlighter-rouge">_recalledMsgProcess()</code>会对撤回信息进行解析处理，我们需要分析其代码，获取被撤回的信息内容，并通过websocket发给puppet-web。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_recalledMsgProcess</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
    <span class="c1">// 解码</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">htmlDecode</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMActualContent</span><span class="p">),</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="dl">""</span><span class="p">,</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="nf">_</span><span class="p">(</span><span class="dl">"</span><span class="s2">ded861c</span><span class="dl">"</span><span class="p">),</span>
    <span class="c1">//获取指定用户的聊天信息数组</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getChatMessage</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">);</span>
    <span class="c1">//对emoji进行转码</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">encodeEmoji</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span>
  <span class="c1">//解析（可在chrome中使用调试查看微信下发的信息内容格式）</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">xml2json</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">revokemsg</span><span class="p">,</span>
    <span class="c1">//如果信息内没有标明msgid</span>
    <span class="mi">0</span> <span class="o">==</span> <span class="nx">o</span><span class="p">.</span><span class="nx">msgid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="nx">s</span><span class="p">)</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="nx">s</span><span class="p">].</span><span class="nx">FromUserName</span> <span class="o">==</span> <span class="nx">accountFactory</span><span class="p">.</span><span class="nf">getUserName</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
        <span class="k">break</span>
      <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 从用户聊天信息数组中获取指定的信息id</span>
    <span class="nx">t</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">_findMessageByMsgId</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">msgid</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">t</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="nx">t</span><span class="p">];</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">MMIsSend</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nf">_</span><span class="p">(</span><span class="dl">"</span><span class="s2">df1fd91</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">contactFactory</span><span class="p">.</span><span class="nf">getContact</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMActualSender</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">);</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">d</span> <span class="p">?</span> <span class="nx">d</span><span class="p">.</span><span class="nf">getDisplayName</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">)</span> <span class="p">:</span> <span class="dl">""</span>
    <span class="p">}</span>
    <span class="c1">//显示撤回信息提醒</span>
    <span class="nx">angular</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">MMRecall</span><span class="p">:</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">MsgType</span><span class="p">:</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_SYS</span><span class="p">,</span>
      <span class="na">MMActualContent</span><span class="p">:</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">r</span><span class="p">,</span>
      <span class="na">MMDigest</span><span class="p">:</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">r</span><span class="p">,</span>
      <span class="na">_h</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}),</span> <span class="nx">n</span><span class="p">.</span><span class="nf">getChatList</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">},</span>
</code></pre></div></div>

<p>因此我们来用以下代码进行实现：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">hookRecalledMsgProcess</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">chatFactory</span> <span class="o">=</span> <span class="nx">WechatyBro</span><span class="p">.</span><span class="nx">glue</span><span class="p">.</span><span class="nx">chatFactory</span>
  <span class="kd">var</span> <span class="nx">utilFactory</span> <span class="o">=</span> <span class="nx">WechatyBro</span><span class="p">.</span><span class="nx">glue</span><span class="p">.</span><span class="nx">utilFactory</span>
  <span class="kd">var</span> <span class="nx">confFactory</span> <span class="o">=</span> <span class="nx">WechatyBro</span><span class="p">.</span><span class="nx">glue</span><span class="p">.</span><span class="nx">confFactory</span>
  <span class="c1">// hook chatFactory._recalledMsgProcess, resolve emit RECALLED type msg</span>
  <span class="nx">chatFactory</span><span class="p">.</span><span class="nx">__recalledMsgProcess</span> <span class="o">=</span> <span class="nx">chatFactory</span><span class="p">.</span><span class="nx">_recalledMsgProcess</span>
  <span class="nx">chatFactory</span><span class="p">.</span><span class="nx">_recalledMsgProcess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chatFactory</span><span class="p">.</span><span class="nf">__recalledMsgProcess</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
    <span class="c1">//复制一个msg副本</span>
    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">assign</span><span class="p">({},</span><span class="nx">msg</span><span class="p">)</span>
    <span class="c1">//解码信息内容</span>
    <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">htmlDecode</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">MMActualContent</span><span class="p">)</span>
    <span class="nx">content</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">encodeEmoji</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
    <span class="c1">//获取撤回信息</span>
    <span class="kd">var</span> <span class="nx">revokemsg</span> <span class="o">=</span> <span class="nx">utilFactory</span><span class="p">.</span><span class="nf">xml2json</span><span class="p">(</span><span class="nx">content</span><span class="p">).</span><span class="nx">revokemsg</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">revokemsg</span><span class="p">.</span><span class="nx">msgid</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">//获取指定用户的聊天信息数组</span>
      <span class="kd">var</span> <span class="nx">chatMsgs</span> <span class="o">=</span> <span class="nx">chatFactory</span><span class="p">.</span><span class="nf">getChatMessage</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">MMPeerUserName</span><span class="p">)</span>
      <span class="c1">// 获取被撤回信息在聊天信息数组中的序号</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">chatFactory</span><span class="p">.</span><span class="nf">_findMessageByMsgId</span><span class="p">(</span><span class="nx">chatMsgs</span><span class="p">,</span> <span class="nx">revokemsg</span><span class="p">.</span><span class="nx">msgid</span><span class="p">)</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//获取被撤回的原始信息</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">chatMsgs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="c1">//标记信息类型为撤回信息</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">MsgType</span> <span class="o">=</span> <span class="nx">confFactory</span><span class="p">.</span><span class="nx">MSGTYPE_RECALLED</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//如果没有找到被撤回的原始信息，则将本次信息id修改为被撤回的原始信息id</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">MsgId</span> <span class="o">=</span> <span class="nx">revokemsg</span><span class="p">.</span><span class="nx">msgid</span>
        <span class="c1">// 修改信息内容</span>
        <span class="nx">m</span><span class="p">.</span><span class="nx">MMActualContent</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Content</span> <span class="o">=</span> <span class="nx">revokemsg</span><span class="p">.</span><span class="nx">replacemsg</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/"/g</span><span class="p">,</span><span class="dl">""</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">//调用emit()将信息通过websocket发送给puppet-web</span>
      <span class="nx">WechatyBro</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 由于webWxApp的_recalledMsgProcess() 中使用到了 utilFactory，而wechatyBro并没有获取 utilFactory ，因此我们需要加上</span>
<span class="kd">function</span> <span class="nf">glueToAngular</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="kd">var</span> <span class="nx">loginFactory</span>    <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">loginFactory</span><span class="dl">'</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">utilFactory</span>     <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">utilFactory</span><span class="dl">'</span><span class="p">)</span>
  <span class="c1">//...</span>

  <span class="nx">WechatyBro</span><span class="p">.</span><span class="nx">glue</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">//...</span>
    <span class="p">,</span> <span class="na">loginFactory</span><span class="p">:</span>    <span class="nx">loginFactory</span>
    <span class="p">,</span> <span class="na">utilFactory</span><span class="p">:</span>     <span class="nx">utilFactory</span>
    <span class="c1">//...</span>
  <span class="p">}</span>
  <span class="c1">//...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>完整patch代码见<a href="https://github.com/wechaty/wechaty/commit/174b6775c4e9242e5f003094b2f9e10953c978f2">PR commit#174b6775c</a></p>

<h2 id="end">End</h2>

<p>感谢<a href="https://github.com/huan">zixia</a>的邀请，很抱歉拖了这么久才写了这篇文章。
感谢Chatie的各位贡献者，有大家的共同努力，wechaty才会愈发的好用。
也感谢耐心看完文章的你，希望我的文章没有浪费你的时间。
谢谢！</p>


			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#code">code</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#featured">featured</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/binsee">
                            <img class="rounded-circle" src="/assets/contributors/binsee/avatar.webp" alt="Binsee" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by Binsee </h5>
						野路子的修炼者
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2017/11/08/red-pocket-wechaty-iyjian/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2017/11-red-pocket-wechaty-iyjian-en/iyjian-1.webp">  我用wechaty做了一个积分红包机器人</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2017/11/26/wechaty-electron-making-your-wechaty-as-a-client-service-en/"> wechaty-electron: Making Your Wechaty a Client Service  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2017/11-wechaty-electron-making-your-wechaty-as-a-client-service-en/wechaty-electron-making-your-wachaty-as-a-client-service1.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright © <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
