<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å° | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å° | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°" />
<meta name="author" content="zhoumh1988" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="æ„Ÿè°¢ @lijiarui é‚€è¯·æˆ‘åˆ†äº«æˆ‘ä»¬çš„LIGHTBOTç»Ÿè®¡åˆ†æç®¡ç†å¹³å°ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…ä½¿ç”¨wechatyæä¾›æ›´å¤šçš„ä¸šåŠ¡æ–¹å‘ã€‚" />
<meta property="og:description" content="æ„Ÿè°¢ @lijiarui é‚€è¯·æˆ‘åˆ†äº«æˆ‘ä»¬çš„LIGHTBOTç»Ÿè®¡åˆ†æç®¡ç†å¹³å°ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…ä½¿ç”¨wechatyæä¾›æ›´å¤šçš„ä¸šåŠ¡æ–¹å‘ã€‚" />
<link rel="canonical" href="https://wechaty.js.org/2018/08/14/wechaty-lightbot-analytics/" />
<meta property="og:url" content="https://wechaty.js.org/2018/08/14/wechaty-lightbot-analytics/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2018/wechaty-lightbot-logo.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-14T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2018/wechaty-lightbot-logo.webp" />
<meta property="twitter:title" content="Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"zhoumh1988"},"dateModified":"2018-08-14T00:00:00+00:00","datePublished":"2018-08-14T00:00:00+00:00","description":"æ„Ÿè°¢ @lijiarui é‚€è¯·æˆ‘åˆ†äº«æˆ‘ä»¬çš„LIGHTBOTç»Ÿè®¡åˆ†æç®¡ç†å¹³å°ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…ä½¿ç”¨wechatyæä¾›æ›´å¤šçš„ä¸šåŠ¡æ–¹å‘ã€‚","headline":"Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°","image":"https://wechaty.js.org/assets/2018/wechaty-lightbot-logo.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2018/08/14/wechaty-lightbot-analytics/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"zhoumh1988"},"url":"https://wechaty.js.org/2018/08/14/wechaty-lightbot-analytics/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

    




</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://ship.fail" target="_blank">Ship.Fail</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://preangel.ai" target="_blank">PreAngel.AI</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#project">project</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/zhoumh1988">
                            <img class="rounded-circle" src="/assets/contributors/zhoumh1988/avatar.webp" alt="LittleStrong" width="70"/>
                          </a>
                        
						<small class="ml-3"> <a href="/contributors/zhoumh1988">LittleStrong</a> <span><a target="_blank" href="" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Aug 14, 2018 Â· <span class="reading-time">
  
  
    9 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2018/wechaty-lightbot-logo.webp" alt="Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <img id="qrcode" title="Wechat"
          src="/assets/contributors/wechaty/icon.png"
          width="64" height="64"
        />
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p>æ„Ÿè°¢ @lijiarui é‚€è¯·æˆ‘åˆ†äº«æˆ‘ä»¬çš„LIGHTBOTç»Ÿè®¡åˆ†æç®¡ç†å¹³å°ï¼Œå¸Œæœ›èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…ä½¿ç”¨wechatyæä¾›æ›´å¤šçš„ä¸šåŠ¡æ–¹å‘ã€‚</p>

<p>æœ¬äººåˆšå¼€å§‹å­¦ä¹ ä½¿ç”¨nodeï¼Œå› æ­¤ä»£ç ç›¸å¯¹æ¯”è¾ƒlowï¼Œè¿˜è¯·è§è°…ã€‚ğŸ˜„</p>

<h2 id="é¡¹ç›®ä»‹ç»">é¡¹ç›®ä»‹ç»</h2>

<blockquote>
  <p>Lightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°åœ¨å…‰é“¾é¡¹ç›®å¾®ä¿¡ç¾¤ä¸­å°†ä¸»è¦èµ·åˆ°ä¸¤æ–¹é¢çš„ä½œç”¨ï¼Œåˆ†åˆ«æ˜¯<strong>ç»´æŠ¤ç®¡ç†</strong>å’Œ<strong>æ•°æ®æŠ“å–</strong>ä¸¤æ–¹é¢ã€‚æœºå™¨äººå°†åšåˆ°å†…å®¹çš„ç®€å•å›å¤ï¼ŒåŒ…æ‹¬å¥½å‹è‡ªåŠ¨é€šè¿‡ï¼Œå›å¤å…³é”®è¯è‡ªåŠ¨é‚€è¯·åŠ å…¥ç¾¤ç»„ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½å°†ä¿è¯æŠ•èµ„äººå…¥ç¾¤ç”³è¯·èƒ½å¤ŸåŠæ—¶é€šè¿‡ã€‚åœ¨æ—¥å¸¸çš„ç¾¤ç»´æŠ¤ä¸Šï¼Œæœºå™¨äººå°†åšåˆ°è®°å½•ç”¨æˆ·è¿è§„å›å¤ï¼Œè¶…è¿‡3æ¬¡è­¦å‘Šå¹¶åˆ é™¤ï¼ŒåŒæ—¶ï¼Œè¿›è¡Œéå·¥ä½œæ—¶é—´å¸¸è§„é—®é¢˜å…³é”®è¯çš„è‡ªåŠ¨å›å¤ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½å°†åšåˆ°ç¾¤ç»´æŠ¤çš„24å°æ—¶æ— é—´æ–­æ‰§è¡Œã€‚åŒæ—¶ä¹Ÿæ¶‰åŠåˆ°å…³é”®è¯ç®¡ç†ï¼ŒåŒ…æ‹¬å¸¸è§„å…³é”®è¯å’Œè¿è§„å…³é”®è¯ï¼Œå…³é”®è¯å°†ç”±ç®¡ç†å‘˜åœ¨åå°è¿›è¡Œè®¾å®šï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿæ ¹æ®ç¾¤èŠç¯å¢ƒå’Œé¡¹ç›®è¿›å±•è¿›è¡ŒåŠæ—¶è°ƒæ•´ã€‚åœ¨è¿è§„ç”¨æˆ·æ–¹é¢ï¼Œåå°ä¹Ÿå°†è¿›è¡Œè®°å½•ï¼Œæ–¹é¢ç®¡ç†å‘˜è¿›è¡Œæé†’å’Œå¤„ç†ã€‚
åœ¨æ•°æ®å’Œäººå‘˜ç®¡ç†æ–¹é¢ï¼ŒLightbotç»Ÿè®¡åˆ†æç®¡ç†å¹³å°å°†æ ¹æ®å›å¤è®¡ç®—ç»Ÿè®¡ç¾¤æˆå‘˜ï¼ŒåŒ…æ‹¬ç”¨æˆ·å’Œç®¡ç†å‘˜çš„çš„æ€»ä½“æ—¥æ´»ï¼Œå‘¨æ´»å’Œæœˆæ´»ï¼Œæ–¹ä¾¿ç¾¤å†…åšå¥½æ­£å¯¹æ€§è¿è¥å’Œç®¡ç†ã€‚åœ¨æ–‡å­—æ–¹é¢ï¼Œä¹Ÿå°†åšå¥½ç»Ÿè®¡ï¼Œå…·ä½“ä½“ç°åœ¨å­—æ•°ä¸Šï¼Œè¿™ä¸€ç‚¹ä¹Ÿå°†å¯¹ç¾¤èŠè´¨é‡è¿›è¡ŒæŠŠæ§ã€‚åœ¨ç”¨æˆ·åˆ†æä¸Šï¼Œåå°æ•°æ®å°†ååŠ©è¿›è¡Œç”¨æˆ·ç”»åƒçš„å½’çº³ï¼ŒåŒ…æ‹¬æ€§åˆ«ï¼Œåœ°åŸŸç­‰ï¼Œåœ¨ç¾¤èŠä¹ æƒ¯æ–¹é¢ï¼Œä¹Ÿå°†æ±‡æ€»å›å¤æ—¶é—´ç­‰ï¼Œæ–¹ä¾¿ç®¡ç†å‘˜è¿›è¡Œæ›´æœ‰é’ˆå¯¹æ€§çš„ç¾¤èŠå›å¤ã€‚åœ¨æœºå™¨äººçš„åå°ï¼Œå¯ä»¥æŸ¥å¤šä¸ªå¾®ä¿¡ç¾¤çš„å…·ä½“çš„èŠå¤©è®°å½•ï¼ŒåŒæ—¶æä¾›è§’è‰²è®¾ç½®åŠŸèƒ½ï¼Œè§’è‰²åŒ…æ‹¬ç”¨æˆ·ã€ç®¡ç†å‘˜ã€æ°´å†›ç­‰ï¼Œè¿™ä¸¤ä¸ªåŠŸèƒ½å°†ä½¿ç®¡ç†å‘˜åœ¨åå°æŸ¥çœ‹å…·ä½“è‡³æ¯ä¸ªç¾¤æ¯ä¸ªè§’è‰²çš„å…·ä½“èŠå¤©å†…å®¹ï¼Œåœ¨ç»Ÿè®¡æ•°æ®çš„åŒæ—¶å°†å®Œæ•´çš„èŠå¤©è®°å½•åŒæ—¶æŠ“å–ã€‚</p>
</blockquote>

<p>æ•´ä¸ªé¡¹ç›®åˆ†ä¸º4å¤§æ¨¡å—ï¼š</p>

<ul>
  <li>lightbotæœºå™¨äººï¼ˆå·²å®Œæˆï¼‰</li>
  <li>apiæ¥å£æœåŠ¡ï¼ˆå·²å®Œæˆ50%ï¼‰</li>
  <li>webç«¯å±•ç¤ºç•Œé¢ï¼ˆå·²å®Œæˆ50%ï¼‰</li>
  <li>cronå®šæ—¶ä»»åŠ¡ï¼ˆå¼€å‘ä¸­ï¼‰</li>
</ul>

<h2 id="lightbotåŠŸèƒ½">LightbotåŠŸèƒ½</h2>

<h3 id="è‡ªåŠ¨æŠ“å–ç¾¤ä¿¡æ¯">è‡ªåŠ¨æŠ“å–ç¾¤ä¿¡æ¯</h3>

<blockquote>
  <p>é€šè¿‡éå†ç”¨æˆ·å›ºå®šçš„ç¾¤ç»„ï¼ŒæŠ“å–ç¾¤ä¿¡æ¯å’Œç¾¤æˆå‘˜ä¿¡æ¯ã€‚å¹¶è‡ªåŠ¨æŠ“å–ç”¨æˆ·çš„æ–‡æœ¬å’Œå›¾ç‰‡ç•™è¨€ã€‚</p>

  <p>æˆ‘ä»¬åœ¨å¾®ä¿¡æœºå™¨äººç™»å½•çš„åŒæ—¶éå†è¦æŠ“å–çš„ç¾¤ç»„ï¼ŒæŠ“å–æˆåŠŸååšæ’å…¥æˆ–æ›´æ–°æ“ä½œï¼Œä¹‹åæŠ“å–ç¾¤æˆå‘˜ä¿¡æ¯ï¼ŒåŒæ ·åœ¨æŠ“å–æˆåŠŸååšæ’å…¥æˆ–æ›´æ–°æ“ä½œã€‚
ç¼“å­˜ç”¨æˆ·ä¿¡æ¯çš„ç›®çš„æ˜¯ä¸ºäº†åæœŸåšç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡ï¼ŒåŒæ—¶è¿˜å¯é’ˆå¯¹æ€§ç­›é€‰ç”¨æˆ·è¿›è¡Œå¯¹è¯æ¨¡å¼å±•ç¤ºã€‚</p>
</blockquote>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Wechaty</span><span class="p">({</span> <span class="na">puppet</span><span class="p">:</span> <span class="dl">'</span><span class="s1">padchat</span><span class="dl">'</span> <span class="p">})</span>
<span class="kd">const</span> <span class="nx">default_rooms</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">Test1</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Test2</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Test3</span><span class="dl">'</span><span class="p">];</span>

<span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">default_rooms</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="k">async</span> <span class="nx">topic</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Room</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span>
            <span class="na">topic</span><span class="p">:</span> <span class="nx">topic</span>
        <span class="p">});</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`The room </span><span class="p">${</span><span class="nx">topic</span><span class="p">}</span><span class="s2"> is </span><span class="p">${</span><span class="nf">isNotEmpty</span><span class="p">(</span><span class="nx">r</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">saveRoom</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<h4 id="ä»£ç ">ä»£ç </h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¿å­˜ç¾¤ç»„ä¿¡æ¯</span>
<span class="kd">const</span> <span class="nx">saveRoom</span> <span class="o">=</span> <span class="k">async</span> <span class="nf">function </span><span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">record</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">topic</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">topic</span><span class="p">();</span>
    <span class="kd">let</span> <span class="nx">members</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">memberList</span><span class="p">();</span>
    <span class="nx">record</span><span class="p">.</span><span class="nx">member_num</span> <span class="o">=</span> <span class="nx">members</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">Query</span><span class="p">.</span><span class="nf">saveRoom</span><span class="p">(</span><span class="nx">record</span><span class="p">);</span>
    <span class="nx">members</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="k">async</span> <span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">c</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">c</span><span class="p">.</span><span class="nf">self</span><span class="p">())</span> <span class="p">{</span>
            <span class="nf">saveUser</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// ä¿å­˜ç”¨æˆ·ä¿¡æ¯</span>
<span class="kd">const</span> <span class="nx">saveUser</span> <span class="o">=</span> <span class="k">async</span> <span class="nf">function </span><span class="p">(</span><span class="nx">contact</span><span class="p">,</span> <span class="nx">roomid</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Query</span><span class="p">.</span><span class="nf">isExisted</span><span class="p">(</span><span class="nx">contact</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">roomid</span><span class="p">,</span> <span class="k">async</span> <span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">res</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">roomid</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="p">(</span><span class="nx">contact</span><span class="p">);</span>
                <span class="nx">user</span><span class="p">.</span><span class="nf">setRoomid</span><span class="p">(</span><span class="nx">roomid</span><span class="p">);</span>
                <span class="nx">user</span><span class="p">.</span><span class="nf">setGender</span><span class="p">(</span><span class="nx">contact</span><span class="p">.</span><span class="nf">gender</span><span class="p">());</span>
                <span class="k">if </span><span class="p">(</span><span class="nf">isNotEmpty</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">user</span><span class="p">.</span><span class="nf">setId</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                    <span class="k">if </span><span class="p">(</span><span class="nf">isEmpty</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">''</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">Query</span><span class="p">.</span><span class="nf">syncContactName</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
                            <span class="nx">info</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">`åŒæ­¥ç”¨æˆ·</span><span class="p">${</span><span class="nx">contact</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2">æ˜µç§°`</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">}</span>
                    <span class="k">if </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">avatar</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">res</span><span class="p">.</span><span class="nx">avatar</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">let</span> <span class="nx">avatar</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">avatar</span><span class="p">();</span>
                        <span class="nx">avatar</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">avatar</span><span class="p">.</span><span class="nf">toDataURL</span><span class="p">();</span>
                        <span class="nx">Query</span><span class="p">.</span><span class="nf">insertImage</span><span class="p">(</span><span class="nx">avatar</span><span class="p">,</span> <span class="nx">imgId</span> <span class="o">=&gt;</span> <span class="p">{</span>
                            <span class="nx">user</span><span class="p">.</span><span class="nf">setAvatar</span><span class="p">(</span><span class="nx">imgId</span><span class="p">);</span>
                            <span class="nx">Query</span><span class="p">.</span><span class="nf">syncContactAvatar</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="nx">info</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">`åŒæ­¥ç”¨æˆ·</span><span class="p">${</span><span class="nx">contact</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2">å¤´åƒ`</span><span class="p">);</span>
                            <span class="p">});</span>
                        <span class="p">})</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nx">avatar</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">avatar</span><span class="p">();</span>
                    <span class="nx">avatar</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">avatar</span><span class="p">.</span><span class="nf">toDataURL</span><span class="p">();</span>
                    <span class="nx">Query</span><span class="p">.</span><span class="nf">insertImage</span><span class="p">(</span><span class="nx">avatar</span><span class="p">,</span> <span class="nx">imgId</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="nx">user</span><span class="p">.</span><span class="nf">setAvatar</span><span class="p">(</span><span class="nx">imgId</span><span class="p">);</span>
                        <span class="nx">Query</span><span class="p">.</span><span class="nf">addUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
                            <span class="nx">info</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">`æ–°å¢ç”¨æˆ·</span><span class="p">${</span><span class="nx">contact</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2">ä¿¡æ¯`</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">})</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">err</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>å…¶ä¸­Queryæ˜¯æˆ‘å†™çš„ä¸€ä¸ªæ•°æ®åº“å­˜å‚¨çš„å·¥å…·ç±»</p>

  <p>ç”¨æˆ·å¤´åƒæˆ‘æ˜¯ç”¨base64è½¬ç å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œå› æ­¤æˆ‘ä¼šå…ˆä¿å­˜ç”¨æˆ·å¤´åƒï¼Œç„¶åå…³è”åˆ°ç”¨æˆ·è¡¨ä¸­ï¼Œæ•´ä¸ªé¡¹ç›®çš„æ‰€æœ‰å›¾ç‰‡æˆ‘éƒ½æ˜¯é‡‡ç”¨è¿™ç§æ–¹å¼å­˜å‚¨çš„ï¼Œä»‹äºbase64è½¬ç åï¼Œå­—ç¬¦ä¸²è¿‡é•¿ï¼Œå› æ­¤å•ç‹¬æå–å‡ºæ¥åšä¸€ä¸ªè¡¨å­˜å‚¨ã€‚é€šè¿‡idçš„å½¢å¼å…³è”åˆ°å„ä¸»è¡¨ä¸­ã€‚</p>

</blockquote>

<h3 id="æ™ºèƒ½å›å¤">æ™ºèƒ½å›å¤</h3>

<ul>
  <li>æˆ‘ä»¬ç›‘å¬äº†ç”¨æˆ·çš„å‘è¨€ï¼Œæ ¹æ®ç”¨æˆ·çš„å‘è¨€åšæ™ºèƒ½å›å¤ã€‚å› ä¸ºæˆ‘ä»¬æ˜¯è¦åšç•™è¨€å­—æ•°çš„ç»Ÿè®¡ï¼Œä»è€ŒåŒºåˆ†ä¼˜åŠ£ä¼šå‘˜ï¼Œå› æ­¤æˆ‘ä»¬åªæŠ“å–æ–‡æœ¬å’Œå›¾ç‰‡å½¢å¼çš„ç•™è¨€ã€‚ï¼ˆå›¾ç‰‡å½¢å¼çš„åæœŸè€ƒè™‘å¼•å…¥AIè¯†åˆ«åŠŸèƒ½ï¼Œè‡ªåŠ¨å¯¹å›¾ç‰‡åšåˆ†æã€‚ï¼‰</li>
  <li>ç®¡ç†å¹³å°æœ‰ä¸€å¥—å…³é”®è¯çš„ç®¡ç†åŠŸèƒ½ï¼Œå¯è‡ªè¡Œè®¾ç½®å…³é”®è¯çš„å†…å®¹ï¼Œæ”¯æŒæ¨¡ç³ŠåŒ¹é…å’Œå®Œå…¨åŒ¹é…ã€‚åŒæ—¶æˆ‘ä»¬è¿˜æ·»åŠ äº†æ•æ„Ÿè¯è¿‡æ»¤ï¼Œä½†å‡¡è¸©å‘3æ¬¡ä»¥ä¸Šçš„ç”¨æˆ·ï¼Œé‚£ä¸å¥½æ„æ€äº†ï½88äº†æ‚¨å˜ã€‚åšè¿™ä¸ªåŠŸèƒ½çš„ä¸»è¦ç›®çš„è¿˜æ˜¯ä¸ºäº†ä¿è¯å’Œè°çš„ç¾¤ç¯å¢ƒã€‚</li>
  <li>æˆ‘ä»¬çš„æ™ºèƒ½å›å¤å¹¶ä¸æ˜¯24å°æ—¶éƒ½å›å¤ï¼Œåªæ˜¯ä¸ºäº†å‡å°‘æˆ‘ä»¬è¿è¥äººå‘˜çš„å·¥ä½œé‡ï¼Œåªåœ¨ä»–ä»¬ä¼‘æ¯çš„æ—¶å€™å·¥ä½œï¼Œåšåˆ°ç¾¤ç®¡ç†æ— äººå€¼å®ˆã€‚</li>
</ul>

<h4 id="ä¸šåŠ¡ä»£ç ">ä¸šåŠ¡ä»£ç </h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ¶ˆæ¯è‡ªåŠ¨å›å¤</span>
<span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="nf">function </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nf">self</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">sender</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="k">from</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nf">room</span><span class="p">()</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Text</span> <span class="o">&amp;&amp;</span> <span class="nx">message</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">info</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">`æ¶ˆæ¯ç±»å‹ï¼š</span><span class="p">${</span><span class="nx">message</span><span class="p">.</span><span class="nf">type</span><span class="p">()}</span><span class="s2">,content=</span><span class="p">${</span><span class="nx">content</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">topic</span> <span class="o">=</span> <span class="nx">room</span> <span class="p">?</span> <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">topic</span><span class="p">()</span> <span class="p">:</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">room</span> <span class="o">&amp;&amp;</span> <span class="nx">default_rooms</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="nx">topic</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// åˆ¤æ–­æ˜¯å¦æ˜¯æ–°ç”¨æˆ·ï¼Œè‹¥æ˜¯ä¿å­˜åˆ°æ•°æ®åº“</span>
            <span class="nf">saveUser</span><span class="p">(</span><span class="nx">sender</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">err</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">`saveUser error When get message. Error is : </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// è®°å½•èŠå¤©ä¿¡æ¯</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Image</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// å­˜å‚¨å›¾ç‰‡</span>
                <span class="kd">let</span> <span class="nx">filebox</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">message</span><span class="p">.</span><span class="nf">toFileBox</span><span class="p">();</span>
                <span class="kd">let</span> <span class="nx">msgContent</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">filebox</span><span class="p">.</span><span class="nf">toDataURL</span><span class="p">();</span>
                <span class="nx">Query</span><span class="p">.</span><span class="nf">addChat</span><span class="p">(</span><span class="nx">msgContent</span><span class="p">,</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// å­˜å‚¨æ–‡æœ¬</span>
                <span class="nx">Query</span><span class="p">.</span><span class="nf">addChat</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="k">async</span> <span class="nx">chatId</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="c1">// åˆ¤æ–­å›å¤å†…å®¹æ˜¯å¦è¿è§„</span>
                    <span class="nx">Query</span><span class="p">.</span><span class="nf">isFoul</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">chatId</span><span class="p">,</span> <span class="k">async</span> <span class="nx">kid</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="k">if </span><span class="p">(</span><span class="nx">kid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c1">// è®°å½•å¹¶æŸ¥è¯¢ç”¨æˆ·è¿è§„æ¬¡æ•°</span>
                            <span class="nx">Query</span><span class="p">.</span><span class="nf">recordFoul</span><span class="p">(</span><span class="nx">sender</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">chatId</span><span class="p">,</span> <span class="nx">kid</span><span class="p">,</span> <span class="k">async</span> <span class="nx">times</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                <span class="k">if </span><span class="p">(</span><span class="nx">times</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">`æ‚¨å·²è¿è§„3æ¬¡ï¼`</span><span class="p">,</span> <span class="nx">sender</span><span class="p">);</span>
                                    <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">del</span><span class="p">(</span><span class="nx">sender</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                    <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">`æ‚¨çš„å›å¤å†…å®¹å·²è¿è§„ï¼Œå†è¿è§„</span><span class="p">${</span><span class="mi">3</span><span class="o">-</span><span class="nx">times</span><span class="p">}</span><span class="s2">æ¬¡å°†è¢«è¸¢å‡ºç¾¤ç»„ã€‚`</span><span class="p">,</span> <span class="nx">sender</span><span class="p">);</span>
                                <span class="p">}</span>
                            <span class="p">});</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="kd">let</span> <span class="nx">now</span> <span class="o">=</span> <span class="nf">moment</span><span class="p">();</span>
                            <span class="c1">// åˆ¤æ–­æ˜¯å¦åœ¨æœºå™¨äººå·¥ä½œæ—¶é—´</span>
                            <span class="k">if </span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nf">isAfter</span><span class="p">(</span><span class="nx">rest_time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">now</span><span class="p">.</span><span class="nf">isBefore</span><span class="p">(</span><span class="nx">rest_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
                                <span class="c1">// æŸ¥çœ‹æ˜¯å¦è¸©ä¸­äº†å…³é”®è¯</span>
                                <span class="nx">Query</span><span class="p">.</span><span class="nf">queryKeyword</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="nx">chatId</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">async</span> <span class="nx">reply</span> <span class="o">=&gt;</span> <span class="p">{</span>
                                    <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">reply</span><span class="p">,</span> <span class="nx">sender</span><span class="p">);</span>
                                <span class="p">});</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">err</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">`When save message. Error is </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>

<h3 id="è‡ªåŠ¨é€šè¿‡å¥½å‹å¹¶å›å¤ä¿¡æ¯">è‡ªåŠ¨é€šè¿‡å¥½å‹å¹¶å›å¤ä¿¡æ¯</h3>

<p>ä¸ºäº†å‡å°‘è¿è¥äººå‘˜å¯¹æ–°ç”¨æˆ·ç”³è¯·çš„å¤„ç†ï¼Œæˆ‘ä»¬å€ŸåŠ©wechatyå®ç°äº†å¥½å‹è‡ªåŠ¨é€šè¿‡å¹¶å›å¤ä¿¡æ¯çš„åŠ¨èƒ½ã€‚å¹¶æŒ‡ç¤ºç”¨æˆ·ä¸‹ä¸€æ­¥çš„æ“ä½œï¼Œå¯ä»¥å›å¤æŒ‡å®šå†…å®¹è‡ªåŠ©åŠ å…¥ç¾¤ç»„ã€‚</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">friendship</span><span class="dl">'</span><span class="p">,</span> <span class="nx">friendship</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="ç›¸å…³ä»£ç ">ç›¸å…³ä»£ç </h4>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">friendship</span> <span class="o">=</span> <span class="k">async</span> <span class="nx">friendship</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">friendship</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">===</span> <span class="nx">Friendship</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">RECEIVE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1. receive new friendship request from new contact</span>
        <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">contact</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s2">`ä½ å¥½ï¼Œå…‰é“¾å°åŠ©æ‰‹æ¬¢è¿ä½ ï¼
å›å¤â€œåŠ å…¥å…‰é“¾ç¾¤â€å³å¯åŠ å…¥å…‰é“¾å¾®ä¿¡ç¾¤ï¼Œå›å¤â€œè”ç³»å°åŠ©æ‰‹â€ç¨åå°åŠ©æ‰‹å°†å›å¤æ‚¨ã€‚
å…‰é“¾æ˜¯å…¨çƒé¦–ä¸ªâ€œå®‰å…¨æ€§ï¼Œé«˜æ€§èƒ½ï¼Œå»ä¸­å¿ƒåŒ–â€ä¸‰è¦ç´ å®Œå¤‡çš„å…¬é“¾ã€‚
è¯·å…³æ³¨å…‰é“¾å…¶å®ƒç¤¾ç¾¤åŠæ¨å¹¿æ¸ é“ï¼š
telegramç”µæŠ¥ç¾¤: t.me/lightchain_cn
å®˜æ–¹æ–°æµªå¾®åšï¼šLightChainå…‰é“¾
ä¸€ç›´æ’­IDï¼š346346982
äº¤æ˜“å¹³å°ï¼š
OKEx: www.okex.com
IDAXï¼šwww.idax.mn
KKcoin: www.kkcoin.com`</span><span class="p">;</span>
            <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
            <span class="nx">info</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">`Request from </span><span class="p">${</span><span class="nx">contact</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2"> is accept succesfully!`</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">err</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">`Request from </span><span class="p">${</span><span class="nx">contact</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2"> failed to accept!`</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">friendship</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">===</span> <span class="nx">Friendship</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">CONFIRM</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 2. confirm friendship</span>
        <span class="nx">info</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">`new friendship confirmed with </span><span class="p">${</span><span class="nx">contact</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2">`</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="nf">function </span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">content</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">åŠ å…¥å…‰é“¾ç¾¤</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">room</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Query</span><span class="p">.</span><span class="nf">queryRoomRandom</span><span class="p">(</span><span class="k">async</span> <span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Room</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">roomid</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">topic</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">topic</span><span class="p">();</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">sender</span><span class="p">);</span>
                    <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="s2">`æ¬¢è¿ </span><span class="p">${</span><span class="nx">sender</span><span class="p">.</span><span class="nf">name</span><span class="p">()}</span><span class="s2"> åŠ å…¥ </span><span class="p">${</span><span class="nx">topic</span><span class="p">}</span><span class="s2"> `</span><span class="p">,</span> <span class="nx">sender</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">err</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="s2">`Can't join room. </span><span class="p">${</span><span class="nx">e</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
        <span class="k">return</span>
    <span class="p">}</span>
  <span class="p">...</span>
<span class="p">});</span>
</code></pre></div></div>

<blockquote>
  <p>ç›‘å¬å¥½å‹ç”³è¯·ï¼Œè‡ªåŠ¨é€šè¿‡ç”³è¯·ï¼Œå¹¶æç¤ºä¸‹ä¸€æ­¥æ“ä½œã€‚</p>

  <p>åœ¨ç›‘å¬æ¶ˆæ¯æ—¶ï¼Œå¦‚æœå®Œå…¨åŒ¹é…åˆ°åŠ å…¥å…‰é“¾ç¾¤ï¼Œå¹¶ä¸”æ˜¯ç›´æ¥å‘ç»™æœºå™¨äººçš„ï¼Œé‚£ä¹ˆä¼šæ ¹æ®ç¾¤ç»„äººæ•°æ’åºåŠ å…¥ç¾¤ç»„ã€‚</p>
</blockquote>

<h2 id="ç»Ÿè®¡åˆ†æå¹³å°">ç»Ÿè®¡åˆ†æå¹³å°</h2>

<p><img src="/assets/2018/wechaty-lightbot-1.webp" alt="ç™»é™†ç•Œé¢" /></p>

<h3 id="æ¶æ„è®¾è®¡">æ¶æ„è®¾è®¡</h3>

<blockquote>
  <p>æ¸²æŸ“å¼•æ“æ˜¯React</p>

  <p>å‰ç«¯æ¡†æ¶é‡‡ç”¨çš„æ˜¯é˜¿é‡Œå·´å·´èš‚èšé‡‘æœå¼€æºçš„<a href="https://ant.design/">Ant Design</a>ã€‚</p>

  <p>æ•´ä½“æ¶æ„æ˜¯åœ¨<a href="https://github.com/zuiidea/antd-admin">Ant Admin</a>åŸºç¡€ä¸Šæ”¹çš„ã€‚</p>

  <p>æ•°æ®åº“é‡‡ç”¨çš„mysql8.0</p>

  <p>æœåŠ¡æ˜¯node serveræˆ‘è‡ªå·±å°è£…çš„ã€‚</p>
</blockquote>

<h3 id="ä¸šåŠ¡åŠŸèƒ½">ä¸šåŠ¡åŠŸèƒ½</h3>

<blockquote>
  <p>ç›®å‰åªå®ç°äº†å„ä¸ªæ¨¡å—çš„ç®¡ç†åŠŸèƒ½</p>

  <p>ç»Ÿè®¡ç›¸å…³åŠŸèƒ½å°†åœ¨æœˆåº•å‰å¼€å‘å®Œæˆï¼Œå±Šæ—¶æˆ‘ä¼šä¸Šæ¥æ›´æ–°blogï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒã€‚</p>
</blockquote>

<h4 id="å…³é”®è¯ç®¡ç†">å…³é”®è¯ç®¡ç†</h4>

<blockquote>
  <p>å…³é”®è¯åˆ†é¡µæŸ¥è¯¢</p>

  <p>å…³é”®è¯æ”¯æŒå®Œå…¨åŒ¹é…å’Œæ¨¡ç³ŠåŒ¹é…ï¼Œä¼˜å…ˆå®Œå…¨åŒ¹é…ã€‚</p>

  <p>æ”¯æŒæŸ¥è¯¢æ¡ä»¶ç­›é€‰</p>
</blockquote>

<p><img src="/assets/2018/wechaty-lightbot-2.webp" alt="æ•æ„Ÿè¯ç®¡ç†" /></p>

<h4 id="æ•æ„Ÿè¯ç®¡ç†">æ•æ„Ÿè¯ç®¡ç†</h4>

<blockquote>
  <p>å¯¹æ•æ„Ÿè¯çš„ç®¡ç†
<img src="/assets/2018/wechaty-lightbot-3.webp" alt="æ•æ„Ÿè¯ç®¡ç†" /></p>
</blockquote>

<h4 id="èŠå¤©ç®¡ç†">èŠå¤©ç®¡ç†</h4>

<h5 id="èŠå¤©è®°å½•">èŠå¤©è®°å½•</h5>

<blockquote>
  <p>æ ¹æ®ç¾¤ï¼Œç”¨æˆ·è§’è‰²å’Œæ—¶é—´è¿›è¡Œåˆ†é¡µæŸ¥è¯¢</p>
</blockquote>

<p><img src="/assets/2018/wechaty-lightbot-4.webp" alt="èŠå¤©è®°å½•" /></p>

<h5 id="å¯¹è¯æ¨¡å¼">å¯¹è¯æ¨¡å¼</h5>

<blockquote>
  <p>æ ¹æ®ç¾¤ï¼Œç‰¹å®šç”¨æˆ·ï¼Œæ—¶é—´è¿›è¡Œæ•°æ®ç­›é€‰</p>

  <p>è¿‡æ»¤æ‰å¤šä½™äººå‘˜çš„å‘è¨€ï¼Œåªæ˜¾ç¤ºç­›é€‰ç”¨æˆ·çš„èŠå¤©è®°å½•</p>
</blockquote>

<p><img src="/assets/2018/wechaty-lightbot-5.webp" alt="èŠå¤©è®°å½•" /></p>

<h4 id="ç”¨æˆ·ç®¡ç†">ç”¨æˆ·ç®¡ç†</h4>

<blockquote>
  <p>å¿«é€ŸæŸ¥çœ‹ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</p>

  <p>è®¾ç½®ç”¨æˆ·çš„è§’è‰²ï¼ˆç”¨æˆ·ï¼Œæ°´å†›ï¼Œç®¡ç†å‘˜ï¼‰ï¼Œä»è€Œè¿›è¡Œç¾¤æ´»è·ƒåˆ†æã€‚</p>
</blockquote>

<p><img src="/assets/2018/wechaty-lightbot-6.webp" alt="ç”¨æˆ·ç®¡ç†" /></p>

<h4 id="ç¾¤ç»„ç®¡ç†">ç¾¤ç»„ç®¡ç†</h4>

<blockquote>
  <p>æŸ¥çœ‹ç¾¤ç»„ä¿¡æ¯</p>

  <p>è®¾ç½®è´£ä»»è´¦æˆ·ï¼ˆè¿™ä¸ªæ˜¯ä¸ºäº†ä½“ç°è¿è¥äººå‘˜æ°´å¹³è€Œè®¾ç½®çš„ï¼‰</p>
</blockquote>

<p><img src="/assets/2018/wechaty-lightbot-7.webp" alt="ç”¨æˆ·ç®¡ç†" /></p>

<h4 id="ç»Ÿè®¡åˆ†æ">ç»Ÿè®¡åˆ†æ</h4>

<p>åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ã€‚ã€‚ã€‚</p>

<blockquote>
  <p>Author: <a href="https://github.com/zhoumh1988">@LittleStrong</a>, WEB Development Manager at <a href="http://itrustdata.com/">iTrustdata</a>, å–œæ¬¢æŒ–å‘ä¸å¡«å‘ğŸ˜</p>
</blockquote>

<hr />

<blockquote>
  <p>This post is also available in <a href="/2018/08/14/wechaty-lightbot-analytics-en/">English</a>.</p>
</blockquote>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#analytics">analytics</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#featured">featured</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#utility">utility</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#ecosystem">ecosystem</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/zhoumh1988">
                            <img class="rounded-circle" src="/assets/contributors/zhoumh1988/avatar.webp" alt="LittleStrong" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by <a href="/contributors/zhoumh1988">LittleStrong</a> </h5>
						WEB Development Manager at iTrustdata, å–œæ¬¢æŒ–å‘ä¸å¡«å‘ğŸ˜
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Giscus embeds GitHub Discussions for per-post comments. Configuration intentionally hard-coded. -->

<div id="comments" class="mt-5">
    <script src="https://giscus.app/client.js"
            data-repo="wechaty/js.org"
            data-repo-id="R_kgDOHF4w6Q"
            data-category="General"
            data-category-id="DIC_kwDOHF4w6c4Cx6g7"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="1"
            data-input-position="bottom"
            data-theme="light"
            data-lang="en"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>
        Comments require JavaScript. You can also join the discussion on our
        <a href="https://github.com/wechaty/js.org/discussions/categories/general" rel="noopener" target="_blank">GitHub Discussions</a> page.
    </noscript>
</div>

            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2018/08/14/wechaty-lightbot-analytics-en/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2018/wechaty-lightbot-logo.webp">  Lightbot Statistical Analysis Management Platform</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2018/08/30/ai-bot-wechaty-en/"> Thoughts on AI, Bot, and Wechaty  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2018/08-ai-bot-wechaty-en/hi-ai.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>

  





    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright Â© <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
