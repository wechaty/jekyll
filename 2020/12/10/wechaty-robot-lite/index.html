<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      wechaty-robot-lite 微信小助手 | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>wechaty-robot-lite 微信小助手 | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="wechaty-robot-lite 微信小助手" />
<meta name="author" content="itingle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="最近在dy上看到有相关wx机器人（SCRM）在进行相关推广，而之前学习的时候，用基于python开发的itchat玩过一段时间，后来，某一天突然发现微信登不上了，官方的微信网页版也不能登陆了（至于是啥原因，咱也不知道，也不敢去研究）。" />
<meta property="og:description" content="最近在dy上看到有相关wx机器人（SCRM）在进行相关推广，而之前学习的时候，用基于python开发的itchat玩过一段时间，后来，某一天突然发现微信登不上了，官方的微信网页版也不能登陆了（至于是啥原因，咱也不知道，也不敢去研究）。" />
<link rel="canonical" href="https://wechaty.js.org/2020/12/10/wechaty-robot-lite/" />
<meta property="og:url" content="https://wechaty.js.org/2020/12/10/wechaty-robot-lite/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2020/12-wechaty-robot-lite/example-1.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2020/12-wechaty-robot-lite/example-1.webp" />
<meta property="twitter:title" content="wechaty-robot-lite 微信小助手" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"itingle"},"dateModified":"2020-12-10T00:00:00+00:00","datePublished":"2020-12-10T00:00:00+00:00","description":"最近在dy上看到有相关wx机器人（SCRM）在进行相关推广，而之前学习的时候，用基于python开发的itchat玩过一段时间，后来，某一天突然发现微信登不上了，官方的微信网页版也不能登陆了（至于是啥原因，咱也不知道，也不敢去研究）。","headline":"wechaty-robot-lite 微信小助手","image":"https://wechaty.js.org/assets/2020/12-wechaty-robot-lite/example-1.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2020/12/10/wechaty-robot-lite/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"itingle"},"url":"https://wechaty.js.org/2020/12/10/wechaty-robot-lite/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#tutorial">tutorial</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">wechaty-robot-lite 微信小助手</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/itingle">
                            <img class="rounded-circle" src="/assets/contributors/itingle/avatar.webp" alt="itingle" width="70"/>
                          </a>
                        
						<small class="ml-3"> itingle <span><a target="_blank" href="" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Dec 10, 2020 · <span class="reading-time">
  
  
    34 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2020/12-wechaty-robot-lite/example-1.webp" alt="wechaty-robot-lite 微信小助手">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p>最近在dy上看到有相关wx机器人（SCRM）在进行相关推广，而之前学习的时候，用基于python开发的itchat玩过一段时间，后来，某一天突然发现微信登不上了，官方的微信网页版也不能登陆了（至于是啥原因，咱也不知道，也不敢去研究）。</p>

<p>最近又在捣鼓捣鼓这个小助手，遂捡起了之前看过的wechaty。对！！！就是他！！！他来了~~</p>

<p><a href="https://github.com/wechaty/wechaty"><img src="https://img.shields.io/badge/Powered%20By-Wechaty-green.svg" alt="Powered by Wechaty" /></a>
<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty"><img src="https://img.shields.io/badge/Wechaty-开源激励计划-green.svg" alt="Wechaty开源激励计划" /></a></p>

<p>老规矩，先撩姐（????）</p>

<h2 id="简介">简介</h2>

<ul>
  <li><a href="https://github.com/wechaty">官方（git）</a></li>
  <li>语言：node(TypeScript )，python，java（项目多是支持node，一些是开源了python和java；看issues说是node项目支持的更完美~~咱也没细究）</li>
  <li>协议：iPad、Mac、WinPc、Web等等（支持的协议挺多的，当然，web协议的README里会声明，登录不了web版微信的号不能正常使用）</li>
  <li>使用：这里有个东东要提前声明下：token，wechaty的服务都依赖于token，有个合法的token才能正常使用wechaty的服务；后面会细说</li>
  <li>免费：参与开源激励计划→<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty#2%E5%85%8D%E8%B4%B9Token%E5%8F%82%E4%B8%8E%E5%BC%80%E6%BA%90%E6%BF%80%E5%8A%B1%E8%AE%A1%E5%88%92">传送门(点它)</a></li>
  <li>收费：官方发布是200￥/号/月，具体→<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty#3%E4%BB%98%E8%B4%B9Token%E7%9B%B4%E6%8E%A5%E5%92%A8%E8%AF%A2%E5%95%86%E5%8A%A1%E8%B4%AD%E4%B9%B0">传送门(点它)</a></li>
  <li>说明：官方声明，一个token原则上只能同时在线一个微信号，这里的意思就有意味了。这个token不会绑定你的微信号，但是呢，只能同时在线一个微信，你要是想做n个微信的私域，那就需要n个token</li>
</ul>

<h2 id="学习">学习</h2>

<ul>
  <li>我这里的项目是基于<a href="https://github.com/wechaty/wechaty-puppet-service">wechaty-puppet-service</a></li>
  <li><a href="https://wechaty.js.org/docs/api/">官方API文档</a>（很重要！！！一定要先看文档再下手，如果要基于这个开发，一定要把它当作手册）</li>
  <li><a href="https://github.com/juzibot/donut-tester#example">官方参考示例</a>（至于我为什么基于这个示例，因为官方给的我15天免费token是donut版，基于windows协议）</li>
  <li>语言：主要是nodejs，基于express框架→<a href="https://www.expressjs.com.cn/">传送门（点它）</a></li>
  <li>技术栈：express框架（前端ejs），socket io</li>
  <li>名词解释
    <ul>
      <li>token：官方解释</li>
    </ul>

    <blockquote>
      <ul>
        <li>Our Mission: Make it easy to build a WeChat Chatbot for developers.</li>
      </ul>

      <p>We provide a <strong>free</strong> access using <a href="https://www.lizenghai.com/goto/?url=https://github.com/wechaty/wechaty-puppet-padplus">iPad protocol</a> for the developers who have a strong will and ability to build a valuable chatbot for users.</p>

      <p>Any developers can add JuziBOT Inc’s staff ( <strong>Wechat number :</strong> juzibot) as a Wechat friend. You will receive a review form after adding. If you pass the review and willing to write a blog in Wechaty , you can use our iPad protocol for free！</p>

      <p>我们的使命：轻松为开发人员构建微信聊天机器人</p>

      <p>我们为有强烈意愿和能力为用户构建有价值的聊天机器人的开发人员提供了使用<a href="https://www.lizenghai.com/goto/?url=https://github.com/wechaty/wechaty-puppet-padplus">iPad协议</a>的<strong>免费</strong>访问权限</p>

      <p>任何开发人员都可以将JuziBOT Inc的工作人员（<strong>微信编号：</strong>juzibot）添加为微信好友。添加后，您将收到一份审查表。如果您通过审查并愿意在Wechaty中写博客，则可以免费使用我们的iPad协议！</p>

    </blockquote>

    <ul>
      <li>意思是我们提交审查表后，会获得为期15天的免费Token；想要获取长期有效的免费token，那就参加所谓的开源激励计划，就是在15天后，需要提交一个MVP(最小可行化产品)的Github仓库，Wechaty会将其fork到社区中的同时，会提供一个长期免费Token</li>
      <li><a href="https://www.lizenghai.com/goto/?url=https://github.com/wechaty/wechaty-puppet-padplus">wechaty-puppet-padplus</a>：基于ipad协议的微信机器人</li>
      <li><a href="https://github.com/wechaty/wechaty-puppet-service">wechaty-puppet-service</a>：基于windows协议的机器人</li>
    </ul>
  </li>
</ul>

<h2 id="初步需求">初步需求</h2>

<ul>
  <li>关键字自动通过好友验证
    <ul>
      <li>当有人添加机器人时，判断验证消息关键字后通过或直接通过</li>
      <li>通过验证后自动回复并介绍机器人功能</li>
    </ul>
  </li>
  <li>私聊关键字回复
    <ul>
      <li>例如回复 <code class="language-plaintext highlighter-rouge">加群</code> 推送群聊邀请</li>
      <li>例如回复 <code class="language-plaintext highlighter-rouge">作者微信</code> 推送作者微信名片</li>
      <li>例如回复 白名单<code class="language-plaintext highlighter-rouge">群名</code> 邀请入群</li>
    </ul>
  </li>
  <li>自动聊天
    <ul>
      <li>对接AI机器人，这里科普推荐免费机器人api和<a href="http://www.tianqiapi.com/">免费天气查询api</a>，回复 芜湖天气</li>
      <li>群聊中通过 <code class="language-plaintext highlighter-rouge">@[机器人]xxx</code> 可以和机器人聊天</li>
      <li>私聊发送消息即可聊天</li>
      <li>向机器人询问天气</li>
    </ul>
  </li>
  <li>加入群聊自动欢迎
    <ul>
      <li>当新的小伙伴加入群聊后自动 <code class="language-plaintext highlighter-rouge">@[新的小伙伴]</code> 发一个文字欢迎</li>
    </ul>
  </li>
  <li>web聊天
    <ul>
      <li>前台获取好友列表</li>
      <li>通过socket实时向前台推送还有消息</li>
      <li>实现前台向好友发送消息</li>
    </ul>
  </li>
</ul>

<h2 id="项目结构">项目结构</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|--bin/
|----www <span class="c"># 项目启动文件</span>
|--publick/ <span class="c">#静态资源木狼</span>
|----image/
|----javascripts/
|----stylesheets/
|------style.css
|--routes/ <span class="c"># 路由</span>
|----index.js
|----users.js
|--views/  <span class="c"># 模板</span>
|----error.ejs
|----index.ejs
|--wechaty/
|----onFriendShip.js <span class="c"># 好友添加监听回调</span>
|----onMessage.js    <span class="c"># 消息监听回调</span>
|----onRoomJoin.js   <span class="c"># 进入群聊监听回调</span>
|----onRoomLeave.js  <span class="c"># 退出群聊监听回调</span>
|--app.js    <span class="c"># 核心</span>
|--common.js <span class="c"># 公共方法</span>
|--config.js <span class="c"># 配置文件</span>
|--donut.js  <span class="c"># wechaty核心</span>
|--package.js
|--package-lock.js
|--socketio.js <span class="c"># socket核心</span>
</code></pre></div></div>

<h2 id="代码开干">代码开干</h2>

<p>项目初始化</p>

<p><strong>新建文件夹wechaty-lite，进入目录执行cnpm init -y   (大家都知道国内直接使用 npm 的官方镜像是非常慢的，这里推荐使用<a href="https://www.runoob.com/nodejs/nodejs-npm.html#taobaonpm">淘宝 NPM 镜像</a>。)</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cnpm init <span class="nt">-y</span>
</code></pre></div></div>

<p>安装核心包</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Wechaty核心包
cnpm <span class="nb">install</span> <span class="nt">--save</span> wechaty
// wechaty-puppet协议包
cnpm <span class="nb">install</span> <span class="nt">--save</span> wechaty-puppet
//开发过程中，还需要用到qrcode-terminal这个包，作用就是将二维码输出在终端来供我们扫码登录
cnpm <span class="nb">install</span> <span class="nt">--save</span> qrcode-terminal

//node5以后可以不用使用--save
</code></pre></div></div>

<h2 id="核心代码">核心代码</h2>

<p>配置文件<strong>config.js</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// puppet_donu Token</span>
    <span class="na">token</span><span class="p">:</span> <span class="dl">"</span><span class="s2">PUT_YOUR_TOKEN_HERE</span><span class="dl">"</span><span class="p">,</span>
    <span class="c1">// 机器人名字</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Oreo</span><span class="dl">"</span><span class="p">,</span>
    <span class="c1">// 房间/群聊</span>
    <span class="na">room</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// 管理群组列表</span>
        <span class="na">roomList</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1">// 群名(用于展示，建议用群名) : 群id(先运行程序，获取群id（roomId）)</span>
            <span class="na">大家有钱花</span><span class="p">:</span> <span class="dl">"</span><span class="s2">xxxx1@chatroom</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">wechaty开发组</span><span class="p">:</span> <span class="dl">"</span><span class="s2">xxxx2@chatroom</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="c1">// 加入房间回复</span>
        <span class="na">roomJoinReply</span><span class="p">:</span> <span class="s2">`\n 您好，进群请先看群公告！自觉遵守群规则，文明交流！最后，请用简短的话向大家介绍你自己！?? \n\n Hello, please read the group announcement first! Consciously abide by the group rules, civilized communication! Finally, please introduce yourself in short words! ??`</span><span class="p">,</span>
        <span class="na">autoReturnRoomList</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">大家有钱花</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">wechaty开发组</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="c1">// 私人</span>
    <span class="na">personal</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// 好友验证自动通过关键字</span>
        <span class="na">addFriendKeywords</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">12345</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">一二三四五</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">上山打老虎</span><span class="dl">"</span><span class="p">],</span>
        <span class="c1">// 是否开启加群</span>
        <span class="na">addRoom</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="c1">//阻断不使用机器人回复的好友列表（wxid）</span>
        <span class="na">robotBlockList</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">tengxun</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">tengxun1</span><span class="dl">'</span><span class="p">],</span>
        <span class="c1">//阻断不使用机器人群回复的好友列表（wxid）</span>
        <span class="na">robotQunBlockList</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">tengxun</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">tengxun2</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="c1">//三方api信息</span>
    <span class="na">thirdApi</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">// http://www.itpk.cn/    ai机器人</span>
        <span class="na">itpk</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">apiKey</span><span class="p">:</span> <span class="dl">"</span><span class="s2">xxx</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">apiSecret</span><span class="p">:</span> <span class="dl">"</span><span class="s2">xxx</span><span class="dl">"</span>
        <span class="p">},</span>
        <span class="c1">// http://www.tianqiapi.com/    天气预报</span>
        <span class="na">tianqiapi</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">appId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">zzz</span><span class="dl">"</span><span class="p">,</span>
            <span class="na">appSecret</span><span class="p">:</span> <span class="dl">"</span><span class="s2">zzz</span><span class="dl">"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>启动文件<strong>www</strong></p>

<p>在Create HTTP server.后引入socketio和wechaty，进行启动</p>

<ul>
  <li>引入socketio，调用封装的getSocketio()进行初始化启动；</li>
  <li>引入donut，调用封装的run()进行初始化启动；</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Create socket.io server.
 */</span>

<span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../socketio</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">io</span><span class="p">.</span><span class="nf">getSocketio</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>

<span class="cm">/**
 * Create puppet_donut server.
 */</span>

<span class="kd">var</span> <span class="nx">puppet_donut</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../donut</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nf">run</span><span class="p">();</span>
</code></pre></div></div>

<p>socket服务<strong>socketio.js</strong>文件</p>

<p>该示例主要介绍了socket发送机制，如发送给自己，发送给初自己外的其他用户（广播），推送给所有人；（还可以推送给某一个socket连接用户，通过id，这里不介绍了）</p>

<ol>
  <li>监听客户端的消息；</li>
  <li>监听客户端的微信消息并发送给相关好友；</li>
  <li>封装接口sendWechatLoginMsg、sendWechatMsg给wechaty调用；</li>
</ol>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">var</span> <span class="nx">socketio</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">import</span> <span class="nx">common</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./common</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// 获取io</span>

<span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="c1">//微信登录消息推送至客户端</span>
<span class="nx">socketio</span><span class="p">.</span><span class="nx">sendWechatLoginMsg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
    <span class="nx">io</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">getWechatLoginMsg</span><span class="dl">'</span><span class="p">,</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span><span class="c1">//触发所有用户</span>
<span class="p">};</span>

<span class="c1">//回调消息推送至客户端</span>
<span class="nx">socketio</span><span class="p">.</span><span class="nx">sendWechatMsg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
    <span class="nx">io</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">getWechatMsg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">【</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">common</span><span class="p">.</span><span class="nf">currentDateTime</span><span class="p">()</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">】</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span><span class="c1">//触发所有用户</span>
<span class="p">};</span>

<span class="c1">//初始化socketio</span>
<span class="nx">socketio</span><span class="p">.</span><span class="nx">getSocketio</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">server</span><span class="p">){</span> <span class="c1">// http(s) server</span>

    <span class="nx">io</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">socket.io</span><span class="dl">"</span><span class="p">)(</span><span class="nx">server</span><span class="p">);</span>

    <span class="c1">//监听连接成功</span>
    <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">连接成功</span><span class="dl">'</span><span class="p">);</span>

        <span class="c1">//监听事件event01</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">event01</span><span class="dl">'</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span> <span class="c1">// 处理来自客户端的’event01’事件</span>

            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">监听点击事件</span><span class="dl">'</span><span class="p">);</span>

            <span class="kd">var</span> <span class="nx">datas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">];</span>

            <span class="nx">socket</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">event02</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">datas</span><span class="p">:</span> <span class="nx">datas</span><span class="p">});</span> <span class="c1">// 给该客户端发送event02事件</span>

            <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">event02</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">datas</span><span class="p">:</span> <span class="nx">datas</span><span class="p">});</span> <span class="c1">// 发送给其它客户端</span>

        <span class="p">});</span>

        <span class="c1">//监听事件send</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">send</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>  <span class="c1">// 监听的频道必须和客户端监听的频道相同，等待消息</span>
            <span class="c1">// io.emit("监听频道", "发送的信息");  // 向所有客户端发送信息</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">客户端发送的内容：</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">getMsg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">我是返回的消息... ...</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">common</span><span class="p">.</span><span class="nf">currentDateTime</span><span class="p">());</span><span class="c1">//触发所有用户</span>
            <span class="c1">// socket.emit('getMsg', '我是返回的消息... ...' + new Date().getTime());//触发当前用户</span>
            <span class="c1">// socket.broadcast.emit('getMsg', '我是返回的消息... ...' + new Date().getTime());//触发除去该用户以外的用户</span>
            <span class="c1">// io.to(socketedId).emit('getMsg', '我是返回的消息... ...' + new Date().getTime());//触发指定用户</span>
        <span class="p">});</span>

        <span class="c1">//监听前台发送微信文本消息，并进行消息发送</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">sendWechatText</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">客户端发送的内容：</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">puppet_donut</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./donut</span><span class="dl">'</span><span class="p">);</span>
            <span class="nx">puppet_donut</span><span class="p">.</span><span class="nf">sendTextMsgToContact</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">friendNick</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">wechatContent</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">sendWechatTextCallback</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">微信消息发送成功... ...</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">common</span><span class="p">.</span><span class="nf">currentDateTime</span><span class="p">());</span><span class="c1">//触发所有用户</span>
        <span class="p">});</span>

        <span class="c1">// 更多事件，就更多处理函数</span>

        <span class="c1">// ......</span>

        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">disconnect</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>  <span class="c1">// 客户端断开链接</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">断开连接：</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//发生错误时触发</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nf">setTimeout</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">getMsg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">我是初始化3s后的返回消息... ...</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">3000</span><span class="p">)</span>

    <span class="p">})</span>

<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">socketio</span><span class="p">;</span>
</code></pre></div></div>

<p>donut服务<strong>donut.js</strong>文件</p>

<p>该示例主要介绍了引用wechaty包，实现wechaty初始化、加入群聊、退出群聊、消息等监听和多种发送消息函数封装</p>

<ul>
  <li>bot初始化；</li>
  <li>实现bot监听（OnMessage、OnRoomJoin…）；</li>
  <li>消息发送（文本、媒体、链接等消息）；</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">import</span> <span class="p">{</span> <span class="nx">FileBox</span> <span class="p">}</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">wechaty</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">puppet_donut</span> <span class="o">=</span> <span class="p">{};</span>

<span class="c1">//获取bot（机器人）</span>
<span class="kd">var</span> <span class="nx">bot</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="c1">//发送文本消息给联系人</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">sendTextMsgToContact</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">friendName</span><span class="p">,</span> <span class="nx">text</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">friendName</span><span class="p">});</span>  <span class="c1">//根据昵称搜索好友 change 'lijiarui' to any of your contact name in wechat</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">//好友不存在直接返回</span>
    <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span> <span class="c1">//调用contact对象的say方法发送消息，contact对象很多方法，参考官方文档</span>
<span class="p">};</span>

<span class="c1">//发送媒体消息给联系人</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">sendMediaMsgToContact</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">friendName</span><span class="p">,</span> <span class="nx">fileUrl</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">friendName</span><span class="p">});</span>  <span class="c1">// change 'lijiarui' to any of your contact name in wechat</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">fileUrl</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">fileBox1</span> <span class="o">=</span> <span class="nx">FileBox</span><span class="p">.</span><span class="nf">fromUrl</span><span class="p">(</span><span class="nx">fileUrl</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">fileBox1</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">filePath</span><span class="p">){</span>
        <span class="kd">const</span> <span class="nx">fileBox2</span> <span class="o">=</span> <span class="nx">FileBox</span><span class="p">.</span><span class="nf">fromFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">fileBox2</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//发送名片消息给联系人</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">sendContactCardMsgToContact</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">friendName</span><span class="p">,</span> <span class="nx">contactId</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">friendName</span><span class="p">});</span>  <span class="c1">// change 'lijiarui' to any of your contact name in wechat</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">contactCard</span> <span class="o">=</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">contactId</span><span class="p">);</span>
    <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">contactCard</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">//发送链接消息给联系人</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">sendUrlLinkMsgToContact</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">friendName</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">thumbnailUrl</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">url</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">friendName</span><span class="p">});</span>  <span class="c1">// change 'lijiarui' to any of your contact name in wechat</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">urlLink</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlLink </span><span class="p">({</span>
        <span class="na">description</span> <span class="p">:</span> <span class="nx">description</span><span class="p">,</span>
        <span class="na">thumbnailUrl</span><span class="p">:</span> <span class="nx">thumbnailUrl</span><span class="p">,</span>
        <span class="na">title</span>       <span class="p">:</span> <span class="nx">title</span><span class="p">,</span>
        <span class="na">url</span>         <span class="p">:</span> <span class="nx">url</span><span class="p">,</span>
    <span class="p">});</span>
    <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">urlLink</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">//发送小程序消息给联系人</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">sendMiniProgramMsgToContact</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">friendName</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">appid</span><span class="p">,</span> <span class="nx">title</span><span class="p">,</span> <span class="nx">pagepath</span><span class="p">,</span> <span class="nx">description</span><span class="p">,</span> <span class="nx">thumbnailurl</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">friendName</span><span class="p">});</span>  <span class="c1">// change 'lijiarui' to any of your contact name in wechat</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">miniProgram</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MiniProgram </span><span class="p">({</span>
        <span class="na">username</span>           <span class="p">:</span> <span class="nx">username</span><span class="p">,</span>     <span class="c1">//get from mp.weixin.qq.com</span>
        <span class="na">appid</span>              <span class="p">:</span> <span class="nx">appid</span><span class="p">,</span>        <span class="c1">//optional, get from mp.weixin.qq.com</span>
        <span class="na">title</span>              <span class="p">:</span> <span class="nx">title</span><span class="p">,</span>        <span class="c1">//optional</span>
        <span class="na">pagepath</span>           <span class="p">:</span> <span class="nx">pagepath</span><span class="p">,</span>     <span class="c1">//optional</span>
        <span class="na">description</span>        <span class="p">:</span> <span class="nx">description</span><span class="p">,</span>  <span class="c1">//optional</span>
        <span class="na">thumbnailurl</span>       <span class="p">:</span> <span class="nx">thumbnailurl</span><span class="p">,</span> <span class="c1">//optional</span>
    <span class="p">});</span>
    <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">miniProgram</span><span class="p">)</span>
<span class="p">};</span>

<span class="c1">//初始化调用</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">run</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>

    <span class="k">import</span> <span class="p">{</span> <span class="nx">Wechaty</span> <span class="p">}</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">wechaty</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="p">{</span> <span class="nx">ScanStatus</span> <span class="p">}</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">wechaty-puppet</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="nx">QrcodeTerminal</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">qrcode-terminal</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="nx">io</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./socketio</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">import</span> <span class="nx">config</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./config</span><span class="dl">'</span><span class="p">;</span>

    <span class="k">import</span> <span class="nx">onRoomJoin</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./wechaty/onRoomJoin</span><span class="dl">'</span><span class="p">;</span>     <span class="c1">// 加入房间监听回调</span>
    <span class="k">import</span> <span class="nx">onRoomLeave</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./wechaty/onRoomLeave</span><span class="dl">'</span><span class="p">;</span>   <span class="c1">// 退出房间监听回调</span>
    <span class="k">import</span> <span class="nx">onMessage</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./wechaty/onMessage</span><span class="dl">'</span><span class="p">;</span>       <span class="c1">// 消息监听回调</span>
    <span class="k">import</span> <span class="nx">onFriendShip</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">./wechaty/onFriendShip</span><span class="dl">'</span><span class="p">;</span> <span class="c1">// 好友添加监听回调</span>

    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>

    <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Wechaty</span><span class="p">({</span>
        <span class="na">puppet</span><span class="p">:</span> <span class="dl">'</span><span class="s1">wechaty-puppet-service</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">puppetOptions</span><span class="p">:</span> <span class="p">{</span>
            <span class="nx">token</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>

    <span class="nx">bot</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">scan</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">qrcode</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">ScanStatus</span><span class="p">.</span><span class="nx">Waiting</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">QrcodeTerminal</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="nx">qrcode</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">small</span><span class="p">:</span> <span class="kc">true</span>
                <span class="p">});</span>
                <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">"</span><span class="s2">请扫描二维码进行登录&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`user: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">user</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">"</span><span class="s2">登录成功&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="dl">"</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">loginInfo</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">nick</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                <span class="na">avatar</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">avatar</span>
            <span class="p">};</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatLoginMsg</span><span class="p">(</span><span class="nx">loginInfo</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">room-join</span><span class="dl">"</span><span class="p">,</span> <span class="nx">onRoomJoin</span><span class="p">)</span>    <span class="c1">// 加入群聊监听</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">room-leave</span><span class="dl">"</span><span class="p">,</span> <span class="nx">onRoomLeave</span><span class="p">)</span>  <span class="c1">// 退出群聊房间监听</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">bot</span><span class="p">))</span>  <span class="c1">// 消息监听</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">friendship</span><span class="dl">"</span><span class="p">,</span> <span class="nx">onFriendShip</span><span class="p">)</span> <span class="c1">// 好友添加监听</span>
        <span class="p">.</span><span class="nf">start</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">puppet_donut</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="wechaty监听">Wechaty监听</h3>

<p>这边重点描述下wechaty的监听示例，这也是为什么单独把几个监听业务给抽出来到wechaty目录下的原因之一。</p>

<ul>
  <li>scan                //扫码登录监听</li>
  <li>login                //登录成功监听</li>
  <li>room-join        //加入群聊监听</li>
  <li>room-leave     //退出群聊监听</li>
  <li>message        //消息通知监听</li>
  <li>friendship       //好友添加监听</li>
</ul>

<h3 id="初始化"><strong>初始化</strong></h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Wechaty</span><span class="p">({</span>
        <span class="na">puppet</span><span class="p">:</span> <span class="dl">'</span><span class="s1">wechaty-puppet-service</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">puppetOptions</span><span class="p">:</span> <span class="p">{</span>
            <span class="nx">token</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>
</code></pre></div></div>

<h3 id="发送文本消息给好友">发送文本消息给好友</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//发送文本消息给联系人</span>
<span class="nx">puppet_donut</span><span class="p">.</span><span class="nx">sendTextMsgToContact</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">friendName</span><span class="p">,</span> <span class="nx">text</span><span class="p">){</span>
    <span class="kd">const</span> <span class="nx">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="nx">friendName</span><span class="p">});</span>  <span class="c1">//根据昵称搜索好友 change 'lijiarui' to any of your contact name in wechat</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contact</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">//好友不存在直接返回</span>
    <span class="k">await</span> <span class="nx">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span> <span class="c1">//调用contact对象的say方法发送消息，contact对象很多方法，参考官方文档</span>
<span class="p">};</span>
</code></pre></div></div>

<p>这里传入两个参数</p>

<ul>
  <li>friendName  //好友昵称，这里可以调用对象Contact的find({name: friendName})函数进行好友查询</li>
  <li>text               //发送的文本内容</li>
</ul>

<p>其他的发送方式在代码里，这里直接看代码，不一一解释（代码详细注释，建议参考官方文档）</p>

<h3 id="监听配置启动"><strong>监听配置启动</strong></h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">bot</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">scan</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">qrcode</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">ScanStatus</span><span class="p">.</span><span class="nx">Waiting</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">QrcodeTerminal</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="nx">qrcode</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">small</span><span class="p">:</span> <span class="kc">true</span>
                <span class="p">});</span>
                <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">"</span><span class="s2">请扫描二维码进行登录&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`user: </span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">user</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">"</span><span class="s2">登录成功&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><span class="dl">"</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">loginInfo</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">nick</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                <span class="na">avatar</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">avatar</span>
            <span class="p">};</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatLoginMsg</span><span class="p">(</span><span class="nx">loginInfo</span><span class="p">);</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">room-join</span><span class="dl">"</span><span class="p">,</span> <span class="nx">onRoomJoin</span><span class="p">)</span>    <span class="c1">// 加入群聊监听</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">room-leave</span><span class="dl">"</span><span class="p">,</span> <span class="nx">onRoomLeave</span><span class="p">)</span>  <span class="c1">// 退出群聊房间监听</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">,</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">bot</span><span class="p">))</span>  <span class="c1">// 消息监听</span>
        <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">friendship</span><span class="dl">"</span><span class="p">,</span> <span class="nx">onFriendShip</span><span class="p">)</span> <span class="c1">// 好友添加监听</span>
        <span class="p">.</span><span class="nf">start</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="scan顾名思义是用于扫码登录的一个监听"><strong>scan</strong>（顾名思义，是用于扫码登录的一个监听）</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                <span class="nx">QrcodeTerminal</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="nx">qrcode</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">small</span><span class="p">:</span> <span class="kc">true</span>
                <span class="p">});</span>
</code></pre></div></div>

<p>这里代码较简单，意思是前面通过</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">QrcodeTerminal</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">qrcode-terminal</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div>

<p>引用qrcode-terminal模块，用于在终端进行二维码输出，方便我们测试扫码；</p>

<p>我们借助<code class="language-plaintext highlighter-rouge">Qrterminal.generate</code>这个API将 qr 码输出到终端而已，后面那个<code class="language-plaintext highlighter-rouge">small</code>参数是因为<code class="language-plaintext highlighter-rouge">qrcode-terminal</code> 这个包默认输出的二维码很大，给它变小一些；</p>

<p>这边有一个坑，在webstorm上打码的时候，在终端输出的二维码是这样的，</p>

<p><img src="/assets/2020/12-wechaty-robot-lite/qrcode-login-error.webp" alt="alt text" title="qrcode-login-error" /></p>

<p>这时候我们需要把这些字符串复制到码农神器notepad++里，如下图</p>

<p><img src="/assets/2020/12-wechaty-robot-lite/qrcode-login.webp" alt="alt text" title="qrcode-login" /></p>

<p>然后进行扫码登录；</p>

<p>这个问题我在centos下测试是没有这个问题，生产上大家不用担心。</p>

<h3 id="onfriendship"><strong>onFriendShip</strong></h3>

<p>用于好友监听的监听，这块逻辑比较简单（参看别人代码，直接撸过来的，哈哈哈，在此感谢这位朋友）；</p>

<p>监听好友添加的请求通知，如果打招呼信息hello()内容符合关键词列表，则进行允予通过accept();</p>

<p>这里我看了官方文档，可实现的业务很多，大家可参考官方api进行更多业务拓展！！！</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Friendship</span> <span class="p">}</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">wechaty</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// 配置文件</span>
<span class="k">import</span> <span class="nx">config</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">../config</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">io</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">../socketio</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// 好友添加验证消息自动同意关键字数组</span>
<span class="kd">const</span> <span class="nx">addFriendKeywords</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">personal</span><span class="p">.</span><span class="nx">addFriendKeywords</span><span class="p">;</span>

<span class="c1">// 好友添加监听回调</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">onFriendShip</span><span class="p">(</span><span class="nx">friendship</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">logMsg</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">logMsg</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">添加好友</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">contact</span><span class="p">().</span><span class="nf">name</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">logMsg</span><span class="p">);</span>
        <span class="k">switch </span><span class="p">(</span><span class="nx">friendship</span><span class="p">.</span><span class="nf">type</span><span class="p">())</span> <span class="p">{</span>
            <span class="cm">/**
             * 1. 新的好友请求
             * 设置请求后，我们可以从request.hello中获得验证消息,
             * 并通过`request.accept（）`接受此请求
             */</span>
            <span class="k">case</span> <span class="nx">Friendship</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="na">Receive</span><span class="p">:</span>
                <span class="c1">// 判断配置信息中是否存在该验证消息</span>
                <span class="k">if </span><span class="p">(</span><span class="nx">addFriendKeywords</span><span class="p">.</span><span class="nf">some</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span> <span class="o">==</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">hello</span><span class="p">()))</span> <span class="p">{</span>
                    <span class="nx">logMsg</span> <span class="o">=</span> <span class="s2">`自动通过验证，因为验证消息是"</span><span class="p">${</span><span class="nx">friendship</span><span class="p">.</span><span class="nf">hello</span><span class="p">()}</span><span class="s2">"`</span><span class="p">;</span>
                    <span class="c1">// 通过验证</span>
                    <span class="k">await</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">logMsg</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">不自动通过，因为验证消息是: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">hello</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>

            <span class="cm">/**
             * 2. 友谊确认
             */</span>
            <span class="k">case</span> <span class="nx">Friendship</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="na">Confirm</span><span class="p">:</span>
                <span class="nx">logMsg</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">friend ship confirmed with </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">friendship</span><span class="p">.</span><span class="nf">contact</span><span class="p">().</span><span class="nf">name</span><span class="p">();</span>
                <span class="k">break</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">logMsg</span><span class="p">)</span>
        <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="nx">logMsg</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logMsg</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="onroomjoin">onRoomJoin</h3>

<p>这里主要监听用户加入房间的回调</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 配置文件</span>
<span class="k">import</span> <span class="nx">config</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">../config</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">io</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">../socketio</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// 加入房间回复</span>
<span class="kd">const</span> <span class="nx">roomJoinReply</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">roomJoinReply</span><span class="p">;</span>
<span class="c1">// 管理群组列表</span>
<span class="kd">const</span> <span class="nx">roomList</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">roomList</span><span class="p">;</span>

<span class="c1">// 进入房间监听回调 room-群聊 inviteeList-受邀者名单 inviter-邀请者</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">onRoomJoin</span><span class="p">(</span><span class="nx">room</span><span class="p">,</span> <span class="nx">inviteeList</span><span class="p">,</span> <span class="nx">inviter</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 判断配置项群组id数组中是否存在该群聊id</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nf">values</span><span class="p">(</span><span class="nx">roomList</span><span class="p">).</span><span class="nf">some</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span> <span class="o">==</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// let roomTopic = await room.topic()</span>
        <span class="nx">inviteeList</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// 发送消息并@</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">【邀请者】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">inviter</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> 邀请 </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">c</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> 入群</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">"</span><span class="s2">【邀请者】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">inviter</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> 邀请 </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">c</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> 入群</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">roomJoinReply</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>这里我们说明下，如果是在配置白名单roomJoinReply里的群，只要有新人加入，我们就发一个欢迎词并@他下</p>

<p>这些内容我们现在放在config中，实际业务肯定是放在db中，业务启动去获取或实时监听；</p>

<p>此回调接收三个参数</p>

<ul>
  <li>room 群聊实例</li>
  <li>inviteeList 受邀者名单</li>
  <li>inviter 邀请者</li>
</ul>

<p>有了房间，受邀者，邀请者，这里可实现的业务就多了~~此处啪啦啪啦省略800字…</p>

<p>做一下判断就可以了，这里的<code class="language-plaintext highlighter-rouge">room.id</code>就是我们配置的管理群组列表对象roomJoinReply的value值</p>

<p>为什么要有管理群组列表对象呢？因为我们在登录了一个微信号时，群组进入监听是针对微信号中所有群组的</p>

<p>我的需求是要管理我的群组，所以事先跑了下程序，输出了<code class="language-plaintext highlighter-rouge">room</code>，然后群里发个消息，就拿到了我想管理的群组所有信息，id自然也在里面，然后写到了配置里，这里输出一个room的聊天信息示例，这里面的roomId就是房号</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"_events"</span><span class="p">:{},</span><span class="nl">"_eventsCount"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"2098964982947510281"</span><span class="p">,</span><span class="nl">"payload"</span><span class="p">:{</span><span class="nl">"filename"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"fromId"</span><span class="p">:</span><span class="s2">"发送者微信号"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"209896498xxxxx消息唯一id"</span><span class="p">,</span><span class="nl">"mentionIdList"</span><span class="p">:[</span><span class="s2">"wxid_diuxkznxxxx群里好友wxid列表"</span><span class="p">],</span><span class="nl">"roomId"</span><span class="p">:</span><span class="s2">"xxxx@chatroom"</span><span class="p">,</span><span class="nl">"text"</span><span class="p">:</span><span class="s2">"@Oreo 北京天气"</span><span class="p">,</span><span class="nl">"timestamp"</span><span class="p">:</span><span class="mi">1607568215000</span><span class="p">,</span><span class="nl">"toId"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="mi">7</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>接下来就是，监听到新加入，把受邀者列表遍历一下，使用<code class="language-plaintext highlighter-rouge">room.say</code>方法发送群消息即可，受邀者列表里存的就是加入的微信号实例，<code class="language-plaintext highlighter-rouge">say</code> 方法第一个参数就是要发送的消息，第二个参数就是为了@此人一下。。。其他业务开发请参考<a href="https://wechaty.js.org/docs/api/">官方文档（再来一个传送门）</a></p>

<h3 id="onroomleave">onRoomLeave</h3>

<p>监听用户退出群聊</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">io</span>  <span class="k">from</span> <span class="dl">'</span><span class="s1">../socketio</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// 进入房间监听回调 room-群聊 leaver-退群者</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span> <span class="nf">onRoomLeave</span><span class="p">(</span><span class="nx">room</span><span class="p">,</span> <span class="nx">leaver</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">群-【</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">room</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">leaver</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> 退群</span><span class="dl">"</span><span class="p">);</span>
    <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">"</span><span class="s2">群-【</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">room</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">leaver</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> 退群</span><span class="dl">"</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<p>这里的业务更简单了，主要是监听用户推出群聊</p>

<p>此回调接收三个参数</p>

<ul>
  <li>room 群聊实例</li>
  <li>leaver 退出群聊者</li>
</ul>

<h3 id="onmessage">onMessage</h3>

<p>主要监听消息的接收</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// 判断此消息类型是否为文本</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Text</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 判断消息类型来自群聊</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">room</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">// 获取群聊</span>
                <span class="kd">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">room</span><span class="p">();</span>
                <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">'</span><span class="s1">【</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">room</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">topic</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">】@</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">().</span><span class="nf">name</span><span class="p">()</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">());</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">autoReturnRoomList</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">autoReturnRoomList</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">topic</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span><span class="c1">//判断该群是否在阻断名单,如果是空数组，则不阻断</span>
                <span class="c1">// 收到消息，提到自己</span>
                <span class="k">if </span><span class="p">(</span><span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">mentionSelf</span><span class="p">())</span> <span class="p">{</span>
                    <span class="c1">// 获取提到自己的名字</span>
                    <span class="c1">// let self = await msg.to();//该函数返回null</span>
                    <span class="c1">// self = "@" + self.name();</span>
                    <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">@</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
                    <span class="c1">// 获取消息内容，拿到整个消息文本，去掉 @+名字</span>
                    <span class="kd">let</span> <span class="nx">sendText</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>

                    <span class="c1">// 请求机器人接口回复</span>
                    <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">requestRobot</span><span class="p">(</span><span class="nx">sendText</span><span class="p">);</span>

                    <span class="c1">// 返回消息，并@来自人</span>
                    <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">());</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// 收到消息，没有提到自己  忽略</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// 回复信息是关键字 “加群”</span>
                <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">'</span><span class="s1">@</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">().</span><span class="nf">name</span><span class="p">()</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">());</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">personal</span><span class="p">.</span><span class="nx">robotBlockList</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">().</span><span class="nx">id</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span><span class="c1">//判断该好友是否在阻断名单</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">personal</span><span class="p">.</span><span class="nx">robotQunBlockList</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">().</span><span class="nx">id</span><span class="p">)){</span><span class="c1">//判断该好友是否在群阻断名单</span>
                    <span class="k">if </span><span class="p">(</span><span class="k">await</span> <span class="nf">isAddRoom</span><span class="p">(</span><span class="nx">msg</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

                    <span class="c1">// 回复信息是所管理的群聊名</span>
                    <span class="k">if </span><span class="p">(</span><span class="k">await</span> <span class="nf">isRoomName</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">msg</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// 请求机器人聊天接口</span>
                <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">requestRobot</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">());</span>
                <span class="c1">// 返回聊天接口内容</span>
                <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">消息不是文本！</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">sendWechatMsg</span><span class="p">(</span><span class="dl">'</span><span class="s1">收到非文本消息</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>这里有个代码块</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">to</span><span class="p">();</span>
</code></pre></div></div>

<p>参考别人的代码，这个协议版本这里获取出来的的是null，所以直接改成替换成自己的name（config中配置），可能是协议或版本不一样，api做了调整；这里我没细查官方api，欢迎补充。</p>

<p><strong>加入群聊监听</strong> 这里有个业务点简单描述下，根据用户私聊的的内容，判断是否触发关键词，如果触发直接发送可加的群信息；</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @description 回复信息是关键字 “加群” 处理函数
 * @param {Object} msg 消息对象
 * @return {Promise} true-是 false-不是
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">isAddRoom</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 关键字 加群 处理</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">wo要加群123</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">roomListName</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">roomList</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">info</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">name</span><span class="p">}</span><span class="s2">当前管理群聊有</span><span class="p">${</span><span class="nx">roomListName</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2">个，回复群聊名即可加入哦\n\n`</span><span class="p">;</span>
        <span class="nx">roomListName</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">info</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">【</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">v</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">】</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span>
        <span class="p">});</span>
        <span class="nx">msg</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">info</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></div></div>

<p>回复<strong>群名</strong>进行群邀请</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @description 回复信息是所管理的群聊名 处理函数
 * @param {Object} bot 实例对象
 * @param {Object} msg 消息对象
 * @return {Promise} true-是群聊 false-不是群聊
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">isRoomName</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 回复信息为管理的群聊名</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">roomList</span><span class="p">).</span><span class="nf">some</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span> <span class="o">==</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">()))</span> <span class="p">{</span>
        <span class="c1">// 通过群聊id获取到该群聊实例</span>
        <span class="kd">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">Room</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="nx">roomList</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">()]</span> <span class="p">});</span>

        <span class="c1">// 判断是否在房间中 在-提示并结束</span>
        <span class="k">if </span><span class="p">(</span><span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">()))</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="dl">"</span><span class="s2">您已经在房间中了</span><span class="dl">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>

        <span class="c1">// 发送群邀请</span>
        <span class="k">await</span> <span class="nx">room</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">())</span>
        <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="dl">"</span><span class="s2">已发送群邀请</span><span class="dl">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ai机器人">AI机器人</h3>

<p>说到微信机器人，肯定不能脱离AI只能回复；这里的业务用到了自动陪聊和天气查询的功能，分别用到了如下api，相关参数配置在config文件，大家自行申请api 参数进行修改</p>

<ul>
  <li>免费机器人
    <ul>
      <li>接口文档：<a href="http://www.itpk.cn/">http://www.itpk.cn/</a></li>
      <li>这里自行注册，还可以配置自定义回复，无答案回复，自行训练等等</li>
    </ul>
  </li>
  <li>免费天气
    <ul>
      <li>接口文档：<a href="http://www.tianqiapi.com/%C2%A0">http://www.tianqiapi.com/</a></li>
      <li>这里官方文档竟然给了个公开能用的appid和appsecret…额。。。大家自行参考文档</li>
    </ul>
  </li>
</ul>

<p>这里没什么可细说，主要是调用第三方封装的api，进行一些关键词的自动答复；</p>

<p>涉及到api的http请求，所以需要引入如下两个模块</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cnpm <span class="nb">install</span> <span class="nt">--save</span> request
cnpm <span class="nb">install</span> <span class="nt">--save</span> urlencode
</code></pre></div></div>

<p>这里小小吐槽下图灵，n年体验过图灵，这回本来想申请图灵的api测试，结果关注官方公众号等渠道体验。。。好吧，竟然没有机器人只能答复，遂找了家免费的AI机器人，希望大家别吐槽不智能~~~哈哈，毕竟itpk也需要慢慢进步嘛</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @description 机器人请求接口 处理函数
 * @param {String} info 发送文字
 * @return {Promise} 相应内容
 */</span>
<span class="kd">function</span> <span class="nf">requestRobot</span><span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">info</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">trim</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`http://i.itpk.cn/api.php?type=json&amp;question=</span><span class="p">${</span><span class="nf">urlencode</span><span class="p">(</span><span class="nx">info</span><span class="p">)}</span><span class="s2">&amp;api_key=</span><span class="p">${</span><span class="nx">itpkApiKey</span><span class="p">}</span><span class="s2">&amp;api_secret=</span><span class="p">${</span><span class="nx">itpkApiSecret</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nf">endsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">天气</span><span class="dl">"</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">info</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">天气</span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">);</span>
            <span class="nx">url</span> <span class="o">=</span> <span class="s2">`https://tianqiapi.com/api?version=v6&amp;city=</span><span class="p">${</span><span class="nf">urlencode</span><span class="p">(</span><span class="nx">info</span><span class="p">)}</span><span class="s2">&amp;appid=</span><span class="p">${</span><span class="nx">tianqiAppId</span><span class="p">}</span><span class="s2">&amp;appsecret=</span><span class="p">${</span><span class="nx">tianqiAppSecret</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span> <span class="c1">//https://tianqiapi.com/api?version=v6&amp;appid=94481879&amp;appsecret=kYt0kSZ8   官网demo竟然给了个能用的appid和appsecret</span>
            <span class="nf">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if </span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">common</span><span class="p">.</span><span class="nf">isJSON</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nf">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">今天的天气...555</span><span class="dl">'</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
                            <span class="k">if</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">errcode</span><span class="p">){</span>
                                <span class="nf">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">今天的天气...555...555</span><span class="dl">'</span><span class="p">);</span>
                            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                                <span class="kd">let</span> <span class="nx">send</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">【日期】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">date</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">（</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">week</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">）</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【最近更新时间】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">update_time</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【国家】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">country</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">（</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">countryEn</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">）</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【城市】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">city</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">（</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">cityEn</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">）</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【天气】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">wea</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【体感温度】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">tem</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">℃</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【温度范围】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">tem2</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">℃~</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">tem1</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">℃</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【风向】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">win</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【风力】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">win_speed</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【湿度】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">humidity</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【能见度】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【气压】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">pressure</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">hPa</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【空气质量】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">air</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【pm2.5】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">air_pm25</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span>
                                    <span class="dl">"</span><span class="s2">【温馨提示】：</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">air_tips</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">;</span>
                                <span class="nf">resolve</span><span class="p">(</span><span class="nx">send</span><span class="p">);</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                        <span class="nf">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">再等等吧，今天的天气预报好像...还在路上呢</span><span class="dl">'</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                    <span class="nf">resolve</span><span class="p">(</span><span class="dl">'</span><span class="s1">今天的天气预报好像...还在路上呢</span><span class="dl">'</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
            <span class="nf">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if </span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if </span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span><span class="c1">//此处返回的json数据有些问题，额外处理</span>
                            <span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">)</span>
                        <span class="p">}</span>

                        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">common</span><span class="p">.</span><span class="nf">isJSON</span><span class="p">(</span><span class="nx">body</span><span class="p">))</span> <span class="p">{</span>
                            <span class="nf">resolve</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="kd">let</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
                            <span class="kd">let</span> <span class="nx">send</span><span class="p">;</span>
                            <span class="k">if </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">send</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">【</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">type</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">】</span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1">签号：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">number1</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="dl">'</span><span class="p">;</span>
                                <span class="k">switch </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">case</span> <span class="dl">'</span><span class="s1">观音灵签</span><span class="dl">'</span><span class="p">:</span>
                                        <span class="nx">send</span> <span class="o">=</span> <span class="nx">send</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">好坏：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">haohua</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">签语：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">qianyu</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">诗意：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">shiyi</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">白话：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jieqian</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">;</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="dl">'</span><span class="s1">月老灵签</span><span class="dl">'</span><span class="p">:</span>
                                        <span class="nx">send</span> <span class="o">=</span> <span class="nx">send</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">好坏：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">haohua</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">诗意：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">shiyi</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">解签：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jieqian</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">注释：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">zhushi</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">白话：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">baihua</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">;</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="k">case</span> <span class="dl">'</span><span class="s1">财神爷灵签</span><span class="dl">'</span><span class="p">:</span>
                                        <span class="nx">send</span> <span class="o">=</span> <span class="nx">send</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">签语：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">qianyu</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">注释：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">zhushi</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">解签：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jieqian</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">解说：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jieshuo</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">结果：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jieguo</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">婚姻：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">hunyin</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">事业：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">shiye</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">功名：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">gongming</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">失物：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">shiwu</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">出外移居：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">cwyj</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">六甲：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">liujia</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">求财：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">qiucai</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">交易：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jiaoyi</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">疾病：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">jibin</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">诉讼：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">susong</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">运途：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">yuntu</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">某事：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">moushi</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span>
                                            <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">合伙做生意：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">hhzsy</span> <span class="o">+</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">;</span>
                                        <span class="k">break</span><span class="p">;</span>
                                    <span class="nl">default</span><span class="p">:</span>
                                <span class="p">}</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">send</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">【</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">】</span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> </span><span class="se">\n</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">content</span><span class="p">;</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">send</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">天呐~~我竟然...</span><span class="dl">"</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="nf">resolve</span><span class="p">(</span><span class="nx">send</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nf">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">我..我..我甚至不知道你在说什么...</span><span class="dl">"</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">resolve</span><span class="p">(</span><span class="dl">"</span><span class="s2">你在说什么，我脑子有点短路诶！</span><span class="dl">"</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里有个槽点，调用机器人api，设置返回的数据是json，但是返回的body字符串里开通竟然多个个’-‘，完了还只能在编译器的控制台能看到，放到浏览器和别的编译器显示不出来，只能进行简单替换处理</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                        <span class="k">if </span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span><span class="c1">//此处返回的json数据有些问题，额外处理</span>
                            <span class="nx">body</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">'</span><span class="s1">?</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">)</span>
                        <span class="p">}</span>
</code></pre></div></div>

<h3 id="回归socketio-前端操作">回归SocketIo 前端操作</h3>

<p>这里为了体验下机器人的代入感，做了个前端demo（很简陋，这里别吐槽。。。就是为了和socket结合一起实时看效果；忽略右上角的红x…调试时中断服务的原因…）</p>

<p><img src="/assets/2020/12-wechaty-robot-lite/web-example.webp" alt="alt text" title="web-example" /></p>

<p>这里简介下<strong>nodejs express socketio</strong>的一些使用</p>

<p>前端引用socket.io.js，为了方式前后端socket版本不一致带来的问题，强烈建议如下引用方式</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/socket.io/socket.io.js</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>会直接调用接口/socket.io目录下的js文件，实际调用到modules目录下的文件</p>

<p><img src="/assets/2020/12-wechaty-robot-lite/code-structure.webp" alt="alt text" title="code-structure" /></p>

<p>前端建立socket连接</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nf">io</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
</code></pre></div></div>

<p>建立连接后，监听名为getMsg的事件</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">getMsg</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">服务端消息：</span><span class="dl">'</span><span class="p">,</span>  <span class="nx">data</span><span class="p">);</span>
            <span class="nx">msg</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">data</span><span class="p">}</span><span class="s2"> &lt;br/&gt;`</span><span class="p">;</span>
        <span class="p">})</span>
</code></pre></div></div>

<p>建立连接，想服务端推送数据（socket.emit()），可以是String，可以是json对象</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="kd">function</span> <span class="nf">sendWxmsg</span><span class="p">(){</span>
            <span class="kd">var</span> <span class="nx">friendNick</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">#friendNick</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">wechatContent</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">'</span><span class="s1">#wechatContent</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">friendNick</span> <span class="o">||</span> <span class="o">!</span><span class="nx">wechatContent</span><span class="p">){</span>
                <span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">请输入信息</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">wechatSend</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">friendNick</span><span class="p">:</span> <span class="nx">friendNick</span><span class="p">,</span>
                <span class="na">wechatContent</span><span class="p">:</span> <span class="nx">wechatContent</span>
            <span class="p">};</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">sendWechatText</span><span class="dl">'</span><span class="p">,</span> <span class="nx">wechatSend</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<h3 id="回归socketio-后端操作">回归SocketIo 后端操作</h3>

<p>初始化socketio</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">io</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">socket.io</span><span class="dl">"</span><span class="p">)(</span><span class="nx">server</span><span class="p">);</span>
</code></pre></div></div>

<p>监听客户端的连接，这里socketio知识点很多，比如多客户端连接。通过id和session区分等，建议搭建参考<a href="https://socket.io/">官方文档</a>，官方对socketio支持很赞，java，python，nodejs等等</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">connection</span><span class="dl">'</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{});</span>
</code></pre></div></div>

<p>事件监听，这里举例’send‘事件监听，具体触发如下</p>

<ul>
  <li>调用初始化的io进行emit()或send()，可向所有用户推送该消息（适用场景向所有客户端推送紧急通知）</li>
  <li>调用该监听通道，向当前用户回复消息socket.emit()</li>
  <li>调用当前监听通道，向出自己外的其他用户进行广播推送socket.broadcast.emit()</li>
  <li>调用初始化的io向某个客户端进行单独的消息推送io.to(socketedId).emit()</li>
</ul>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">//监听事件send</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">send</span><span class="dl">"</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>  <span class="c1">// 监听的频道必须和客户端监听的频道相同，等待消息</span>
            <span class="c1">// io.emit("监听频道", "发送的信息");  // 向所有客户端发送信息</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">客户端发送的内容：</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
            <span class="nx">io</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="dl">'</span><span class="s1">getMsg</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">我是返回的消息... ...</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">common</span><span class="p">.</span><span class="nf">currentDateTime</span><span class="p">());</span><span class="c1">//触发所有用户</span>
            <span class="c1">// socket.emit('getMsg', '我是返回的消息... ...' + new Date().getTime());//触发当前用户</span>
            <span class="c1">// socket.broadcast.emit('getMsg', '我是返回的消息... ...' + new Date().getTime());//触发除去该用户以外的用户</span>
            <span class="c1">// io.to(socketedId).emit('getMsg', '我是返回的消息... ...' + new Date().getTime());//触发指定用户</span>
        <span class="p">});</span>
</code></pre></div></div>

<p>此demo的核心代码基本就介绍这么多了…</p>

<h2 id="总结">总结</h2>

<h3 id="写在最后">写在最后</h3>

<ul>
  <li>config的很多配置在实际业务中应业务化处理，比如db化接受实时操作；</li>
  <li>关于wechaty，根据个人的体验，除了没有朋友圈，视频号相关的内容操作，其他的基本满足机器人、私域相关的操作，支持多语言，提供Java，Go，Python，Javascript，C#等主流语言的兼容支持，根据官方api，业务可扩展性极强；</li>
  <li>关于nodejs，由于作者之前并没有nodejs实战开发经验，也是基于这个demo看了nodejs相关文档，学习express框架初学，提供不了太多解读。不过nodejs基于脚本语言，学习起来还是很快；</li>
  <li>关于socketio，和nodejs结合在一起，体验nodejs的异步非阻塞，简直要起了飞；</li>
  <li>环境
    <ul>
      <li>系统：win7、centos7.6成功运行</li>
      <li>nodejs版本：windows下调试：v16.16.2；centos：v10.16.0；（wechaty对node版本有要求，不同协议版本最低要求不一致，大家自行参考开源说明和官方文档）</li>
    </ul>
  </li>
  <li>代码
    <ul>
      <li>主要是抽空码出来的，没有太多时间优化</li>
      <li>有一些业务代码写好了，但是并没有接入使用，欢迎大家补充</li>
      <li>
        <table>
          <tbody>
            <tr>
              <td>刚开始查找微信助手相关功能时在CSDN看到这篇文章[《Wechaty</td>
              <td>不使用微信的web协议的机器人》](https://blog.csdn.net/lx91216/article/details/106257248)，勾起了我对wechaty的回忆和探索，因此这篇文档很多内容上也是参考了它（时间关系甚至直接搬运，希望原文作者原谅哈…）</td>
            </tr>
          </tbody>
        </table>
      </li>
      <li>源码直通车→<a href="https://github.com/itingle/wechaty-robot-lite">点我《wechaty-robot-lite》</a></li>
    </ul>
  </li>
</ul>

<p>后面有空，会持续迭代功能，后续需求扩展</p>

<ul>
  <li>推送
    <ul>
      <li>例如每日早8点，拉取头条<code class="language-plaintext highlighter-rouge">热门文章</code>发送至群聊</li>
      <li>可设置定时任务，定时给自己/群聊发送消息</li>
      <li>好友可定制天气预报定时推送功能</li>
    </ul>
  </li>
  <li>消息监听发送
    <ul>
      <li>同步展示推送媒体消息等</li>
      <li>支持发送动图，表情包等信息</li>
      <li>开启斗图模式</li>
    </ul>
  </li>
  <li>群聊功能消息管理
    <ul>
      <li>监听群聊中消息，有不正当言论时或不文明用语对其警告</li>
      <li>涉zheng，涉huang等言论清除出群</li>
    </ul>
  </li>
  <li>群聊游戏</li>
  <li>后台管理系统(可视化配置及群聊数据统计)
    <ul>
      <li>丰富聊天功能，提供媒体消息发送，资源库内容发送</li>
      <li>统计群聊活跃度，关键词通知统计功能</li>
    </ul>
  </li>
</ul>

<h3 id="ps">PS</h3>

<p>这篇文档说的最多的应该是”官方文档“四个字了吧，这里再点一下，<code class="language-plaintext highlighter-rouge">认真看文档！！！</code></p>

<h3 id="参考文档">参考文档</h3>

<ul>
  <li><a href="https://wechaty.js.org/docs/api/">Wechaty官方API</a></li>
  <li><a href="https://wechaty.github.io/wechaty/">Wechaty官方文档</a></li>
  <li><a href="https://github.com/juzibot/donut-tester#example">Wechaty官方示例</a></li>
  <li><a href="https://socket.io/">socketio</a></li>
  <li><a href="http://nodejs.cn/">nodejs</a></li>
  <li><a href="https://www.expressjs.com.cn/">express框架</a></li>
</ul>

<h3 id="效果截图">效果截图</h3>

<p><img src="/assets/2020/12-wechaty-robot-lite/example-1.webp" alt="alt text" title="example-1" /></p>

<p><img src="/assets/2020/12-wechaty-robot-lite/example-2.webp" alt="alt text" title="example-2" /></p>

<p><img src="/assets/2020/12-wechaty-robot-lite/example-3.webp" alt="alt text" title="example-3" /></p>

<p>待完结</p>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#assistant">assistant</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/itingle">
                            <img class="rounded-circle" src="/assets/contributors/itingle/avatar.webp" alt="itingle" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by itingle </h5>
						go on coder
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2020/12/10/bridge-between-backend-and-wechat/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2020/12-johnwang71/avartar.webp">  沟通后端系统和微信消息的桥梁</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2020/12/23/open-source-pioneer-huan-en/"> Wechaty Author Huan Li Selected for 'China's Open Source Pioneers 33'  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2020/12-open-source-pioneer-huan-en/pioneer.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright © <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
