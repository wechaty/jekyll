<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot） | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot） | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot）" />
<meta name="author" content="ray7551" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Conversational RPA SDK for Chatbot Makers" />
<meta property="og:description" content="Conversational RPA SDK for Chatbot Makers" />
<link rel="canonical" href="https://wechaty.js.org/2020/07/07/wechat-poem-robot/" />
<meta property="og:url" content="https://wechaty.js.org/2020/07/07/wechat-poem-robot/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-07T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp" />
<meta property="twitter:title" content="用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot）" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ray7551"},"dateModified":"2020-07-07T00:00:00+00:00","datePublished":"2020-07-07T00:00:00+00:00","description":"Conversational RPA SDK for Chatbot Makers","headline":"用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot）","image":"https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2020/07/07/wechat-poem-robot/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"ray7551"},"url":"https://wechaty.js.org/2020/07/07/wechat-poem-robot/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#project">project</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot）</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/ray7551">
                            <img class="rounded-circle" src="/assets/contributors/ray7551/avatar.webp" alt="ray7551" width="70"/>
                          </a>
                        
						<small class="ml-3"> ray7551 <span><a target="_blank" href="https://twitter.com/ray7551" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Jul 07, 2020 · <span class="reading-time">
  
  
    11 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2020/wechat-poem-robot/chat.webp" alt="用 Wechaty 实现微信诗歌搜索机器人（wechat poem robot）">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p><a href="https://github.com/wechaty/wechaty"><img src="https://img.shields.io/badge/Powered%20By-Wechaty-green.svg#align=left&amp;display=inline&amp;height=20&amp;margin=%5Bobject%20Object%5D&amp;originHeight=20&amp;originWidth=132&amp;status=done&amp;style=none&amp;width=132" alt="Wechaty Badge" /></a>
<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty"><img src="https://img.shields.io/badge/Wechaty-%E5%BC%80%E6%BA%90%E6%BF%80%E5%8A%B1%E8%AE%A1%E5%88%92-green.svg#align=left&amp;display=inline&amp;height=20&amp;margin=%5Bobject%20Object%5D&amp;originHeight=20&amp;originWidth=134&amp;status=done&amp;style=none&amp;width=134" alt="Everything about Wechaty" /></a></p>

<h2 id="微信机器人">微信机器人</h2>

<p>微信机器人是很常见的运营工具，不仅能够给微信群带来活跃度，还能针对各种社群开发不同的玩法。</p>

<p>我想要做的是一个诗歌机器人，当群内有人@机器人或者用搜索词触发时，机器人从已有的诗歌数据库中查询一首相关的诗歌，以文字形式回复在群内。</p>

<p>有了这个目标以后，我开始了漫长的折腾。</p>

<p>之所以说是折腾，是因为这一路真是障碍重重。</p>

<p>首先，微信官方并没有相关的 API。可能要考虑考虑企业微信？结果发现企业微信有<a href="https://work.weixin.qq.com/api/doc/90000/90136/91770">群机器人</a>，但只支持发送信息，不支持接收。还是得找微信个人号 API。</p>

<p>然后我看了看基于 Web 版微信的各种开源方案，最近一次更新基本是几年前的，issue 列表里常常看见登录不了 Web 版微信的问题。我试了试自己开发用的微信小号，登不了 Web 版微信，放弃。</p>

<p>再然后我试用了基于 PC 版微信的 <a href="https://github.com/Mocha-L/WechatPCAPI">Mocha-L/WechatPCAPI</a>。虽然能用，但是有不少问题。比如获取不了昵称带 emoji 的用户的消息，每次修改完代码必须手动重新启动微信。我相信这些都是可以解决的，但是开发者并没有完全开源核心代码，无从下手。项目主页上写的是有免费版和收费版，我只成功运行了收费版，十几天后，提示试用到期了。这个基于非常规的 HOOK 的方案只能用指定版本的 PC 版微信，需要 Windows 运行环境。考虑到我需要的是一个较长期稳定运行的 API，且能在 Linux 服务器上使用，而且收发信息相对安全，我只能继续寻找更好的方案。</p>

<p>折腾到这里，我已经对各类方案有了基本了解：主要有 Web 网页端、Xpsoed 技术、PC Hook、iPad 协议、模拟机、MAC 协议这六类方案，从稳定性和安全性上比较，iPad 协议和 Mac 协议的方案是比较好的，商业上的应用也比较多。</p>

<p>此时我找到了 <code class="language-plaintext highlighter-rouge">beclass</code> 的博文 <a href="https://wechaty.github.io/2020/05/31/wxbot/">《基于Nodejs+Wechaty开发微信机器人管理平台》</a>。发现了 Wechaty 这个项目，支持 iPad 协议，虽然需要付费获取 token，但是可以申请<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty#2%E5%85%8D%E8%B4%B9Token%E5%8F%82%E4%B8%8E%E5%BC%80%E6%BA%90%E6%BF%80%E5%8A%B1%E8%AE%A1%E5%88%92">参与开源激励计划</a>来获取免费甚至长期有效的 token。</p>

<h2 id="具体实现">具体实现</h2>

<h3 id="基本构架">基本构架</h3>

<p>由于前期尝试各种个人号 API 的方案，已经把搜索诗歌的部分独立出来作为一个服务。这个搜素服务接受查询字符串，返回一个包含结果的 json 字符串。</p>

<p>至于跟微信相关的部分，就全部交给 Wechaty 了，包括接收微信消息，查询到诗歌内容以后发送微信消息。</p>

<h3 id="诗歌搜索服务">诗歌搜索服务</h3>

<p>此部分用 PHP+MySQL 实现。诗歌数据库是从某诗歌博客数据库导入，并且用爬虫抓取相关微信公众号文章信息（机器人可以发送公众号文章链接）。</p>

<p>此部分的难点在于博客数据库的诗歌并没有区分标题、内容、诗作者等字段，需要用正则表达式匹配出各个字段内容。虽然大部分的诗歌是有固定格式的，可以通过特定的 html 标签确定标题、诗作者在整个字符串的位置，但不同时期添加进数据库的诗歌格式有细微的区别。</p>

<p>一开始，我试图用一个正则表达式描述尽可能多的格式类型，并且在其中描述所有字段的位置。在折腾了一阵以后我放弃了。</p>

<p>由于对正则表达式具体运行机制不熟悉，它在我眼里就是那种一看就懂，一写就错的外星语言。我需要一个工具来展现正则表达式如何一步步匹配目标字符串，加速我的正则调试过程。</p>

<p>Windows 平台下，我用过 RegexBuddy。我发现了一个更好的 Web 平台正则调试工具 <a href="https://regex101.com/">regex101</a>。它不仅能清楚标注匹配结果，还能展现正则一步步匹配的过程，这对于调试来说至关重要。</p>

<p><img src="/assets/2020/wechat-poem-robot/regex101.webp" alt="regex101" /></p>

<p><img src="/assets/2020/wechat-poem-robot/regex101-debug.webp" alt="regex101-debug" /></p>

<p>除了用正则提取诗歌各字段，还需要匹配各种可能句式中的关键词。测试用例如下：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testGetKeywordStartWithSearch</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'诗'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'小黄诗'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜小黄诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'一下'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索 一下'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'一下'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜 一下'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'大人'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜大人'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'你大爷'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜你大爷'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'大人'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一下大人的诗？'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一搜李白的诗歌'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一搜李白的诗.'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一搜李白的诗。'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一首李白的诗。'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一首李白。'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜一搜李白的现代诗。'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'唐'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜唐诗。'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'宋'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜 宋词。'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'搜索'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索一下搜索'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'dd索'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索一下dd索'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'搜索'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜搜索'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'搜索'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜 搜索'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'搜索'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索 搜索'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'你大姐'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索：你大姐'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'你大姐'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'搜索:你大姐'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'search text'</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testGetKeywordStartWithOther</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'帮我找'</span><span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'辛弃疾拍栏杆'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'我想要辛弃疾拍栏杆的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">([</span><span class="s1">'辛弃疾'</span><span class="p">,</span> <span class="s1">'拍'</span><span class="p">,</span> <span class="s1">'栏杆'</span><span class="p">],</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'我想要辛弃疾拍栏杆的诗'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'一下'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一首 一下的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'杜牧'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'给我来一个杜牧的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李商隐'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'给我来一个 李商隐的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'杜甫'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'给我一个杜甫的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'杜牧'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'告诉我一首杜牧的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'海子写德令哈'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'我想要那个海子写德令哈的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'海子写半截'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'我想要哪个海子写半截的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'写诗'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'帮我找跟写诗有关的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'写诗'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'帮我找一首写诗的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有李白的诗歌'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'李白'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有李白的古诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'杜甫'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一首杜甫的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'海子'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有海子的现代诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">([</span><span class="s1">'李白的'</span><span class="p">,</span> <span class="s1">'现代'</span><span class="p">],</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有李白的 现代 诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一个带天空的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一个带有天空的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一个含"天空"的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一个包含天空的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一个含有天空的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'莎士比亚'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有莎士比亚的十四行诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有跟天空相关的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有和天空有关的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'唐'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'来一首唐诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'宋'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'给我来一个宋词'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'宋'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'给我来个宋词'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'天空'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有跟天空相关的诗歌'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'一首没有人的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'那个写火车的诗'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'帮我找'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没人'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有人'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'有没有谁能告诉我'</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这个部分也花了不少时间，最终写出来的获取关键词的方法如下：</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @param string $str
 * @param boolean $divide
 * @return string[]|string
 */</span>
<span class="k">function</span> <span class="n">getKeyword</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$divide</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'@[[:punct:]\n\r～｜　\s]+@u'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="nv">$str</span><span class="p">));</span>
    <span class="nv">$keyword</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'@^(搜索??|search)(一下|一搜|一首|一个)??\s*?(?&lt;keyword&gt;.*)(的?((古|现代)?诗歌?|词))?$@Uu'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$keyword</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'@^(有没有??|告诉我|帮我找|我想要|(给我来|给我|来)|搜索?)(一首|(一|那|哪)?个|一下)??((和|跟|带|包?含)有??)??\s*?(?&lt;keyword&gt;.*)((有关|相关)?的?((十四行|十六行|古|现代)?诗歌?|词))$@Uu'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
        <span class="nv">$keyword</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 部分情况下，可能需要返回分词结果</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$divide</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">Jieba</span><span class="o">::</span><span class="nf">cut</span><span class="p">(</span><span class="nv">$keyword</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">strstr</span><span class="p">(</span><span class="nv">$keyword</span><span class="p">,</span> <span class="s1">' '</span><span class="p">)</span>
        <span class="o">?</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="nv">$keyword</span><span class="p">)</span>
        <span class="o">:</span> <span class="nv">$keyword</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>中文分词的部分使用了 <a href="https://github.com/fukuball/jieba-php">jieba-php</a>，效率不是很高，内存占用比较大，但是可以接受。</p>

<h3 id="使用-wechaty-收发消息">使用 Wechaty 收发消息</h3>

<p>在 Wechaty 中，不同的 <code class="language-plaintext highlighter-rouge">Puppet</code> 对应不同的协议。Wechaty 还有不同语言的 SDK，以及 demo template repository，对开发者非常友好，开发者参与度也很高。</p>

<p>感谢 <code class="language-plaintext highlighter-rouge">beclass</code> 已经开源了一个成功的案例，我不必从头开始，而是在 <a href="https://github.com/beclass/wxbot">beclass/wxbot</a> 的基础上改动少量代码。</p>

<p><code class="language-plaintext highlighter-rouge">beclass</code> 的<a href="https://wechaty.github.io/2020/05/31/wxbot/">文章</a> 已经介绍了 wxbot 项目，下面不再详细解析 wxbot 的代码，只抽取关键部分。</p>

<p>首先需要初始化一个 bot：</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// create a Wechaty instance as bot</span>
<span class="kd">let</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Wechaty</span><span class="p">({</span>
  <span class="na">puppet</span><span class="p">:</span> <span class="k">new</span> <span class="nc">PuppetPadplus</span><span class="p">({</span>
    <span class="na">token</span><span class="p">:</span> <span class="nx">puppet_padplus_token</span>
  <span class="p">}),</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">poem</span><span class="dl">'</span>
<span class="p">})</span>
</code></pre></div></div>

<p>由于申请的是 iPad 协议的 token，这里用到的是 <code class="language-plaintext highlighter-rouge">PuppetPadplus</code>。
接着对 bot 绑定各种事件的处理函数，其中 <code class="language-plaintext highlighter-rouge">message</code> 事件是接收到消息时触发的事件。</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">scan</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">qrcode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// show the qrcode</span>
<span class="p">}).</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onLogin</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">bot</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">friendship</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onFriendShip</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">room-join</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onRoomJoin</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">room-leave</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onRoomLeave</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">机器故障，error：</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">error</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">logout</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onLogout</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">onMessage</code> 是写在 <code class="language-plaintext highlighter-rouge">server/roobt/message</code> 里的</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 忽略来自自己的消息</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">self</span><span class="p">())</span> <span class="k">return</span>

  <span class="c1">// 目前只处理来自群聊的文本消息</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">room</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
    <span class="c1">// 消息来自群聊</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">mentionSelf</span><span class="p">())</span> <span class="p">{</span>  <span class="c1">//@了机器人</span>
        <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">to</span><span class="p">()</span>
        <span class="nb">self</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">@</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">self</span><span class="p">.</span><span class="nf">name</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nx">receivedText</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="dl">""</span><span class="p">).</span><span class="nf">trim</span><span class="p">()</span>

        <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getPoemReply</span><span class="p">(</span><span class="nx">receivedText</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="c1">// 返回消息，并@来自人</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">poem</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">let</span> <span class="nx">poem</span> <span class="o">=</span> <span class="dl">"</span><span class="se">\n\n</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">content</span><span class="p">.</span><span class="nx">poem</span>
          <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">poem</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">())</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="kd">const</span> <span class="nx">linkPayload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlLink</span><span class="p">({</span>
            <span class="na">description</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">点击查看读睡荐诗</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">thumbnailUrl</span><span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">.</span><span class="nx">cover_src</span><span class="p">,</span>
            <span class="na">title</span>       <span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
            <span class="na">url</span>         <span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">.</span><span class="nx">link</span><span class="p">,</span>
          <span class="p">})</span>
          <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">linkPayload</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// 没有@机器人</span>
        <span class="kd">const</span> <span class="nx">receivedText</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nf">trim</span><span class="p">()</span>
        <span class="c1">// 只处理包含关键词的消息</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nf">isSearchString</span><span class="p">(</span><span class="nx">receivedText</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getPoemReply</span><span class="p">(</span><span class="nx">receivedText</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">poem</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">isSearchString</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="sr">/^搜/</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">||</span> <span class="sr">/的诗歌</span><span class="se">?</span><span class="sr">$/</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
<span class="p">}</span>

<span class="cm">/**
 * @description 回复内容
 * @param {String} info 收到消息
 * @return {Promise} 响应内容
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">getPoemReply</span><span class="p">(</span><span class="nx">word</span><span class="p">,</span> <span class="nx">chatRoomId</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">POEMAPI_HOST</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/bot_search.php</span><span class="dl">'</span>
  <span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">keyword</span><span class="p">:</span> <span class="nx">word</span><span class="p">,</span>
      <span class="na">chatroom</span><span class="p">:</span> <span class="nx">chatRoomId</span>
    <span class="p">},</span>
    <span class="na">encoding</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">timeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="p">{</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">data</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">urllib</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">pkg</span><span class="p">)</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="k">return</span> <span class="dl">'</span><span class="s1">不好意思，我出故障了.</span><span class="dl">'</span>

  <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
  <span class="k">return</span> <span class="nx">data</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="上线">上线</h2>

<p>在 production 环境运行，建议使用 PM2 。</p>

<p>使用起来也很简单，新增一个配置文件 <code class="language-plaintext highlighter-rouge">pm2.config.js</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">wx-robot</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">script</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./server/index.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">env</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">NODE_ENV</span><span class="p">:</span> <span class="dl">"</span><span class="s2">production</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>然后命令行执行 <code class="language-plaintext highlighter-rouge">pm2 start pm2.config.js</code>。
搭配其监控面板服务 PM2+，不仅可以在浏览器中控制任务运行状态，还能查看实时日志：</p>

<p><img src="/assets/2020/wechat-poem-robot/pm2.webp" alt="PM2" /></p>

<p>目标达成：</p>

<p><img src="/assets/2020/wechat-poem-robot/chat.webp" alt="chat" /></p>

<h2 id="结论以及广告">结论（<del>以及广告</del>）</h2>

<p>开发阶段我认为比较重要的部分，匹配各种搜索句式中的关键词，花费了很多时间，甚至还想过用 NL2SQL（自然语言转换为SQL） 技术来做。其实在上线以后很少有人用到，大部分人还是习惯于用 搜+关键词 的方式触发机器人搜索。虽然做的过程很开心，但是没有人用还是挺心酸的。</p>

<p>还可以改进或拓展的地方：</p>

<ol>
  <li>用 ElasticSearch 代替 MySQL 的搜索，对诗歌内容进行分词（对于诗歌内容，分词结果做到正确很难），让搜索结果更准确。</li>
  <li>对不同的群，分别设置机器人的功能开关。</li>
  <li>每次的搜索结果应该尽可能不一样。</li>
  <li>名句对答模式：如果有消息被判定为名句，机器人接下一句。</li>
  <li>飞花令模式：诗句接龙。</li>
  <li>被拍一拍时反拍一下。</li>
</ol>

<p>微信机器人这样常见的需求就应该有简单的做法。在排除各种不靠谱方案以后，我选择了 Wechaty。
Wechaty 简洁的 API 可以帮助开发者快速地搭建一个微信个人号机器人。没有时间折腾的开发者，就不用花时间尝试其它方案了。</p>

<h2 id="one-more-thing">One More Thing</h2>

<p>在此文写作过程中，我一直在想，什么样的技术博文才是好的？讲述各种细节固然是对其它开发者有用的。但软件是一直在变化的，这些有用的细节过不了多久可能就不适用了，反而成为开发者搜索过程中的信息噪音。</p>

<p>Redis 开发者 <a href="http://invece.org/">Salvatore Sanfilippo</a> 在<a href="http://antirez.com/news/129">这篇文章</a>中说</p>
<blockquote>
  <p>Sometimes I believe that software, while great, will never be huge like writing a book that will survive for centuries. Note because it is not as great per-se, but because as a side effect it is also useful… and will be replaced when something more useful is around.</p>
</blockquote>

<p>在我看来，好的技术博文不应只有细节，还要有对细节的思考，对开发过程本身的观察，试图提炼出让开发过程更顺畅的经验。这些经验，甚至可以拓展到其它日常事务的处理过程中去。</p>

<p>互联网每天产生和复制那么多技术博文，能有多少是可以在多年之后仍然给人启发的呢？</p>

<blockquote>
  <p>作者: <a href="https://github.com/ray7551/">ray7551</a></p>
</blockquote>

<hr />

<blockquote>
  <p>This post is also available in <a href="/2020/07/07/wechat-poem-robot-en/">English version</a>.</p>
</blockquote>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#padplus">padplus</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#wechat-robot">wechat-robot</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#regex">regex</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#regex101">regex101</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#featured">featured</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#entertainment">entertainment</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/ray7551">
                            <img class="rounded-circle" src="/assets/contributors/ray7551/avatar.webp" alt="ray7551" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by ray7551 <span><a target="_blank" href="https://twitter.com/ray7551" class="btn btn-outline-success btn-sm btn-round ml-2">Follow</a></span></h5>
						Coder.
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2020/07/07/wechat-poem-robot-en/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp">  Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot)</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2020/07/09/wechat-music-daycard/"> 每日微信音乐卡片分享机器人（wechat-daycard）  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2020/wechat-daycard/header.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright © <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
