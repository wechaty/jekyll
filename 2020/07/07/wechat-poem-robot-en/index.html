<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot) | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot) | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot)" />
<meta name="author" content="ray7551" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Building an intelligent WeChat poetry search chatbot using Wechaty and iPad protocol, with regex-powered keyword extraction and a PHP+MySQL poetry database backend." />
<meta property="og:description" content="Building an intelligent WeChat poetry search chatbot using Wechaty and iPad protocol, with regex-powered keyword extraction and a PHP+MySQL poetry database backend." />
<link rel="canonical" href="https://wechaty.js.org/2020/07/07/wechat-poem-robot-en/" />
<meta property="og:url" content="https://wechaty.js.org/2020/07/07/wechat-poem-robot-en/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-07T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp" />
<meta property="twitter:title" content="Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ray7551"},"dateModified":"2020-07-07T00:00:00+00:00","datePublished":"2020-07-07T00:00:00+00:00","description":"Building an intelligent WeChat poetry search chatbot using Wechaty and iPad protocol, with regex-powered keyword extraction and a PHP+MySQL poetry database backend.","headline":"Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot)","image":"https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2020/07/07/wechat-poem-robot-en/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"ray7551"},"url":"https://wechaty.js.org/2020/07/07/wechat-poem-robot-en/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#project">project</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot)</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/ray7551">
                            <img class="rounded-circle" src="/assets/contributors/ray7551/avatar.webp" alt="ray7551" width="70"/>
                          </a>
                        
						<small class="ml-3"> ray7551 <span><a target="_blank" href="https://twitter.com/ray7551" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Jul 07, 2020 Â· <span class="reading-time">
  
  
    17 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2020/wechat-poem-robot/chat.webp" alt="Implementing a WeChat Poetry Search Robot with Wechaty (wechat poem robot)">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p><a href="https://github.com/wechaty/wechaty"><img src="https://img.shields.io/badge/Powered%20By-Wechaty-green.svg#align=left&amp;display=inline&amp;height=20&amp;margin=%5Bobject%20Object%5D&amp;originHeight=20&amp;originWidth=132&amp;status=done&amp;style=none&amp;width=132" alt="Wechaty Badge" /></a>
<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty"><img src="https://img.shields.io/badge/Wechaty-%E5%BC%80%E6%BA%90%E6%BF%80%E5%8A%B1%E8%AE%A1%E5%88%92-green.svg#align=left&amp;display=inline&amp;height=20&amp;margin=%5Bobject%20Object%5D&amp;originHeight=20&amp;originWidth=134&amp;status=done&amp;style=none&amp;width=134" alt="Everything about Wechaty" /></a></p>

<h2 id="wechat-robot">WeChat Robot</h2>

<p>WeChat robots are very common operational tools that not only bring activity to WeChat groups, but can also develop different gameplay for various communities.</p>

<p>What I wanted to make was a poetry robot. When someone in the group @ mentions the robot or triggers it with a search term, the robot queries a relevant poem from an existing poetry database and replies in text form in the group.</p>

<p>After having this goal, I began a long journey of tinkering.</p>

<p>The reason I call it tinkering is because this journey was full of obstacles.</p>

<p>First, WeChat officially does not have related APIs. Should I consider Enterprise WeChat? I found that Enterprise WeChat has <a href="https://work.weixin.qq.com/api/doc/90000/90136/91770">group robots</a>, but they only support sending messages, not receiving them. Still need to find WeChat personal account APIs.</p>

<p>Then I looked at various open source solutions based on the Web version of WeChat. The most recent updates were basically from a few years ago, and I often saw issues about being unable to log in to the Web version of WeChat. I tried my WeChat development account - couldnât log in to Web WeChat. Gave up.</p>

<p>Next, I tried <a href="https://github.com/Mocha-L/WechatPCAPI">Mocha-L/WechatPCAPI</a> based on the PC version of WeChat. Although usable, there were quite a few problems. For example, couldnât get messages from users whose nicknames contained emoji, and every time code was modified, WeChat had to be manually restarted. I believe these are solvable, but the developer hasnât fully open-sourced the core code, so there was no way to proceed. The project homepage says thereâs a free version and a paid version. I only successfully ran the paid version, and after a dozen days, it prompted that the trial period had expired. This solution based on non-standard HOOK can only use specified versions of PC WeChat and requires a Windows runtime environment. Considering I needed a relatively stable API for long-term operation, could run on a Linux server, and relatively safe message sending and receiving, I had to continue looking for better solutions.</p>

<p>Having tinkered to this point, I had a basic understanding of various solutions: mainly Web page, Xposed technology, PC Hook, iPad protocol, emulator, and MAC protocol - six types of solutions. Comparing stability and security, iPad protocol and Mac protocol solutions are relatively good, with more commercial applications.</p>

<p>At this point, I found <code class="language-plaintext highlighter-rouge">beclass</code>âs blog post <a href="https://wechaty.github.io/2020/05/31/wxbot/">ãDeveloping WeChat Bot Management Platform Based on Nodejs+Wechatyã</a>. I discovered the Wechaty project, which supports iPad protocol. Although a token fee is required, you can apply to <a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty#2%E5%85%8D%E8%B4%B9Token%E5%8F%82%E4%B8%8E%E5%BC%80%E6%BA%90%E6%BF%80%E5%8A%B1%E8%AE%A1%E5%88%92">participate in the open source incentive program</a> to get a free or even long-term valid token.</p>

<h2 id="implementation">Implementation</h2>

<h3 id="basic-architecture">Basic Architecture</h3>

<p>Since I had tried various personal account API solutions in the early stage, I had already separated the poetry search part as an independent service. This search service accepts a query string and returns a json string containing the results.</p>

<p>As for the WeChat-related part, everything was handed over to Wechaty, including receiving WeChat messages and sending WeChat messages after querying poem content.</p>

<h3 id="poetry-search-service">Poetry Search Service</h3>

<p>This part was implemented with PHP+MySQL. The poetry database was imported from a certain poetry blog database, and a crawler was used to scrape related WeChat official account article information (the robot can send official account article links).</p>

<p>The difficulty in this part is that the poems in the blog database do not distinguish between title, content, poem author and other fields. Regular expressions need to be used to match each fieldâs content. Although most poems have a fixed format and you can determine the position of titles and poem authors in the entire string through specific html tags, poems added to the database at different periods have subtle format differences.</p>

<p>Initially, I tried to use one regular expression to describe as many format types as possible and describe the positions of all fields within it. After struggling for a while, I gave up.</p>

<p>Due to unfamiliarity with the specific operating mechanism of regular expressions, in my eyes it was that alien language that looks understandable but produces errors when written. I needed a tool to show how regular expressions match target strings step by step, accelerating my regex debugging process.</p>

<p>On the Windows platform, I used RegexBuddy. I discovered a better web platform regex debugging tool <a href="https://regex101.com/">regex101</a>. It not only clearly marks matching results, but also shows the step-by-step matching process of regex, which is crucial for debugging.</p>

<p><img src="/assets/2020/wechat-poem-robot/regex101.webp" alt="regex101" /></p>

<p><img src="/assets/2020/wechat-poem-robot/regex101-debug.webp" alt="regex101-debug" /></p>

<p>In addition to using regex to extract poem fields, keywords in various possible sentence patterns also need to be matched. Test cases are as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">function</span> <span class="n">testGetKeywordStartWithSearch</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'è¯'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å°é»è¯'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æå°é»è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ä¸ä¸'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢ ä¸ä¸'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ä¸ä¸'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ ä¸ä¸'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤§äºº'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æå¤§äºº'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ä½ å¤§ç·'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä½ å¤§ç·'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤§äºº'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸ä¸å¤§äººçè¯ï¼'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸ææç½çè¯æ­'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸ææç½çè¯.'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸ææç½çè¯ã'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸é¦æç½çè¯ã'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸é¦æç½ã'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æä¸ææç½çç°ä»£è¯ã'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æåè¯ã'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å®'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ å®è¯ã'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç´¢'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢ä¸ä¸æç´¢'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ddç´¢'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢ä¸ä¸ddç´¢'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç´¢'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææç´¢'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç´¢'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ æç´¢'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç´¢'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢ æç´¢'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ä½ å¤§å§'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢ï¼ä½ å¤§å§'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ä½ å¤§å§'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æç´¢:ä½ å¤§å§'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'text'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'search text'</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="n">testGetKeywordStartWithOther</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'å¸®ææ¾'</span><span class="p">));</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'è¾å¼ç¾ææ æ'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ³è¦è¾å¼ç¾ææ æçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">([</span><span class="s1">'è¾å¼ç¾'</span><span class="p">,</span> <span class="s1">'æ'</span><span class="p">,</span> <span class="s1">'æ æ'</span><span class="p">],</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ³è¦è¾å¼ç¾ææ æçè¯'</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'ä¸ä¸'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸é¦ ä¸ä¸çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç§'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ç»ææ¥ä¸ä¸ªæç§çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æåé'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ç»ææ¥ä¸ä¸ª æåéçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç«'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ç»æä¸ä¸ªæç«çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç§'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'åè¯æä¸é¦æç§çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æµ·å­åå¾·ä»¤å'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ³è¦é£ä¸ªæµ·å­åå¾·ä»¤åçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æµ·å­ååæª'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ³è¦åªä¸ªæµ·å­ååæªçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'åè¯'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'å¸®ææ¾è·åè¯æå³çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'åè¯'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'å¸®ææ¾ä¸é¦åè¯çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡ææç½çè¯æ­'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç½'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡ææç½çå¤è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æç«'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸é¦æç«çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'æµ·å­'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡ææµ·å­çç°ä»£è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">([</span><span class="s1">'æç½ç'</span><span class="p">,</span> <span class="s1">'ç°ä»£'</span><span class="p">],</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡ææç½ç ç°ä»£ è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸ä¸ªå¸¦å¤©ç©ºçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸ä¸ªå¸¦æå¤©ç©ºçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸ä¸ªå«"å¤©ç©º"çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸ä¸ªåå«å¤©ç©ºçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸ä¸ªå«æå¤©ç©ºçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'èå£«æ¯äº'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡æèå£«æ¯äºçååè¡è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡æè·å¤©ç©ºç¸å³çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡æåå¤©ç©ºæå³çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'æ¥ä¸é¦åè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å®'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ç»ææ¥ä¸ä¸ªå®è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å®'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ç»ææ¥ä¸ªå®è¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">'å¤©ç©º'</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡æè·å¤©ç©ºç¸å³çè¯æ­'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ä¸é¦æ²¡æäººçè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'é£ä¸ªåç«è½¦çè¯'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'å¸®ææ¾'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡äºº'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡æäºº'</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">assertEquals</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nf">getKeyword</span><span class="p">(</span><span class="s1">'ææ²¡æè°è½åè¯æ'</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This part also took quite a bit of time. The final keyword extraction method is as follows:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * @param string $str
 * @param boolean $divide
 * @return string[]|string
 */</span>
<span class="k">function</span> <span class="n">getKeyword</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$divide</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$str</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nb">preg_replace</span><span class="p">(</span><span class="s1">'@[[:punct:]\n\rï½ï½ã\s]+@u'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="nv">$str</span><span class="p">));</span>
    <span class="nv">$keyword</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'@^(æç´¢??|search)(ä¸ä¸|ä¸æ|ä¸é¦|ä¸ä¸ª)??\s*?(?&lt;keyword&gt;.*)(ç?((å¤|ç°ä»£)?è¯æ­?|è¯))?$@Uu'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$keyword</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nb">preg_match</span><span class="p">(</span><span class="s1">'@^(ææ²¡æ??|åè¯æ|å¸®ææ¾|ææ³è¦|(ç»ææ¥|ç»æ|æ¥)|æç´¢?)(ä¸é¦|(ä¸|é£|åª)?ä¸ª|ä¸ä¸)??((å|è·|å¸¦|å?å«)æ??)??\s*?(?&lt;keyword&gt;.*)((æå³|ç¸å³)?ç?((ååè¡|åå­è¡|å¤|ç°ä»£)?è¯æ­?|è¯))$@Uu'</span><span class="p">,</span> <span class="nv">$str</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
        <span class="nv">$keyword</span> <span class="o">=</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">])</span> <span class="o">?</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="s1">'keyword'</span><span class="p">])</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// In some cases, word segmentation results may need to be returned</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$divide</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">Jieba</span><span class="o">::</span><span class="nf">cut</span><span class="p">(</span><span class="nv">$keyword</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">strstr</span><span class="p">(</span><span class="nv">$keyword</span><span class="p">,</span> <span class="s1">' '</span><span class="p">)</span>
        <span class="o">?</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="nv">$keyword</span><span class="p">)</span>
        <span class="o">:</span> <span class="nv">$keyword</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The Chinese word segmentation part uses <a href="https://github.com/fukuball/jieba-php">jieba-php</a>. The efficiency is not very high and memory usage is relatively large, but acceptable.</p>

<h3 id="using-wechaty-to-send-and-receive-messages">Using Wechaty to Send and Receive Messages</h3>

<p>In Wechaty, different <code class="language-plaintext highlighter-rouge">Puppet</code>s correspond to different protocols. Wechaty also has SDKs in different languages, as well as demo template repositories, very friendly to developers, with high developer participation.</p>

<p>Thanks to <code class="language-plaintext highlighter-rouge">beclass</code> who has already open-sourced a successful case, I didnât have to start from scratch, but made small code changes based on <a href="https://github.com/beclass/wxbot">beclass/wxbot</a>.</p>

<p><code class="language-plaintext highlighter-rouge">beclass</code>âs <a href="https://wechaty.github.io/2020/05/31/wxbot/">article</a> has already introduced the wxbot project. I wonât analyze wxbotâs code in detail below, just extract key parts.</p>

<p>First, you need to initialize a bot:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// create a Wechaty instance as bot</span>
<span class="kd">let</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Wechaty</span><span class="p">({</span>
  <span class="na">puppet</span><span class="p">:</span> <span class="k">new</span> <span class="nc">PuppetPadplus</span><span class="p">({</span>
    <span class="na">token</span><span class="p">:</span> <span class="nx">puppet_padplus_token</span>
  <span class="p">}),</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">poem</span><span class="dl">'</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Since the token applied for is for the iPad protocol, <code class="language-plaintext highlighter-rouge">PuppetPadplus</code> is used here.
Then bind event handler functions to the bot, where the <code class="language-plaintext highlighter-rouge">message</code> event is triggered when a message is received.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">scan</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">qrcode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// show the qrcode</span>
<span class="p">}).</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onLogin</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">bot</span><span class="p">))</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">friendship</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onFriendShip</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">room-join</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onRoomJoin</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">room-leave</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onRoomLeave</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">æºå¨æéï¼errorï¼</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">error</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">logout</span><span class="dl">'</span><span class="p">,</span> <span class="nx">onLogout</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">onMessage</code> is written in <code class="language-plaintext highlighter-rouge">server/robot/message</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nf">onMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Ignore messages from self</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">self</span><span class="p">())</span> <span class="k">return</span>

  <span class="c1">// Currently only handling text messages from group chats</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nf">type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Message</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">Text</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">room</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">text</span><span class="p">()</span>
    <span class="c1">// Message from group chat</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">mentionSelf</span><span class="p">())</span> <span class="p">{</span>  <span class="c1">// @ mentioned the bot</span>
        <span class="kd">let</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">msg</span><span class="p">.</span><span class="nf">to</span><span class="p">()</span>
        <span class="nb">self</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">@</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">self</span><span class="p">.</span><span class="nf">name</span><span class="p">()</span>
        <span class="kd">let</span> <span class="nx">receivedText</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="dl">""</span><span class="p">).</span><span class="nf">trim</span><span class="p">()</span>

        <span class="kd">let</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getPoemReply</span><span class="p">(</span><span class="nx">receivedText</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="c1">// Return message and @ the sender</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">poem</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">let</span> <span class="nx">poem</span> <span class="o">=</span> <span class="dl">"</span><span class="se">\n\n</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">content</span><span class="p">.</span><span class="nx">poem</span>
          <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">poem</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="k">from</span><span class="p">())</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="kd">const</span> <span class="nx">linkPayload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlLink</span><span class="p">({</span>
            <span class="na">description</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">ç¹å»æ¥çè¯»ç¡èè¯</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">thumbnailUrl</span><span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">.</span><span class="nx">cover_src</span><span class="p">,</span>
            <span class="na">title</span>       <span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
            <span class="na">url</span>         <span class="p">:</span> <span class="nx">content</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">wxPost</span><span class="p">.</span><span class="nx">link</span><span class="p">,</span>
          <span class="p">})</span>
          <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">linkPayload</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// Did not @ the bot</span>
        <span class="kd">const</span> <span class="nx">receivedText</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nf">trim</span><span class="p">()</span>
        <span class="c1">// Only process messages containing keywords</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nf">isSearchString</span><span class="p">(</span><span class="nx">receivedText</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">getPoemReply</span><span class="p">(</span><span class="nx">receivedText</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="nx">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">poem</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">isSearchString</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="sr">/^æ/</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">||</span> <span class="sr">/çè¯æ­</span><span class="se">?</span><span class="sr">$/</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
<span class="p">}</span>

<span class="cm">/**
 * @description Reply content
 * @param {String} info Received message
 * @return {Promise} Response content
 */</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nf">getPoemReply</span><span class="p">(</span><span class="nx">word</span><span class="p">,</span> <span class="nx">chatRoomId</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">POEMAPI_HOST</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/bot_search.php</span><span class="dl">'</span>
  <span class="kd">const</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">get</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">keyword</span><span class="p">:</span> <span class="nx">word</span><span class="p">,</span>
      <span class="na">chatroom</span><span class="p">:</span> <span class="nx">chatRoomId</span>
    <span class="p">},</span>
    <span class="na">encoding</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="na">timeout</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="p">{</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">data</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">urllib</span><span class="p">.</span><span class="nf">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">pkg</span><span class="p">)</span>

  <span class="k">if </span><span class="p">(</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="k">return</span> <span class="dl">'</span><span class="s1">ä¸å¥½ææï¼æåºæéäº.</span><span class="dl">'</span>

  <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nf">toString</span><span class="p">())</span>
  <span class="k">return</span> <span class="nx">data</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="launch">Launch</h2>

<p>For running in production environment, itâs recommended to use PM2.</p>

<p>Itâs also very simple to use. Add a configuration file <code class="language-plaintext highlighter-rouge">pm2.config.js</code></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">apps</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">wx-robot</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">script</span><span class="p">:</span> <span class="dl">"</span><span class="s2">./server/index.js</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">env</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">NODE_ENV</span><span class="p">:</span> <span class="dl">"</span><span class="s2">production</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then execute <code class="language-plaintext highlighter-rouge">pm2 start pm2.config.js</code> on the command line.
Combined with its monitoring panel service PM2+, you can not only control task running status in the browser, but also view real-time logs:</p>

<p><img src="/assets/2020/wechat-poem-robot/pm2.webp" alt="PM2" /></p>

<p>Goal achieved:</p>

<p><img src="/assets/2020/wechat-poem-robot/chat.webp" alt="chat" /></p>

<h2 id="conclusion-and-advertisement">Conclusion (<del>and Advertisement</del>)</h2>

<p>The part I think was most important during the development phase - matching keywords in various search sentence patterns - took a lot of time. I even considered using NL2SQL (Natural Language to SQL) technology. Actually, after going online, very few people used it. Most people still prefer to trigger the robot search with search+keyword. Although I was happy during the development process, itâs still quite sad that no one uses it.</p>

<p>Areas that can still be improved or expanded:</p>

<ol>
  <li>Use ElasticSearch instead of MySQL for search, perform word segmentation on poem content (for poem content, getting word segmentation correct is difficult), to make search results more accurate.</li>
  <li>Set the botâs function switches separately for different groups.</li>
  <li>Search results each time should be as different as possible.</li>
  <li>Famous line response mode: If a message is determined to be a famous line, the bot continues the next line.</li>
  <li>Flying flower order mode: Poem line relay.</li>
  <li>When patted, pat back.</li>
</ol>

<p>Such a common requirement as WeChat bots should have a simple approach. After excluding various unreliable solutions, I chose Wechaty.
Wechatyâs concise API can help developers quickly build a WeChat personal account bot. Developers who donât have time to tinker donât need to spend time trying other solutions.</p>

<h2 id="one-more-thing">One More Thing</h2>

<p>During the writing of this article, I kept thinking, what kind of technical blog post is good? Describing various details is certainly useful to other developers. But software is constantly changing, and these useful details may soon become inapplicable, instead becoming information noise in developersâ search processes.</p>

<p>Redis developer <a href="http://invece.org/">Salvatore Sanfilippo</a> said in <a href="http://antirez.com/news/129">this article</a></p>
<blockquote>
  <p>Sometimes I believe that software, while great, will never be huge like writing a book that will survive for centuries. Not because it is not as great per-se, but because as a side effect it is also usefulâ¦ and will be replaced when something more useful is around.</p>
</blockquote>

<p>In my view, good technical blog posts should not only have details, but also reflection on details and observation of the development process itself, trying to extract experiences that make the development process smoother. These experiences can even be extended to the handling of other daily affairs.</p>

<p>The internet produces and copies so many technical blog posts every day - how many can still inspire people after many years?</p>

<blockquote>
  <p>Author: <a href="https://github.com/ray7551/">ray7551</a></p>
</blockquote>

<hr />

<blockquote>
  <p>æ¬æä¹æ<a href="/2020/07/07/wechat-poem-robot/">ä¸­æçæ¬</a>ã</p>
</blockquote>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#padplus">padplus</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#wechat-robot">wechat-robot</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#regex">regex</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#regex101">regex101</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#featured">featured</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#entertainment">entertainment</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#ecosystem">ecosystem</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/ray7551">
                            <img class="rounded-circle" src="/assets/contributors/ray7551/avatar.webp" alt="ray7551" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by ray7551 <span><a target="_blank" href="https://twitter.com/ray7551" class="btn btn-outline-success btn-sm btn-round ml-2">Follow</a></span></h5>
						Coder.
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2020/07/06/wechat-calculator-bot/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2020/07-wechat-calculator-bot-en/header.webp">  å¾®ä¿¡è®¡ç®å¨æºå¨äººï¼wechat robot calculatorï¼</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2020/07/07/wechat-poem-robot/"> ç¨ Wechaty å®ç°å¾®ä¿¡è¯æ­æç´¢æºå¨äººï¼wechat poem robotï¼  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2020/wechat-poem-robot/chat.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright Â© <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
