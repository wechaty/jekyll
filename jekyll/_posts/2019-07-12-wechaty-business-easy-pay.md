---
title: "Wechaty - è®©çº¿ä¸Šæ²¡æœ‰éš¾åšçš„ç”Ÿæ„"
author: coderwhocode
categories: project
tags:
  - code
  - featured
  - ecommerce
image: /assets/2019/wechaty-pay-paypic.webp
hidden: true
---

## Wechaty - è®©çº¿ä¸Šæ²¡æœ‰éš¾åšçš„ç”Ÿæ„

### TLDR

æœ¬æ–‡ä¸»è¦é¢å¯¹æ²¡æœ‰è¥ä¸šæ‰§ç…§ï¼Œæƒ³ä½¿ç”¨å¾®ä¿¡æˆ–æ”¯ä»˜å®åœ¨çº¿æ”¶æ¬¾çš„ä¸­å°ä¼ä¸šæˆ–è€…ä¸ªäººå¼€å‘è€…ï¼Œæ—¥æ”¶å…¥åœ¨5Kä»¥ä¸‹ï¼ˆè èœç±»æˆ–è€…æƒ³å·ç¨Žè€…è¯·ç»•é“ï¼‰ã€‚

è‡ªä»Žä½¿ç”¨äº†Wechatyï¼Œèµ„é‡‘åŠæ—¶åˆ°è´¦ï¼Œæ”¶æ¬¾åŽç«‹å³é€šçŸ¥ã€‚å³å¼€å³ç”¨ï¼Œé«˜å¹¶å‘ï¼Œè¶…ç¨³å®šä¸æŽ‰å•ã€‚

![è®©çº¿ä¸Šæ²¡æœ‰éš¾åšçš„ç”Ÿæ„](/assets/2019/wechaty-pay-paypic.webp)

### èƒŒæ™¯

éšå¤„å¯è§å¾®ä¿¡å’Œæ”¯ä»˜å®çš„æ”¯ä»˜äºŒç»´ç ï¼Œå·²ç»è®©è¶…å¸‚æ°´æžœåº—å’Œç…Žé¥¼æžœå­æ‘Šè´©æ²¡æœ‰éš¾åšçš„ç”Ÿæ„ã€‚ç„¶è€Œåœ¨çº¿æ”¯ä»˜å¯å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚æŽ¥å£å¤§éƒ¨åˆ†éœ€è¦ä¼ä¸šèµ„è´¨è®¤è¯ï¼Œæˆ–è€…éœ€è¦å¤‡æ¡ˆåŸŸåä»¥åŠå¼€é€šæƒé™ï¼Œå¯¹äºŽä¸­å°åž‹å•†æˆ·é—¨æ§›éžå¸¸é«˜ã€‚å¤§éƒ¨åˆ†äººä¼šåœ¨æ”¶åˆ°æ¬¾åŽï¼Œæ‰‹åŠ¨ç¡®è®¤è®¢å•ï¼Œç»å¸¸å‡ºçŽ°è®¢å•å»¶è¯¯æˆ–è€…é—æ¼ã€‚ç„¶è€Œå¸‚é¢ä¸Šçš„è§£å†³æ–¹æ¡ˆéƒ½å·®å¼ºäººæ„ã€‚é‚£ä¹ˆè¿™ä¸ªçº¿ä¸Šæ”¯ä»˜çš„æµç¨‹å¦‚ä½•åˆ©ç”¨Wechatyä¼˜åŒ–ä¸€ä¸‹å‘¢ï¼Ÿ

![å„ç§æ”¯ä»˜æ–¹æ¡ˆå¯¹æ¯”](/assets/2019/wechaty-pay-paycompare.webp)

### æŠ€æœ¯å®žçŽ°

æ•´ä¸ªæ”¶æ¬¾è¿‡ç¨‹åˆ†ä¸º3æ­¥ï¼Œæ›´å¤šä¿¡æ¯å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ï¼š[WechatyPay](https://github.com/coderwhocode/wechaty-pay).

1. ç”¨æˆ·é€‰æ‹©æ”¯ä»˜é‡‘é¢åŽï¼Œä»˜æ¬¾é¡µé¢æ‰“å¼€å¯¹åº”çš„ä»˜æ¬¾ç ï¼ˆæ”¯ä»˜å®å¯è‡ªå®šä¹‰é‡‘é¢ï¼‰ï¼Œç”¨æˆ·æ‰«ç ä»˜æ¬¾
2. ç¡®è®¤æ”¶æ¬¾åŽï¼ˆ```onMessage```ï¼‰ï¼Œè·ŸåŽç«¯å‘é€å›žè°ƒæ”¶æ¬¾é‡‘é¢åŠæ”¶æ¬¾æ—¶é—´ï¼ˆ```sendPayment```ï¼‰
3. åŽå°æ ¹æ®é‡‘é¢ä»¥åŠæ—¶é—´ï¼ŒæŠŠå¯¹åº”çš„è®¢å•è‡ªåŠ¨æ ‡è®°

ä¸‹é¢çš„ä¾‹å­ä»¥ç¬¬2æ­¥ä¸ºä¾‹ï¼Œå¦‚ä½•åœ¨åŽå°ç¡®è®¤æ”¶æ¬¾ï¼Œä»¥åŠè·ŸåŽç«¯å‘é€å›žè°ƒã€‚

```ts
// Wechaty ç»å…¸å¯åŠ¨
const bot = new Wechaty()
bot.on('scan',    onScan)
bot.on('login',   onLogin)
bot.on('message', onMessage)
bot.start()

// å¾®ä¿¡æ”¶æ¬¾çš„æ¶ˆæ¯æç¤º
async function onMessage (msg) {
  if ( msg.type() !== bot.Message.Type.Attachment && !msg.self()
    || contact.name() !== 'å¾®ä¿¡æ”¯ä»˜') {
    return
  }
  const strs = msg.text().split('å…ƒ')
  if (strs.length >= 1) {
    const prices = strs[0].split('å¾®ä¿¡æ”¯ä»˜æ”¶æ¬¾')
    if (prices.length >= 1) {
      const priceStr = prices[1]
      sendPayment(parseFloat(priceStr), msg.date().getTime())
    }
  }
}

// æ”¶åˆ°é‡‘é¢ä¹‹åŽï¼Œè¿›è¡Œç¡®è®¤è®¢å•å›žè°ƒ
function sendPayment (priceAmount, timestamp) {
  const options = {
    method: 'POST',
    url: 'https://api.callbackaddress.com/api/admin/callback',
    headers: { 'content-type': 'application/json', 'token': 'XXXXXX'},
    body: {'amount': priceAmount, 'timestamp': timestamp },
    json: true
  };
  request(options, function (error, response, body) {
    if (error) throw new Error(error);
  });
}
```

æ”¯ä»˜å®é“ç†ç±»ä¼¼ï¼Œä¸è¿‡ç›®å‰äº§å“åŒ…è£…æ²¡æœ‰Wechatyè¿™ä¹ˆä¼˜ç§€çš„ä»£ç åº“ã€‚åŠè‡ªåŠ¨æ“ä½œå¦‚ä¸‹ï¼š

1. æ‰«ç ç™»å½•æ”¯ä»˜å®è´¦å·ï¼Œåœ¨Headersä¸­èŽ·å–Cookieã€‚æ“ä½œç±»ä¼¼äºŽ`bot.on('scan',    onScan)`
2. è½®è¯¢èŽ·å–è®¢å•åˆ—è¡¨ï¼Œå¦‚æžœæœ‰æ–°æ”¯ä»˜è®¢å•ï¼Œï¼Œè·ŸåŽç«¯å‘é€å›žè°ƒæ”¶æ¬¾é‡‘é¢åŠæ”¶æ¬¾æ—¶é—´ï¼ˆ```sendPayment```ï¼‰
3. ç”±äºŽæ­¤å¤„ä½¿ç”¨äº†è½®è¯¢çš„æ–¹å¼ï¼Œä¸ºäº†é˜²æ­¢é¢‘ç¹è®¿é—®è¢«æ”¯ä»˜å®é£ŽæŽ§ï¼Œä»…å½“æœ‰å¾…æ”¯ä»˜è®¢å•æ‰ä¼šé«˜é¢‘è®¿é—®è®¢å•æŽ¥å£ã€‚

### æ•ˆæžœé¢„è§ˆ

ç»ˆäºŽå¯ä»¥ä¸€ç«™å¼çš„ç®¡ç†æ‰€æœ‰å¾®ä¿¡å’Œæ”¯ä»˜å®çš„è®¢å•äº†ï¼æ¯ç¬”è®¢å•çš„æ—¶é—´ï¼Œé‡‘é¢ï¼Œè¿˜æœ‰æ¯å¤©æ”¶å…¥ç»Ÿè®¡ä¸€è§ˆæ— ä½™ã€‚

![åŽå°è®¢å•ç®¡ç†](/assets/2019/wechaty-pay-paymentsx.webp)

### äº§å“å®žçŽ°

å¦‚æžœè¿˜æ˜¯è§‰å¾—æ­¥éª¤æœ‰ç‚¹ç¹çï¼Ÿé‚£å¯ä»¥è¯•ä¸€ä¸‹è¿™æ¬¾åŸºäºŽæ¡”å­äº’åŠ¨çš„äº‘ç«¯æœåŠ¡å“¦ã€‚

* æ”¯æŒå¾®ä¿¡æ‰«ç æ‰˜ç®¡ï¼ˆåŸºäºŽæ¡”å­äº’åŠ¨æœåŠ¡ï¼‰
* æ”¯æŒæ”¯ä»˜å®æ‰«ç æ‰˜ç®¡
* ä¿éšœå®‰å…¨æ€§ï¼Œä¸è®°å½•ä¸ªäººè´¦æˆ·å¯†ç 
* èµ„é‡‘å®žæ—¶åˆ°è´¦ï¼Œä¸ç»è¿‡ç¬¬ä¸‰æ–¹

![æ¡”å­äº’åŠ¨](/assets/2019/wechaty-pay-botorange.webp)

ç»§ç»­äº¤æµæŠ€æœ¯äº§å“æŽ¢è®¨å¯ä»¥æ·»åŠ ðŸ‘‡å¾®ä¿¡ã€‚æœ¬æ–‡ä»…ä¾›æŠ€æœ¯äº§å“äº¤æµå‚è€ƒï¼Œå»ºè®®ä½¿ç”¨å®˜æ–¹è®¤è¯æŽ¥å£ã€‚è¯·å‹¿ä½¿ç”¨æ­¤é¡¹ç›®åšè¿åå¾®ä¿¡ã€æ”¯ä»˜å®è§„å®šæˆ–è€…å…¶ä»–è¿æ³•äº‹æƒ…ï¼

![å¾®ä¿¡](/assets/2019/wechaty-pay-wechat.webp)

> ä½œè€…: [Shawn](https://mugglepay.com)ï¼Œå…¨æ ˆåˆ›ä¸šç‹—ï¼Œè‡´åŠ›äºŽåˆ©ç”¨æŠ€æœ¯æå‡æ”¯ä»˜é¢†åŸŸæ•ˆçŽ‡ã€‚

---

> This post is also available in [English](/2019/07/12/wechaty-business-easy-pay-en/).
