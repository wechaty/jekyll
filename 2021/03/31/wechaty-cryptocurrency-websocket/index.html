<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      使用wechaty提醒加密货币行情 | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>使用wechaty提醒加密货币行情 | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="使用wechaty提醒加密货币行情" />
<meta name="author" content="r-hou" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Conversational RPA SDK for Chatbot Makers" />
<meta property="og:description" content="Conversational RPA SDK for Chatbot Makers" />
<link rel="canonical" href="https://wechaty.js.org/2021/03/31/wechaty-cryptocurrency-websocket/" />
<meta property="og:url" content="https://wechaty.js.org/2021/03/31/wechaty-cryptocurrency-websocket/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2021/03-wechaty-cryptocurrency-websocket/wechaty-btc.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-31T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2021/03-wechaty-cryptocurrency-websocket/wechaty-btc.webp" />
<meta property="twitter:title" content="使用wechaty提醒加密货币行情" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"r-hou"},"dateModified":"2021-03-31T00:00:00+00:00","datePublished":"2021-03-31T00:00:00+00:00","description":"Conversational RPA SDK for Chatbot Makers","headline":"使用wechaty提醒加密货币行情","image":"https://wechaty.js.org/assets/2021/03-wechaty-cryptocurrency-websocket/wechaty-btc.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2021/03/31/wechaty-cryptocurrency-websocket/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"r-hou"},"url":"https://wechaty.js.org/2021/03/31/wechaty-cryptocurrency-websocket/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#project">project</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">使用wechaty提醒加密货币行情</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/r-hou">
                            <img class="rounded-circle" src="/assets/contributors/r-hou/avatar.webp" alt="Hou Rui（侯睿）" width="70"/>
                          </a>
                        
						<small class="ml-3"> Hou Rui（侯睿） <span><a target="_blank" href="" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Mar 31, 2021 · <span class="reading-time">
  
  
    20 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2021/03-wechaty-cryptocurrency-websocket/wechaty-btc.webp" alt="使用wechaty提醒加密货币行情">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p><a href="https://wechaty.js.org"><img src="https://img.shields.io/badge/Powered%20By-Wechaty-brightgreen.svg" alt="Powered by Wechaty" /></a></p>

<p><a href="https://github.com/r-hou/wechaty-cryptocurrency-websocket"><img src="/assets/2021/03-wechaty-cryptocurrency-websocket/wechaty-btc.webp" alt="Wechaty-Cryptocurrency-Notification" /></a></p>

<!-- more -->
<p>从2020年3月份以来，加密货币市场随着疫情导致的全球大放水而飞速扩张，BTC的价格从低点$3800涨到了最高$60000， 十几倍的涨幅吸引了全球越来越多的个人和机构投资者参与到这个市场。 这个7x24小时的市场瞬息万变，上下几个点甚至几十个点的波动常常在十几分钟甚至几分钟之内就能完成，这么大的波动在给投资者带来丰厚回报的同时也伴随着巨大的风险。作为一名个人投资者，非常希望能够及时得到虚拟货币价格的变动情况而进行交易。</p>

<p>因此, 我非常希望建立一个自动化机器人，在行情波动巨大的时候及时发出提醒。目前，市面上有各种各样的接口提供了消息推送，比如钉钉，spark， IFTTT， telegram等等. 但是，每个人手机里各种各样的消息推送常常让人应接不暇。而微信，作为最广泛使用的聊天工具，鲜有人错过阅读微信消息。 所以，我打算通过微信机器人来进行消息推送。通过搜索，了解到目前市场的消息机器人有itchat， wxpy，wechaty等等。可是随着腾讯施加压力，基于web微信的itchat和wxpy无法使用。而wechaty支持多种协议，比web协议更加安全，于是决定采用wechaty基于ipad协议 ( padLocal ) 来搭建机器人。</p>

<p>让我们进入正题！</p>

<h2 id="环境和依赖">环境和依赖</h2>

<p>python
aiohttp
asyncio
wechaty</p>

<h2 id="wechaty-puppet-hostie部署">Wechaty Puppet Hostie部署</h2>

<p>因为原生的wechaty是基于JavaScript和TypeScript写的，所以需要通过docker搭建Wechaty Puppet Hostie 服务作为中转， 从而可以通过python调用。</p>

<ul>
  <li><strong>部署前置准备:</strong></li>
</ul>

<p>一个满足以下三点要求的服务器：</p>

<blockquote>
  <p>Public IP
Public Port
Docker</p>
</blockquote>

<ul>
  <li><strong>部署Wechaty Puppet Hostie</strong></li>
</ul>

<p>具体代码如下（本人服务器为 Ununtu 18.04）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /usr/bin/bash</span>

<span class="nb">export </span><span class="nv">WECHATY_LOG</span><span class="o">=</span><span class="s2">"verbose"</span>
<span class="nb">export </span><span class="nv">WECHATY_PUPPET</span><span class="o">=</span><span class="s2">"wechaty-puppet-padlocal"</span>
<span class="nb">export </span><span class="nv">WECHATY_PUPPET_PADLOCAL_TOKEN</span><span class="o">=</span><span class="s2">"puppet_padlocal</span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2">"</span>

<span class="nb">export </span><span class="nv">WECHATY_PUPPET_SERVER_PORT</span><span class="o">=</span><span class="s2">"9001"</span>
<span class="nb">export </span><span class="nv">WECHATY_TOKEN</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://www.uuidgenerator.net/api/version4<span class="si">)</span>
  <span class="nt">--name</span> wechaty_puppet_service_token_gateway <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_LOG <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_PUPPET <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_PUPPET_PADLOCAL_TOKEN <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_PUPPET_SERVER_PORT <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_TOKEN <span class="se">\</span>
  <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$WECHATY_PUPPET_SERVER_PORT</span><span class="s2">:</span><span class="nv">$WECHATY_PUPPET_SERVER_PORT</span><span class="s2">"</span> <span class="se">\</span>
  wechaty/wechaty
</code></pre></div></div>

<p>代码中的WECHATY_PUPPET_PADLOCAL_TOKEN是需要向官方申请，可以得到的一个可以试用7天的token，后续通过社区的激励计划，还可以免费获得时效更长的token。<a href="https://wechaty.js.org/docs/contributor-program/">详情参见这里</a>。</p>

<ul>
  <li><strong>验证Wechaty Puppet Hostie</strong></li>
</ul>

<p>访问 <a href="https://api.chatie.io/v0/hosties/WECHATY_TOKEN">https://api.chatie.io/v0/hosties/WECHATY_TOKEN</a> ，其中WECHATY_TOKEN是指你刚刚自行设定的Token，当返回结果为服务器的Public IP时则说明部署成功，为0.0.0.0时则说明部署失败~</p>

<h2 id="项目思路">项目思路</h2>

<p>搭建完中转服务，现在我们需要集中注意力在需求和机器人的搭建上面。市场行情数据来源于国内三大交易所之一<a href="https://binance.com/">币安</a>。为了获得更加及时的数据，我决定采用websocket来搭建我们的服务。关于机器人方面，我读了官方examples里面的代码发现机器人都是继承Wechaty基类来通过自定义回调函数来实现各种功能。利用事件驱动的回调函数这样是很被动的，而我想得到一个可直接调用的Wechaty对象，不通过start()函数进入事件循环监听, 而可以主动的发送信息。经过一天的阅读代码和自我摸索，终于实现了创建一个可以直接调用的机器人对象，稍后请参考详细代码，其中最重要的还是需要进入事件监听，然后在监听到成功登录的事件以后，中断监听，返回已经登录好的机器人对象， 从而实现直接调用。</p>

<p>首先我们建立Websocket基类, 并且建立HeartBeat类来定期执行某些任务，比如检查websocket连通性并断线重连等等。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#websocketAPI.py
</span>
<span class="kn">import</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">aiohttp</span>

<span class="k">class</span> <span class="nc">Websocket</span><span class="p">:</span>
    <span class="sh">"""</span><span class="s"> websocket接口封装
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">check_conn_interval</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">send_hb_interval</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 初始化
        @param url 建立websocket的地址
        @param check_conn_interval 检查websocket连接时间间隔
        @param send_hb_interval 发送心跳时间间隔，如果是0就不发送心跳消息
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_check_conn_interval</span> <span class="o">=</span> <span class="n">check_conn_interval</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_send_hb_interval</span> <span class="o">=</span> <span class="n">send_hb_interval</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ws</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># websocket连接对象
</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 初始化
        </span><span class="sh">"""</span>
        <span class="c1"># 注册服务 检查连接是否正常
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">注册服务 检查连接是否正常</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">heartbeat</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_check_connection</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_check_conn_interval</span><span class="p">)</span>
        <span class="c1"># 注册服务 发送心跳
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">注册服务 发送心跳</span><span class="sh">"</span><span class="p">)</span>
        <span class="c1"># 建立websocket连接
</span>        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">建立websocket连接</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_connect</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">url:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
        <span class="c1"># print("proxy:",proxy)
</span>        <span class="n">session</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="p">.</span><span class="nc">ClientSession</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ws</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">ws_connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">autoping</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c1"># print(self.ws)
</span>        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">ERROR:{},{}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="n">self</span><span class="p">.</span><span class="n">ws</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="p">.</span><span class="nf">ws_connect</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">autoping</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">client_exceptions</span><span class="p">.</span><span class="n">ClientConnectorError</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">connect to server error! url:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">connected_callback</span><span class="p">())</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">receive</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_reconnect</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 重新建立websocket连接
        </span><span class="sh">"""</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">reconnecting websocket right now!</span><span class="sh">"</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">_connect</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">connected_callback</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 连接建立成功的回调函数
        * NOTE: 子类继承实现
        </span><span class="sh">"""</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 接收消息
        </span><span class="sh">"""</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">WSMsgType</span><span class="p">.</span><span class="n">TEXT</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">data</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">process</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">WSMsgType</span><span class="p">.</span><span class="n">BINARY</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">process_binary</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">WSMsgType</span><span class="p">.</span><span class="n">CLOSED</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">receive event CLOSED:</span><span class="sh">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_reconnect</span><span class="p">())</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">WSMsgType</span><span class="p">.</span><span class="n">ERROR</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">receive event ERROR:</span><span class="sh">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">unhandled msg:</span><span class="sh">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 处理websocket上接收到的消息 text 类型
        * NOTE: 子类继承实现
        </span><span class="sh">"""</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_binary</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 处理websocket上接收到的消息 binary类型
        * NOTE: 子类继承实现
        </span><span class="sh">"""</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_check_connection</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 检查连接是否正常
        </span><span class="sh">"""</span>
        <span class="c1"># 检查websocket连接是否关闭，如果关闭，那么立即重连
</span>        <span class="c1"># print(self.ws)
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">websocket connection not connected yet!</span><span class="sh">"</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">_reconnect</span><span class="p">())</span>
            <span class="k">return</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_send_heartbeat_msg</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 发送心跳给服务器
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">websocket connection not connected yet!</span><span class="sh">"</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">:</span>
            <span class="k">if</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">.</span><span class="nf">send_json</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">ws</span><span class="p">.</span><span class="nf">send_str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">send heartbeat msg failed! heartbeat msg:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">send ping message:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">heartbeat_msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HeartBeat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> 心跳
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 心跳次数
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_interval</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 服务心跳执行时间间隔(秒)
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_print_interval</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># 心跳打印时间间隔(秒)，0为不打印
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># 跟随心跳执行的回调任务列表，由 self.register 注册 {task_id: {...}}
</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_count</span>

    <span class="k">def</span> <span class="nf">ticker</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 启动心跳， 每秒执行一次
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># 打印心跳次数
</span>        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_print_interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_count</span> <span class="o">%</span> <span class="n">self</span><span class="p">.</span><span class="n">_print_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">do server heartbeat, count:</span><span class="sh">"</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">_count</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

        <span class="c1"># 设置下一次心跳回调
</span>        <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">call_later</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_interval</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">ticker</span><span class="p">)</span>

        <span class="c1"># 执行任务回调
</span>        <span class="k">for</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tasks</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="sh">"</span><span class="s">interval</span><span class="sh">"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_count</span> <span class="o">%</span> <span class="n">interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="sh">"</span><span class="s">func</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="sh">"</span><span class="s">kwargs</span><span class="sh">"</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">task_id</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_id</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="sh">"</span><span class="s">heart_beat_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_count</span>
            <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 注册一个任务，在每次心跳的时候执行调用
        @param func 心跳的时候执行的函数
        @param interval 执行回调的时间间隔(秒)
        @return task_id 任务id
        </span><span class="sh">"""</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">"</span><span class="s">func</span><span class="sh">"</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">interval</span><span class="sh">"</span><span class="p">:</span> <span class="n">interval</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">args</span><span class="sh">"</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="sh">"</span><span class="s">kwargs</span><span class="sh">"</span><span class="p">:</span> <span class="n">kwargs</span>
        <span class="p">}</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="sh">"</span><span class="s">websocket_task</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">task_id</span>

    <span class="k">def</span> <span class="nf">unregister</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 注销一个任务
        @param task_id 任务id
        </span><span class="sh">"""</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_tasks</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_tasks</span><span class="p">.</span><span class="nf">pop</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

<span class="n">heartbeat</span> <span class="o">=</span> <span class="nc">HeartBeat</span><span class="p">()</span>

</code></pre></div></div>

<p>接着通过币安提供的websocket API来拉取行情。 因此我们新建一个Binance的子类来继承Websocket类，并且在Binance中实现机器人。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">traceback</span>
<span class="kn">import</span> <span class="n">aiohttp</span>

<span class="kn">from</span> <span class="n">wechaty</span> <span class="kn">import</span> <span class="n">Wechaty</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">WechatyPlugin</span><span class="p">,</span> <span class="n">Room</span><span class="p">,</span><span class="n">WechatyOptions</span>
<span class="kn">from</span> <span class="n">wechaty_puppet_service</span> <span class="kn">import</span> <span class="n">puppet</span>
<span class="kn">from</span> <span class="n">wechaty_puppet</span> <span class="kn">import</span> <span class="n">PuppetOptions</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">EventScanPayload</span><span class="p">,</span> <span class="n">ScanStatus</span><span class="p">,</span> <span class="n">EventLoginPayload</span>
<span class="kn">from</span> <span class="n">wechaty_puppet.schemas.room</span> <span class="kn">import</span> <span class="n">RoomQueryFilter</span>
<span class="kn">from</span> <span class="n">wechaty_puppet.schemas.contact</span> <span class="kn">import</span> <span class="n">ContactQueryFilter</span>

<span class="kn">from</span> <span class="n">websocketAPI</span> <span class="kn">import</span> <span class="n">heartbeat</span><span class="p">,</span> <span class="n">Websocket</span>
<span class="kn">import</span> <span class="n">logger</span>


<span class="n">WECHATY_PUPPET_SERVICE_TOKEN</span> <span class="o">=</span> <span class="sh">'</span><span class="s">acfbbe16-5f80-4a61-a755-85c27c3f5511</span><span class="sh">'</span>
<span class="n">WECHATY_PUPPET</span> <span class="o">=</span> <span class="sh">'</span><span class="s">wechaty-puppet-service</span><span class="sh">'</span>

<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WECHATY_PUPPET_SERVICE_TOKEN</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET_SERVICE_TOKEN</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WECHATY_PUPPET</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET</span>


<span class="k">class</span> <span class="nc">Binance</span><span class="p">(</span><span class="n">Websocket</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Binance 行情
    </span><span class="sh">"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">to_wechat_id</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_platform</span> <span class="o">=</span> <span class="sh">"</span><span class="s">BINANCE</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_url</span> <span class="o">=</span> <span class="sh">"</span><span class="s">wss://stream.binance.com:9443</span><span class="sh">"</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">BTC/USDT</span><span class="sh">'</span><span class="p">]</span>  <span class="c1">#可以在这里添加关心的交易对
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_channels</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">kline</span><span class="sh">'</span><span class="p">]</span> <span class="c1">#行情数据，提供kline，trade和orderbook三种行情
</span>        <span class="n">self</span><span class="p">.</span><span class="n">_c_to_s</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># {"channel": "symbol"}
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">to_wechat_id</span> <span class="o">=</span> <span class="n">to_wechat_id</span>  <span class="c1">#被发送人的微信id，也可以是群id，不过需要更改 self.send_notification函数
</span>        <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">:</span> <span class="n">Wechaty</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">run_until_complete</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">init_wechat_bot</span><span class="p">())</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_make_url</span><span class="p">()</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">Binance</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_url</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">initialize</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">volatility_threshold</span> <span class="o">=</span> <span class="mf">0.0001</span>  <span class="c1"># 波动大于 0.01%的时候发出提醒
</span>        <span class="n">self</span><span class="p">.</span><span class="n">kline_init</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">last_timestamp</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># 上一个event k线的timestamp
</span>        <span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># 当前event k线的timestamp
</span>        <span class="n">self</span><span class="p">.</span><span class="n">has_sent_notification</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># 判断当前k线是否已经发送了通知
</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">init_wechat_bot</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>  <span class="c1"># 在这个函数里面，我们初始化了可以直接调用的机器人对象
</span>        <span class="n">puppet_options</span> <span class="o">=</span> <span class="nc">PuppetOptions</span><span class="p">()</span>
        <span class="n">puppet_options</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET_SERVICE_TOKEN</span>

        <span class="n">options</span> <span class="o">=</span> <span class="nc">WechatyOptions</span><span class="p">()</span>
        <span class="n">options</span><span class="p">.</span><span class="n">puppet</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET</span>
        <span class="n">options</span><span class="p">.</span><span class="n">puppet_options</span> <span class="o">=</span> <span class="n">puppet_options</span>

        <span class="n">self</span><span class="p">.</span><span class="n">bot</span> <span class="o">=</span> <span class="nc">Wechaty</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="nf">init_puppet</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="nf">init_puppet_event_bridge</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="nf">_init_puppet</span><span class="p">()</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">puppet_stub</span><span class="p">.</span><span class="nf">event</span><span class="p">():</span> <span class="c1">#初始化puppet以后，进入事件监听
</span>            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">payload_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_SCAN</span><span class="p">):</span> <span class="c1"># 返回二维码事件
</span>                    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">'</span><span class="s">receive scan info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="c1"># create qr_code
</span>                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventScanPayload</span><span class="p">(</span>
                        <span class="n">status</span><span class="o">=</span><span class="nc">ScanStatus</span><span class="p">(</span><span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]),</span>
                        <span class="n">qrcode</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">qrcode</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">scan payload_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">scan</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_LOGIN</span><span class="p">):</span> <span class="c1"># 登录事件，在登录以后
</span>                    <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">'</span><span class="s">receive login info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">login payload_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">event_login_payload</span> <span class="o">=</span> <span class="nc">EventLoginPayload</span><span class="p">(</span>
                        <span class="n">contact_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">contactId</span><span class="sh">'</span><span class="p">])</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">login_user_id</span> <span class="o">=</span> <span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">contactId</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">login</span><span class="sh">'</span><span class="p">,</span> <span class="n">event_login_payload</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">contact</span> <span class="o">=</span> <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">Contact</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">to_wechat_id</span><span class="p">)</span>  <span class="c1"># 发送到联系人
</span>        <span class="k">if</span> <span class="n">contact</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">contact</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="c1"># room = await self.bot.Room.find(self.to_wechat_id)  # 发送到群
</span>        <span class="c1"># if room:
</span>        <span class="c1">#     await room.say(message)
</span>
    <span class="k">def</span> <span class="nf">_make_url</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 拼接请求url
        </span><span class="sh">"""</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="sh">"</span><span class="s">kline</span><span class="sh">"</span><span class="p">:</span>  <span class="c1"># 订阅K线 1分钟
</span>                <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_symbols</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_symbol_to_channel</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">kline_5m</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">cc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="sh">"</span><span class="s">orderbook</span><span class="sh">"</span><span class="p">:</span>  <span class="c1"># 订阅订单薄 深度为5
</span>                <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_symbols</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_symbol_to_channel</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">depth20</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">cc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="sh">"</span><span class="s">trade</span><span class="sh">"</span><span class="p">:</span>  <span class="c1"># 订阅实时交易
</span>                <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_symbols</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_symbol_to_channel</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">trade</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">cc</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">channel error! channel:</span><span class="sh">"</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_url</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">/stream?streams=</span><span class="sh">"</span> <span class="o">+</span> <span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> 处理websocket上接收到的消息
        </span><span class="sh">"""</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sh">"</span><span class="s">msg:</span><span class="sh">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nf">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">stream</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">_c_to_s</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="sh">"</span><span class="s">unkown channel, msg:</span><span class="sh">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">symbol</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_c_to_s</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">e</span><span class="sh">"</span><span class="p">)</span>  <span class="c1"># 事件名称
</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">==</span> <span class="sh">"</span><span class="s">kline</span><span class="sh">"</span><span class="p">:</span>  <span class="c1"># K线
</span>            <span class="n">kline</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">platform</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_platform</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">symbol</span><span class="sh">"</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">open</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">o</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 开盘价
</span>                <span class="sh">"</span><span class="s">high</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">h</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 最高价
</span>                <span class="sh">"</span><span class="s">low</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">l</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 最低价
</span>                <span class="sh">"</span><span class="s">close</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">c</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 收盘价
</span>                <span class="sh">"</span><span class="s">volume</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">q</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 交易量
</span>                <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">t</span><span class="sh">"</span><span class="p">),</span>  <span class="c1"># 时间戳
</span>                <span class="sh">"</span><span class="s">kline_type</span><span class="sh">"</span><span class="p">:</span> <span class="n">const</span><span class="p">.</span><span class="n">MARKET_TYPE_KLINE</span>
            <span class="p">}</span>
            <span class="c1"># print("symbol:", symbol, "kline:", kline)
</span>            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">symbol:</span><span class="sh">"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">kline:</span><span class="sh">"</span><span class="p">,</span> <span class="n">kline</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">channel</span><span class="p">.</span><span class="nf">endswith</span><span class="p">(</span><span class="sh">"</span><span class="s">depth20</span><span class="sh">"</span><span class="p">):</span>  <span class="c1"># 订单薄
</span>            <span class="n">bids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">asks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">bids</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">bids</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">bid</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ask</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">asks</span><span class="sh">"</span><span class="p">):</span>
                <span class="n">asks</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">ask</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">orderbook</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">platform</span><span class="sh">"</span><span class="p">:</span> <span class="n">BINANCE</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">symbol</span><span class="sh">"</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">asks</span><span class="sh">"</span><span class="p">:</span> <span class="n">asks</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">bids</span><span class="sh">"</span><span class="p">:</span> <span class="n">bids</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">:</span> <span class="n">tools</span><span class="p">.</span><span class="nf">get_cur_timestamp_ms</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">symbol:</span><span class="sh">"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">orderbook:</span><span class="sh">"</span><span class="p">,</span> <span class="n">orderbook</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">kline_init</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">last_timestamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">t</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">t</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">has_sent_notification</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span><span class="p">):</span> <span class="bp">False</span><span class="p">}</span>
                <span class="n">self</span><span class="p">.</span><span class="n">kline_init</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span> <span class="o">!=</span> <span class="n">self</span><span class="p">.</span><span class="n">last_timestamp</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">has_sent_notification</span> <span class="o">=</span> <span class="p">{</span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span><span class="p">):</span> <span class="bp">False</span><span class="p">}</span>

            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">symbol:</span><span class="sh">"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">kline:</span><span class="sh">"</span><span class="p">,</span> <span class="n">kline</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
            <span class="n">high</span><span class="p">,</span> <span class="n">low</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">h</span><span class="sh">"</span><span class="p">)),</span> <span class="nf">float</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">k</span><span class="sh">"</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">l</span><span class="sh">"</span><span class="p">))</span>
            <span class="n">volatility</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span><span class="o">-</span><span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="n">high</span>
            <span class="k">if</span> <span class="n">volatility</span> <span class="o">&gt;</span> <span class="n">self</span><span class="p">.</span><span class="n">volatility_threshold</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">has_sent_notification</span><span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span><span class="p">)]:</span>
                <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="nf">send_message</span><span class="p">(</span><span class="sh">"</span><span class="s">{} 5分钟内波幅达到{:.4f}%!</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">volatility</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
                <span class="n">self</span><span class="p">.</span><span class="n">has_sent_notification</span><span class="p">[</span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">current_timestamp</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">True</span>
            
        <span class="k">elif</span> <span class="n">e</span> <span class="o">==</span> <span class="sh">"</span><span class="s">trade</span><span class="sh">"</span><span class="p">:</span>  <span class="c1"># 实时成交信息
</span>            <span class="n">trade</span> <span class="o">=</span> <span class="p">{</span>
                <span class="sh">"</span><span class="s">platform</span><span class="sh">"</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">_platform</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">symbol</span><span class="sh">"</span><span class="p">:</span> <span class="n">symbol</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">action</span><span class="sh">"</span><span class="p">:</span>  <span class="n">ORDER_ACTION_SELL</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="sh">"</span><span class="s">m</span><span class="sh">"</span><span class="p">]</span> <span class="k">else</span> <span class="n">ORDER_ACTION_BUY</span><span class="p">,</span>
                <span class="sh">"</span><span class="s">price</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">p</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">quantity</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">q</span><span class="sh">"</span><span class="p">),</span>
                <span class="sh">"</span><span class="s">timestamp</span><span class="sh">"</span><span class="p">:</span> <span class="n">data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">"</span><span class="s">T</span><span class="sh">"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">symbol:</span><span class="sh">"</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="sh">"</span><span class="s">trade:</span><span class="sh">"</span><span class="p">,</span> <span class="n">trade</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sh">"</span><span class="s">event error! msg:</span><span class="sh">"</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="n">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_symbol_to_channel</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">channel_type</span><span class="o">=</span><span class="sh">"</span><span class="s">ticker</span><span class="sh">"</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s"> symbol转换到channel
        @param symbol symbol名字
        @param channel_type 频道类型 kline K线 / ticker 行情
        </span><span class="sh">"""</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="sh">"</span><span class="s">{x}@{y}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">symbol</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">,</span> <span class="sh">""</span><span class="p">).</span><span class="nf">lower</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">channel_type</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_c_to_s</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol</span>
        <span class="k">return</span> <span class="n">channel</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">binance_websocket</span> <span class="o">=</span> <span class="nc">Binance</span><span class="p">(</span><span class="n">to_wechat_id</span><span class="o">=</span><span class="sh">'</span><span class="s">文件传输助手</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">()</span>
    <span class="c1"># loop.call_later(2, heartbeat.ticker)
</span>    <span class="n">loop</span><span class="p">.</span><span class="nf">run_forever</span><span class="p">()</span>
</code></pre></div></div>

<p>至此我们的加密货币波动提醒机器人基本框架已经搭好，如果感兴趣的话，大家可以通过搭配k线事件，trade事件和orderbook事件形成新的信号提醒，也可以做各种量化交易提醒。</p>

<h2 id="运行效果">运行效果</h2>

<p><img src="/assets/2021/03-wechaty-cryptocurrency-websocket/result.webp" alt="效果" /></p>

<h2 id="感谢">感谢</h2>

<p>在最后我们要感谢所有为我们提供工具和服务的团队和个人。特别感谢开源项目<a href="https://github.com/wechaty/wechaty">Wechaty</a>团队和免费提供服务的padLocal团队。</p>

<blockquote>
  <p>作者: <a href="https://github.com/r-hou">r-hou</a>，学生，加密货币爱好者。</p>
</blockquote>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#python">python</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#cryptocurrency">cryptocurrency</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#binance">binance</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#devops">devops</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/r-hou">
                            <img class="rounded-circle" src="/assets/contributors/r-hou/avatar.webp" alt="Hou Rui（侯睿）" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by Hou Rui（侯睿） </h5>
						一个喜欢写代码的物理系学生。
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2021/03/27/rcs-messaging-chatbot/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2021/03-rcs-messaging-chatbot/rcs-bot.webp">  RCS Messaging Chatbot</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2021/04/01/wechat-group-cryptocurrency-robot/"> 微信群中的加密货币报价机器人  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2021/04-wechat-group-cryptocurrency-robot/header.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright © <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
