<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      Announcing Wechaty Puppet WXKF | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Announcing Wechaty Puppet WXKF | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Announcing Wechaty Puppet WXKF" />
<meta name="author" content="wang-nan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We are excited to introduce wechaty-puppet-wxkf, a new, fully open-source puppet based on the official WeChat Customer Service API. This puppet runs locally, does not depend on external services, and offers robust features for managing customer interactions." />
<meta property="og:description" content="We are excited to introduce wechaty-puppet-wxkf, a new, fully open-source puppet based on the official WeChat Customer Service API. This puppet runs locally, does not depend on external services, and offers robust features for managing customer interactions." />
<link rel="canonical" href="https://wechaty.js.org/2023/04/23/introducing-wechaty-puppet-wxkf-en/" />
<meta property="og:url" content="https://wechaty.js.org/2023/04/23/introducing-wechaty-puppet-wxkf-en/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2023/04-introducing-wechaty-puppet-wxkf-en/logo.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2023/04-introducing-wechaty-puppet-wxkf-en/logo.webp" />
<meta property="twitter:title" content="Announcing Wechaty Puppet WXKF" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"wang-nan"},"dateModified":"2023-04-23T00:00:00+00:00","datePublished":"2023-04-23T00:00:00+00:00","description":"We are excited to introduce wechaty-puppet-wxkf, a new, fully open-source puppet based on the official WeChat Customer Service API. This puppet runs locally, does not depend on external services, and offers robust features for managing customer interactions.","headline":"Announcing Wechaty Puppet WXKF","image":"https://wechaty.js.org/assets/2023/04-introducing-wechaty-puppet-wxkf-en/logo.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2023/04/23/introducing-wechaty-puppet-wxkf-en/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"wang-nan"},"url":"https://wechaty.js.org/2023/04/23/introducing-wechaty-puppet-wxkf-en/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#announcement">announcement</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">Announcing Wechaty Puppet WXKF</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/wang-nan">
                            <img class="rounded-circle" src="/assets/contributors/wang-nan/avatar.webp" alt="Wang-Nan" width="70"/>
                          </a>
                        
						<small class="ml-3"> Wang-Nan <span><a target="_blank" href="https://twitter.com/brotherstyx" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Apr 23, 2023 · <span class="reading-time">
  
  
    12 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/logo.webp" alt="Announcing Wechaty Puppet WXKF">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p>To the Wechaty community, we at <a href="https://www.juzibot.com">Juzi Interactive (句子互动)</a> are excited to bring you a brand-new puppet, <a href="https://github.com/juzibot/wechaty-puppet-wxkf">wechaty-puppet-wxkf</a>, based on the official WeChat Customer Service API. This puppet runs locally, does not rely on any external services, and is completely open-source.</p>

<p>WeChat Customer Service is a tool created by the Tencent WeChat team for businesses to meet their customer service needs and help them provide excellent support. Businesses can integrate WeChat Customer Service across various scenarios, both inside and outside of WeChat. Users can initiate inquiries, and businesses can send and receive messages via the API.</p>

<p>After configuring WeChat Customer Service in the Wework backend, it can be managed in three ways: through self-built applications, third-party applications, or service provider development. Currently, <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> supports the self-built application and service provider development methods.</p>

<p>WeChat Customer Service messages are received by pulling new messages after the Wework backend application receives a callback. Therefore, ideally, there should be a callback center to distribute various callbacks to the application, which then distributes them to different puppet instances. For this purpose, we have also launched a callback management service for WeChat Customer Service, WXKF-manager. <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> supports both standalone use and use in conjunction with the manager.</p>

<h2 id="using-wechaty-puppet-wxkf-standalone">Using <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> Standalone</h2>

<p><img src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/structure-1.webp" alt="structure-1.webp" /></p>

<h3 id="installing-dependencies">Installing Dependencies</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>wechaty
npm <span class="nb">install </span>wechaty-puppet-wxkf
</code></pre></div></div>

<p>Note that <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> requires Wechaty version 1.0 or higher to run.</p>

<h3 id="configuring-environment-variables">Configuring Environment Variables</h3>

<p>Unlike most traditional puppets, <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> cannot be logged in by scanning a QR code. You need to pass some configuration through environment variables or when creating a new puppet instance to log in successfully. If the same variable is set in both environment variables and the configuration, the configuration item will take precedence.</p>

<p>This will be discussed further in subsequent sections.</p>

<h3 id="starting-a-ding-dong-bot">Starting a Ding-Dong Bot</h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">WechatyBuilder</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">wechaty</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">PuppetWxkf</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">wechaty-puppet-wxkf</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">WechatyBuilder</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span>
  <span class="na">puppet</span><span class="p">:</span> <span class="k">new</span> <span class="nc">PuppetWxkf</span><span class="p">()</span>
<span class="p">});</span>

<span class="nx">bot</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ding</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">message</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="dl">'</span><span class="s1">dong</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">bot</span><span class="p">.</span><span class="nf">start</span><span class="p">();</span>
</code></pre></div></div>

<h3 id="authentication">Authentication</h3>

<h4 id="how-to-obtain-identity-information">How to Obtain Identity Information</h4>

<p>As mentioned earlier and as shown in the ding-dong bot example, <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> does not generate a <code class="language-plaintext highlighter-rouge">scan</code> event, so it cannot be logged in by scanning a QR code. This is not a mistake. Logging into WeChat Customer Service is done using the “WeChat Customer Service” application in Wework. You can manage the WeChat Customer Service application in your enterprise’s backend.</p>

<p><img src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/app-1.webp" alt="app-1.webp" /></p>

<p>Scroll to the bottom of the page, and you will see that WeChat Customer Service can be managed by API in three ways: self-built applications, third-party applications, and service provider development. Currently, <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code> supports the self-built application and service provider development methods.</p>

<p><img src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/app-2.webp" alt="app-2.webp" /></p>

<p>If you need to manage a WeChat Customer Service account, the steps are as follows:</p>

<ul>
  <li>Create a new WeChat Customer Service account on the WeChat Customer Service application management page, giving it a name (<code class="language-plaintext highlighter-rouge">name</code>) and an avatar.
Note: You can distinguish accounts by <code class="language-plaintext highlighter-rouge">name</code> or <code class="language-plaintext highlighter-rouge">kfId</code>. <code class="language-plaintext highlighter-rouge">kfId</code> is preferred. If you want to distinguish accounts by <code class="language-plaintext highlighter-rouge">kfId</code>, remember to give them unique names.</li>
  <li>Assign the WeChat Customer Service account to the enterprise application you are developing. You can do this by clicking on “Self-built Application” or “Service Provider Development” at the bottom of the page.</li>
  <li>Obtain the <code class="language-plaintext highlighter-rouge">token</code> and <code class="language-plaintext highlighter-rouge">encodingAesKey</code>. These two values will be used to parse Wework callbacks.
If you are developing a self-built application, you can find them on the Wework Customer Service application page by clicking “API” and then “Settings.”
<img src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/app-3.webp" alt="app-3.webp" />
If you are a service provider developer, you should be able to find the corresponding values in your service provider management backend.</li>
  <li>Configure the callback address. You can deploy this puppet separately, but a better way is to use a service to receive and distribute all WeChat Customer Service-related callbacks. You can use our WXKF-Manager project or design this service yourself.</li>
  <li>Obtain the <code class="language-plaintext highlighter-rouge">secret</code> and <code class="language-plaintext highlighter-rouge">corpId</code>. These values will be used to get the <code class="language-plaintext highlighter-rouge">accessToken</code>, which is then used to call the APIs provided by Wework.
If you are a self-built application developer, you can click “View” in the image above, and the <code class="language-plaintext highlighter-rouge">secret</code> will be sent to your phone. Your <code class="language-plaintext highlighter-rouge">corpId</code> can be found in the “My Company” tab of the Wework management backend.
If you are a service provider application developer, this information will be sent to the callback address configured for your application. Please refer to the relevant sections of the <a href="https://developer.work.weixin.qq.com/document/path/97163">official Tencent API documentation</a> for more information.</li>
  <li>You also need to set a <code class="language-plaintext highlighter-rouge">port</code>. The puppet will create a web service and receive callbacks on the specified port.</li>
</ul>

<h4 id="how-to-configure-identity-information">How to Configure Identity Information</h4>

<ul>
  <li>
    <p>By Passing it to the Puppet Instance</p>

    <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">WechatyBuilder</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span>
  <span class="na">puppet</span><span class="p">:</span> <span class="k">new</span> <span class="nc">PuppetWxkf</span><span class="p">({</span>
    <span class="na">callbackPort</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
    <span class="na">wxkfAuth</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">token</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">encodingAESKey</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">encodingAESKey</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">corpId</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">corpId</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">corpSecret</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">secret</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">kfOpenId</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">kfId</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="c1">// either of these two keys</span>
      <span class="na">kfName</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">kfName</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="c1">// is good enough</span>
    <span class="p">},</span>
  <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Through Environment Variables</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PUPPET_WXKF_WECOM_APP_TOKEN</span><span class="o">=</span><span class="k">${</span><span class="nv">token</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">PUPPET_WXKF_WECOM_APP_AES_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">encodingAESKey</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">PUPPET_WXKF_WECOM_CORP_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">corpId</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">PUPPET_WXKF_WECOM_CORP_SECRET</span><span class="o">=</span><span class="k">${</span><span class="nv">secret</span><span class="k">}</span>

<span class="nb">export </span><span class="nv">PUPPET_WXKF_WECOM_KF_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">name</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">PUPPET_WXKF_WECOM_KF_OPEN_ID</span><span class="o">=</span><span class="k">${</span><span class="nv">kfId</span><span class="k">}</span>
<span class="nb">export </span><span class="nv">PUPPET_WXKF_CALLBACK_PORT</span><span class="o">=</span>8080
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="configuring-object-storage-service-oss">Configuring Object Storage Service (OSS)</h4>

<p>An Object Storage Service is not mandatory. For <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code>, most functions can be used without configuring it. However, the key issue is that the cover images for Mini Programs cannot be transmitted. Here’s why.</p>

<p>The payload for a Mini Program in Wechaty is defined as follows:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">MiniProgramPayload</span> <span class="p">{</span>
    <span class="nl">appid</span><span class="p">?</span>       <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, appid, get from wechat (mp.weixin.qq.com)</span>
    <span class="nx">description</span><span class="p">?</span> <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, mini program title</span>
    <span class="nx">pagePath</span><span class="p">?</span>    <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, mini program page path</span>
    <span class="nx">iconUrl</span><span class="p">?</span>     <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, mini program icon url</span>
    <span class="nx">shareId</span><span class="p">?</span>     <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, the unique userId for who share this mini program</span>
    <span class="nx">thumbUrl</span><span class="p">?</span>    <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, default picture, convert to thumbnail</span>
    <span class="nx">title</span><span class="p">?</span>       <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// optional, mini program title</span>
    <span class="nx">username</span><span class="p">?</span>    <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// original ID, get from wechat (mp.weixin.qq.com)</span>
    <span class="nx">thumbKey</span><span class="p">?</span>    <span class="p">:</span> <span class="kr">string</span><span class="p">,</span>   <span class="c1">// original, thumbnailurl and thumbkey will make the headphoto of mini-program better</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Please note that the icon and cover image are in the form of a URL, not the more recent payload format that uses a FileBox JSON string. This means that these two images must be accessible via a URL to be transmitted. The situation is similar for the cover images of web links, but fortunately, Wework Customer Service directly provides an accessible plain-text URL for web link cover images, so only Mini Programs are affected.</p>

<p>We currently support OSS types including S3, Ali, Minio, Tos, and Cos. You can refer to <code class="language-plaintext highlighter-rouge">src/util/env.ts</code> to see how to configure them.</p>

<h2 id="using-with-wxkf-manager">Using with WXKF-Manager</h2>

<h3 id="why-do-you-need-a-manager">Why Do You Need a Manager?</h3>

<p>Whether it’s a self-built application or a service provider-developed application, a Wework application may have many responsibilities, with WeChat Customer Service being just one of them, such as handling organizational structure changes, tag changes, and so on. Since an application can only have one callback address configured within a company, a service is needed to distribute callbacks based on the event type.</p>

<p>To use WXKF-Manager, you need to add two environment variables to the puppet: <code class="language-plaintext highlighter-rouge">PUPPET_WXKF_MANAGER_CENTER_ENDPOINT</code> and <code class="language-plaintext highlighter-rouge">PUPPET_WXKF_SELF_ENDPOINT</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">PUPPET_WXKF_MANAGER_CENTER_ENDPOINT</span><span class="o">=</span>http://127.0.0.1:7777
<span class="nb">export </span><span class="nv">PUPPET_WXKF_SELF_ENDPOINT</span><span class="o">=</span>http://127.0.0.1:8080
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">PUPPET_WXKF_MANAGER_CENTER_ENDPOINT</code> is the address of WXKF-Manager, and the puppet will actively register with it using its <code class="language-plaintext highlighter-rouge">kfId</code>. <code class="language-plaintext highlighter-rouge">PUPPET_WXKF_SELF_ENDPOINT</code> is the address of the puppet’s own callback service. When WXKF-Manager receives a callback, it will find the corresponding puppet based on the callback content and call the puppet’s callback service.</p>

<h3 id="architecture-diagram">Architecture Diagram</h3>

<p><img src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/structure-3.webp" alt="structure-3.webp" /></p>

<h3 id="how-to-use">How to Use</h3>

<ul>
  <li>It relies on a MongoDB to store registered puppet information.</li>
  <li>A typical deployment method is to package this project into a Docker image and deploy it in a container.</li>
</ul>

<h3 id="environment-variable-configuration">Environment Variable Configuration</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">MONGO_URI</span><span class="o">=</span>mongodb://127.0.0.1:27017/wxkf-manager
<span class="nb">export </span><span class="nv">PORT</span><span class="o">=</span>7777
<span class="c"># export ACCESS_TOKEN_URL=https://127.0.0.1:8888/api/corp/accessToken</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">MONGO_URI</code>: The address of the MongoDB.</li>
  <li><code class="language-plaintext highlighter-rouge">PORT</code>: The port on which the WXKF-Manager service listens.</li>
  <li><code class="language-plaintext highlighter-rouge">ACCESS_TOKEN_URL</code>: This is an optional variable. Because the interface for directly obtaining an <code class="language-plaintext highlighter-rouge">accessToken</code> from Wework has call frequency limits, the ideal approach is to use another service to call, refresh, and cache the <code class="language-plaintext highlighter-rouge">accessToken</code>. The implementation of this interface should be consistent with the Wework documentation.</li>
</ul>

<p>Note: When decrypting Wework callbacks, we will need the <code class="language-plaintext highlighter-rouge">aesEncodingKey</code> and <code class="language-plaintext highlighter-rouge">token</code> mentioned earlier. In WXKF-Manager, these two values do not come from the configuration but from the registered puppet. Therefore, if you need WXKF-Manager to receive callbacks directly, a corresponding puppet must be registered before the configuration can be successful.</p>

<h3 id="best-practices">Best Practices</h3>

<p>Although the architecture shown above can work, it is not the best practice. As mentioned earlier, a Wework application may have many responsibilities, and WeChat Customer Service is just one of them. Therefore, it is best to have a dedicated callback service to receive and distribute all Wework callbacks. Also, since the interface for obtaining an <code class="language-plaintext highlighter-rouge">accessToken</code> from Wework has call frequency limits, the ideal approach is to use another service to call, refresh, and cache the <code class="language-plaintext highlighter-rouge">accessToken</code>. The implementation of this interface should be consistent with the Wework documentation. Thus, the most ideal architecture is as follows.</p>

<p><img src="/assets/2023/04-introducing-wechaty-puppet-wxkf-en/structure-2.webp" alt="structure-2.webp" /></p>

<p>In this architecture, WXKF-Manager no longer receives Wework callbacks directly but through a Gateway service for reception and distribution. The Wework callback address can be configured as <code class="language-plaintext highlighter-rouge">http://www.example.com/callback/{corpId}</code>. Its database stores the corresponding company’s <code class="language-plaintext highlighter-rouge">aesEncodingKey</code> and <code class="language-plaintext highlighter-rouge">token</code>, so it can decrypt the callback information.</p>

<p>When a callback of type <code class="language-plaintext highlighter-rouge">kf_msg_or_event</code> is received, it should call the WXKF-Manager’s interface to have WXKF-Manager assign this callback to a specific puppet.</p>

<p>This callback process can be done either in plain-text JSON format or in ciphertext, i.e., by directly forwarding the information from Wework. For example:</p>

<p>Plain text:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">PUPPET_WXKF_MANAGER_CENTER_ENDPOINT</span><span class="p">}</span><span class="s2">/callback/decrypted/</span><span class="p">${</span><span class="nx">corpId</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

<span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">token</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxx</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// this token is not the token of wecom corp app, it is the token for sync messages. see https://kf.weixin.qq.com/api/doc/path/94745</span>
  <span class="na">openKfId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxx</span><span class="dl">'</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Ciphertext:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">PUPPET_WXKF_MANAGER_ENDPOINT</span><span class="p">}</span><span class="s2">/callback/</span><span class="p">${</span><span class="nx">corpId</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

<span class="nx">axios</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">xmlString</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// xmlString is the raw crypted message directly from wecom callback body</span>
  <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">Content-type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">text/xml</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="feedback-and-suggestions">Feedback and Suggestions</h2>

<p>For feedback on <code class="language-plaintext highlighter-rouge">wechaty-puppet-wxkf</code>, please submit an issue <a href="https://github.com/juzibot/wechaty-puppet-wxkf/issues">here</a>.</p>

<p>For feedback on <code class="language-plaintext highlighter-rouge">WXKF-Manager</code>, please submit an issue <a href="https://github.com/juzibot/wxkf-manager/issues">here</a>.</p>

<h2 id="final-words">Final Words</h2>

<p>The prosperity of a community depends on the contributions of its members. Thank you to all the members of the Wechaty community. It is your enthusiasm and support that allow us to continuously step out of our comfort zone and develop new products. Your feedback and suggestions also give us more insights and experience in puppet development, helping us create better products.</p>

<p>We at <a href="https://www.juzibot.com">Juzi Interactive (句子互动)</a> will continue to support the Wechaty community and contribute to the prosperity of the open-source community. We look forward to seeing you next time.</p>

<blockquote>
  <p>This post is also available in <a href="/2023/04/23/introducing-wechaty-puppet-wxkf/">Chinese (Simplified)</a>.</p>
</blockquote>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#news">news</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#puppet">puppet</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#wxkf">wxkf</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#juzi">juzi</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/wang-nan">
                            <img class="rounded-circle" src="/assets/contributors/wang-nan/avatar.webp" alt="Wang-Nan" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by Wang-Nan <span><a target="_blank" href="https://twitter.com/brotherstyx" class="btn btn-outline-success btn-sm btn-round ml-2">Follow</a></span></h5>
						Just another coder.
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2023/04/13/use-chatgpt-develop-a-conference-assistant/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2023/04-use-chatgpt-develop-a-conference-assistant-en/rare-book.webp">  10分钟使用ChatGPT&Wechaty开发一个群会议助手</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2023/04/23/introducing-wechaty-puppet-wxkf/"> Wechaty Puppet WXKF 发布公告  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2023/04-introducing-wechaty-puppet-wxkf/logo.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright © <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
