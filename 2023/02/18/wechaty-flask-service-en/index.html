<!DOCTYPE html>
<html lang="en">
<head>
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PD2PL84');</script>
<!-- End Jekyll GTM tag v1.0.3 -->


    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    

    <title>
      Building a Message Notification Service with Wechaty and Flask | Wechaty
    </title>

    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Building a Message Notification Service with Wechaty and Flask | Wechaty</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Building a Message Notification Service with Wechaty and Flask" />
<meta name="author" content="houruirui" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Learn how to build a WeChat message notification service using Wechaty and Flask, enabling proactive message sending and multi-service notifications through a single WeChat account with the PadLocal protocol." />
<meta property="og:description" content="Learn how to build a WeChat message notification service using Wechaty and Flask, enabling proactive message sending and multi-service notifications through a single WeChat account with the PadLocal protocol." />
<link rel="canonical" href="https://wechaty.js.org/2023/02/18/wechaty-flask-service-en/" />
<meta property="og:url" content="https://wechaty.js.org/2023/02/18/wechaty-flask-service-en/" />
<meta property="og:site_name" content="Wechaty" />
<meta property="og:image" content="https://wechaty.js.org/assets/2023/02-wechaty-flask-service-en/wechaty.webp" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-02-18T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wechaty.js.org/assets/2023/02-wechaty-flask-service-en/wechaty.webp" />
<meta property="twitter:title" content="Building a Message Notification Service with Wechaty and Flask" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"houruirui"},"dateModified":"2023-02-18T00:00:00+00:00","datePublished":"2023-02-18T00:00:00+00:00","description":"Learn how to build a WeChat message notification service using Wechaty and Flask, enabling proactive message sending and multi-service notifications through a single WeChat account with the PadLocal protocol.","headline":"Building a Message Notification Service with Wechaty and Flask","image":"https://wechaty.js.org/assets/2023/02-wechaty-flask-service-en/wechaty.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://wechaty.js.org/2023/02/18/wechaty-flask-service-en/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://wechaty.js.org/assets/images/logo.png"},"name":"houruirui"},"url":"https://wechaty.js.org/2023/02/18/wechaty-flask-service-en/"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico">

    <link rel="manifest" href="/manifest.json">

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://s3.pstatp.com/cdn/expire-1-M/font-awesome/5.3.1/css/all.css" crossorigin="anonymous">

    <!-- Google Fonts in China Thanks @crossly @sidny -->
    <link href="https://fonts.loli.net/css?family=Lora" rel="stylesheet">

    <!-- Bootstrap Modified -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- Theme Stylesheet -->
    <link rel="stylesheet" href="/assets/css/theme.css">

    <!-- Highlight Stylesheet -->
    <link rel="stylesheet" href="/assets/css/highlight.css">

    <!-- Jquery on header to make sure everything works, the rest  of the scripts in footer for fast loading -->
    <script
    src="https://s0.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>

</head>

<body class="">
    <!-- https://github.com/t-richards/jekyll-google-tag-manager -->
    <!-- Begin Jekyll GTM tag v1.0.3 (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PD2PL84"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Jekyll GTM tag v1.0.3 (noscript) -->


    <!-- Navbar -->
    <nav id="MagicMenu" class="topnav navbar navbar-expand-lg navbar-light bg-white fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/"><strong>Wechaty</strong></a>
        <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarColor02" aria-controls="navbarColor02" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-collapse collapse" id="navbarColor02">
            <ul class="navbar-nav mr-auto d-flex align-items-center">
               <!--  Replace menu links here -->

<li class="nav-item">
  <a class="nav-link" href="/news/">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/blog/">Blog</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/docs/">Docs</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="/contributors/">Contributors</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/PMC#wechaty-committers" target="_blank">Talks</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="https://github.com/wechaty/wechaty#readme" target="_blank">GitHub</a>
</li>


            </ul>
            <ul class="navbar-nav ml-auto d-flex align-items-center">
                <li class="nav-item">
                  <a class="nav-link" href="/search/">Search</a>
                </li>
            </ul>
        </div>
    </div>
    </nav>

  <!-- Search results moved to a dedicated /search page -->

    <!-- Content -->
    <main role="main" class="site-content">
        

<div class="container">
<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="row  justify-content-between ">
				<div class=" col-md-6  pr-0 pr-md-4 pt-4 pb-4 align-self-center">
					<p class="text-uppercase font-weight-bold">
            <span class="catlist">

            
              <a class="sscroll text-danger" href="/categories.html#project">project</a><span class="sep">, </span>
            

            </span>
					</p>
					<h1 class="display-4 mb-4 article-headline">Building a Message Notification Service with Wechaty and Flask</h1>
					<div class="d-flex align-items-center">
                        
                          <a href="/contributors/houruirui">
                            <img class="rounded-circle" src="/assets/contributors/houruirui/avatar.webp" alt="Hou Rui（侯睿）" width="70"/>
                          </a>
                        
						<small class="ml-3"> Hou Rui（侯睿） <span><a target="_blank" href="" class="btn btn-outline-success btn-sm btn-round ml-1">Follow</a></span>
                            <span class="text-muted d-block mt-1">Feb 18, 2023 · <span class="reading-time">
  
  
    17 mins read
  
</span>
</span>
						</small>
					</div>
				</div>
                
				<div class="col-md-6 pr-0 align-self-center">
					<img class="rounded" src="/assets/2023/02-wechaty-flask-service-en/wechaty.webp" alt="Building a Message Notification Service with Wechaty and Flask">
				</div>
                
			</div>
		</div>
	</div>
</div>





<div class="container-lg pt-4 pb-4">
	<div class="row justify-content-center">

    <!-- Share -->
<div class="col-lg-2 pr-4 mb-5 col-md-12">
  <div class="sticky-top sticky-top-offset text-center">
    <div class="text-muted">
    </div>
    <div class="share d-inline-block">
      <!-- AddToAny BEGIN -->
      <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
        <a class="a2a_button_wechat" title='Wechat'>
          <img id="qrcode" title="Wechat"
            src="/assets/contributors/wechaty/icon.png"
            width="64" height="64"
          />
        </a>
        <a class="a2a_button_wechat" title='Wechat'></a>
        <a class="a2a_button_sina_weibo" title='Weibo'></a>
        <a class="a2a_button_linkedin" title='LinkedIn'></a>
        <a class="a2a_button_facebook" title='FaceBook'></a>
        <a class="a2a_button_twitter" title='Twitter'></a>
        <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
        <!-- AddToAny BEGIN -->
      </div>
      <script async src="https://static.addtoany.com/menu/page.js"></script>
      <!-- AddToAny END -->
    </div>
  </div>
</div>

<script>
  var href = document.location.href
  var url = 'https://api.qrserver.com/v1/create-qr-code/?data='
            + href
            + '&size=512x512'
  var img = document.getElementById('qrcode')

  img.src=encodeURI(url)
</script>


		<div class="col-md-12 col-lg-8">

      <!-- Article -->
			<article class="article-post">
			<p><a href="https://wechaty.js.org"><img src="https://img.shields.io/badge/Powered%20By-Wechaty-green.svg" alt="Powered by Wechaty" /></a>
<a href="https://wechaty.js.org/docs/contributor-program"><img src="https://img.shields.io/badge/Wechaty-Contributor%20Program-green.svg" alt="Wechaty Contributor Program" /></a>
<a href="https://github.com/juzibot/Welcome/wiki/Everything-about-Wechaty/"><img src="https://img.shields.io/badge/Wechaty%20Contributor%20Program-Juzi.BOT-orange.svg" alt="Juzi.BOT Developer Program" /></a></p>

<blockquote>
  <p>Author: <a href="https://github.com/Houruirui">Houruirui</a>, coding enthusiast.</p>
</blockquote>

<p><a href="https://github.com/Houruirui/wechaty-flask">Wechaty-Flask-Service</a></p>

<!-- more -->

<p>Currently, there are various APIs on the market that provide message push notifications, such as DingTalk, Spark, IFTTT, Telegram, etc. However, the overwhelming variety of message notifications in everyone’s phones can be too much to handle. WeChat, as the most widely used chat tool, is rarely ignored when it comes to reading messages. Therefore, the most convenient approach is to push messages through a WeChat bot.</p>

<p>Through research, I found that current message bots in the market include itchat, wxpy, wechaty, and others. However, with Tencent applying pressure, itchat and wxpy based on web WeChat can no longer be used. Wechaty supports multiple protocols and is more secure than the web protocol, so I decided to use wechaty based on the iPad protocol (PadLocal) to build the bot. However, in practical applications, wechaty is implemented through message callback functions, which means there’s no way to make the bot proactively send messages. Another issue is that you may have many applications that need WeChat notifications, but one token can only be used for one WeChat account. How can multiple services send notifications through this single WeChat account? For these two problems, my solution was to first implement bot initialization myself, and after completing initialization, directly return the bot without letting it enter the message listening loop, thus actively controlling the bot to send and receive messages. In a multi-service scenario, I used Flask to build a backend service to maintain the initialized bot, allowing different services to send requests directly to the backend to implement message notifications.</p>

<p>Let’s get to the point!</p>

<h2 id="environment-and-dependencies">Environment and Dependencies</h2>

<p>python
aioflask
asyncio</p>

<h2 id="deploying-wechaty-puppet-hostie">Deploying Wechaty Puppet Hostie</h2>

<p>Since the native wechaty is written in JavaScript and TypeScript, you need to set up a Wechaty Puppet Hostie service through Docker as a relay, which can then be called through Python.</p>

<ul>
  <li><strong>Pre-deployment Requirements:</strong></li>
</ul>

<p>A server that meets the following three requirements:</p>

<blockquote>
  <p>Public IP
Public Port
Docker</p>
</blockquote>

<ul>
  <li><strong>Deploy Wechaty Puppet Hostie</strong></li>
</ul>

<p>The specific code is as follows (my server is Ubuntu 18.04):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#! /usr/bin/bash</span>

<span class="nb">export </span><span class="nv">WECHATY_LOG</span><span class="o">=</span><span class="s2">"verbose"</span>
<span class="nb">export </span><span class="nv">WECHATY_PUPPET</span><span class="o">=</span><span class="s2">"wechaty-puppet-padlocal"</span>
<span class="nb">export </span><span class="nv">WECHATY_PUPPET_PADLOCAL_TOKEN</span><span class="o">=</span><span class="s2">"puppet_padlocal__TOKEN__"</span>

<span class="nb">export </span><span class="nv">WECHATY_PUPPET_SERVER_PORT</span><span class="o">=</span><span class="s2">"9001"</span>
<span class="nb">export </span><span class="nv">WECHATY_TOKEN</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> https://www.uuidgenerator.net/api/version4<span class="si">)</span>
  <span class="nt">--name</span> wechaty_puppet_service_token_gateway <span class="se">\</span>
  <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_LOG <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_PUPPET <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_PUPPET_PADLOCAL_TOKEN <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_PUPPET_SERVER_PORT <span class="se">\</span>
  <span class="nt">-e</span> WECHATY_TOKEN <span class="se">\</span>
  <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$WECHATY_PUPPET_SERVER_PORT</span><span class="s2">:</span><span class="nv">$WECHATY_PUPPET_SERVER_PORT</span><span class="s2">"</span> <span class="se">\</span>
  wechaty/wechaty
</code></pre></div></div>

<p>The WECHATY_PUPPET_PADLOCAL_TOKEN in the code needs to be applied for from the official team. You can get a 7-day trial token, and through the community incentive program, you can also get a longer-lasting token for free. <a href="https://wechaty.js.org/docs/contributor-program/">See details here</a>.</p>

<ul>
  <li><strong>Verify Wechaty Puppet Hostie</strong></li>
</ul>

<p>Access <a href="https://api.chatie.io/v0/hosties/WECHATY_TOKEN">https://api.chatie.io/v0/hosties/WECHATY_TOKEN</a>, where WECHATY_TOKEN is the token you just set yourself. When the returned result is the server’s public IP, deployment is successful; if it returns 0.0.0.0, deployment has failed~</p>

<h2 id="project-approach">Project Approach</h2>

<p>Regarding the bot, I read the code in the official examples and found that all bots inherit from the Wechaty base class to implement various functions through custom callback functions. Using event-driven callback functions is very passive, and I wanted to get a directly callable Wechaty object without entering the event loop monitoring through the start() function, so it could actively send messages. After a day of reading code and self-exploration, I finally managed to create a directly callable bot object. Please refer to the detailed code later. The most important thing is still needing to enter event listening, then after listening to the successful login event, interrupt the listening and return the already logged-in bot object, thus enabling direct calls.</p>

<p>First, we initialize the bot object. I wanted to send message notifications to group chats, and during use, I discovered that WeChat groups weren’t loaded after initializing the bot, so we need to first use the official examples to get the WeChat group IDs, then manually load the WeChat groups. Additionally, I found that if messages are sent synchronously, Flask needs 5-10 seconds to process the request, so here I used threads to handle different requests, implementing message concurrency.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">aioflask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="n">aioflask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="n">Config</span> <span class="kn">import</span> <span class="n">WECHAT_SEVER_CONFIG</span>
<span class="kn">import</span> <span class="n">concurrent.futures</span>
<span class="kn">from</span> <span class="n">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">import</span> <span class="n">threading</span>
<span class="kn">import</span> <span class="n">itertools</span>

<span class="kn">from</span> <span class="n">wechaty</span> <span class="kn">import</span> <span class="n">Wechaty</span><span class="p">,</span> <span class="n">Message</span><span class="p">,</span> <span class="n">WechatyPlugin</span><span class="p">,</span> <span class="n">Room</span><span class="p">,</span> <span class="n">WechatyOptions</span>
<span class="kn">from</span> <span class="n">wechaty_puppet</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">asyncio</span>
<span class="kn">import</span> <span class="n">json</span>
<span class="kn">import</span> <span class="n">traceback</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">WECHATY_PUPPET_SERVICE_TOKEN</span> <span class="o">=</span> <span class="sh">''</span>
<span class="n">WECHATY_PUPPET</span> <span class="o">=</span> <span class="sh">'</span><span class="s">wechaty-puppet-service</span><span class="sh">'</span>

<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WECHATY_PUPPET_SERVICE_TOKEN</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET_SERVICE_TOKEN</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WECHATY_PUPPET</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="sh">'</span><span class="s">WECHATY_PUPPET_SERVICE_ENDPOINT</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">0.0.0.0:9001</span><span class="sh">"</span>

<span class="k">class</span> <span class="nc">WechatBot</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">need to Init wechat bot!</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">:</span> <span class="n">Wechaty</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">().</span><span class="nf">run_until_complete</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">init_wechat_bot</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">init_wechat_bot</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">puppet_options</span> <span class="o">=</span> <span class="nc">PuppetOptions</span><span class="p">()</span>
        <span class="n">puppet_options</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET_SERVICE_TOKEN</span>

        <span class="n">options</span> <span class="o">=</span> <span class="nc">WechatyOptions</span><span class="p">()</span>
        <span class="c1"># options.name = self.my_wechat_id
</span>        <span class="n">options</span><span class="p">.</span><span class="n">puppet</span> <span class="o">=</span> <span class="n">WECHATY_PUPPET</span>
        <span class="n">options</span><span class="p">.</span><span class="n">puppet_options</span> <span class="o">=</span> <span class="n">puppet_options</span>

        <span class="n">self</span><span class="p">.</span><span class="n">bot</span> <span class="o">=</span> <span class="nc">Wechaty</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="nf">init_puppet</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="nf">init_puppet_event_bridge</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="nf">_init_puppet</span><span class="p">()</span>
        <span class="c1"># await self.bot.puppet.logout()
</span>        <span class="c1"># print(self.bot.puppet.login_user_id)
</span>        <span class="k">async</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">puppet_stub</span><span class="p">.</span><span class="nf">event</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">payload_data</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">payload</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_SCAN</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive scan info,</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="c1"># create qr_code
</span>                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventScanPayload</span><span class="p">(</span>
                        <span class="n">status</span><span class="o">=</span><span class="nc">ScanStatus</span><span class="p">(</span><span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">status</span><span class="sh">'</span><span class="p">]),</span>
                        <span class="n">qrcode</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">qrcode</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">scan payload_data</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">scan</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_LOGIN</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive login info </span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="c1"># print('login payload_data', payload_data)
</span>                    <span class="n">event_login_payload</span> <span class="o">=</span> <span class="nc">EventLoginPayload</span><span class="p">(</span>
                        <span class="n">contact_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">contactId</span><span class="sh">'</span><span class="p">])</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">login_user_id</span> <span class="o">=</span> <span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">contactId</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">login</span><span class="sh">'</span><span class="p">,</span> <span class="n">event_login_payload</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_READY</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive ready info </span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventReadyPayload</span><span class="p">(</span><span class="o">**</span><span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">ready</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_ROOM_TOPIC</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive room-topic info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventRoomTopicPayload</span><span class="p">(</span>
                        <span class="n">changer_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">changerId</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">new_topic</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">newTopic</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">old_topic</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">oldTopic</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">room_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">roomId</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">room-topic</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_DONG</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive dong info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventDongPayload</span><span class="p">(</span><span class="o">**</span><span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">dong</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_MESSAGE</span><span class="p">):</span>
                    <span class="c1"># payload = get_message_payload_from_response(response)
</span>                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive message info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">event_message_payload</span> <span class="o">=</span> <span class="nc">EventMessagePayload</span><span class="p">(</span>
                        <span class="n">message_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">messageId</span><span class="sh">'</span><span class="p">])</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">,</span> <span class="n">event_message_payload</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_HEARTBEAT</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive heartbeat info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="c1"># Huan(202005) FIXME:
</span>                    <span class="c1">#   https://github.com/wechaty/python-wechaty-puppet/issues/6
</span>                    <span class="c1">#   Workaround for unexpected server json payload key: timeout
</span>                    <span class="c1"># if 'timeout' in payload_data:
</span>                    <span class="c1">#     del payload_data['timeout']
</span>                    <span class="n">payload_data</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">:</span> <span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">]}</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventHeartbeatPayload</span><span class="p">(</span><span class="o">**</span><span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">heartbeat</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_ERROR</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive error info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventErrorPayload</span><span class="p">(</span><span class="o">**</span><span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">error</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_FRIENDSHIP</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive friendship info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventFriendshipPayload</span><span class="p">(</span>
                        <span class="n">friendship_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">friendshipId</span><span class="sh">'</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">friendship</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_ROOM_JOIN</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive room-join info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventRoomJoinPayload</span><span class="p">(</span>
                        <span class="n">invited_ids</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">inviteeIdList</span><span class="sh">'</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="n">inviter_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">inviterId</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">room_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">roomId</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">room-join</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_ROOM_INVITE</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive room-invite info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventRoomInvitePayload</span><span class="p">(</span>
                        <span class="n">room_invitation_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span>
                            <span class="sh">'</span><span class="s">roomInvitationId</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">room-invite</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_ROOM_LEAVE</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive room-leave info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventRoomLeavePayload</span><span class="p">(</span>
                        <span class="n">removed_ids</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">removeeIdList</span><span class="sh">'</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="n">remover_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">removerId</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">room_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">roomId</span><span class="sh">'</span><span class="p">),</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">timestamp</span><span class="sh">'</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">room-leave</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_LOGOUT</span><span class="p">):</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">receive logout info &lt;%s&gt;</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload_data</span><span class="p">)</span>
                    <span class="n">payload</span> <span class="o">=</span> <span class="nc">EventLogoutPayload</span><span class="p">(</span>
                        <span class="n">contact_id</span><span class="o">=</span><span class="n">payload_data</span><span class="p">[</span><span class="sh">'</span><span class="s">contactId</span><span class="sh">'</span><span class="p">],</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">payload_data</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">data</span><span class="sh">'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">login_user_id</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">puppet</span><span class="p">.</span><span class="n">_event_stream</span><span class="p">.</span><span class="nf">emit</span><span class="p">(</span><span class="sh">'</span><span class="s">logout</span><span class="sh">'</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">response</span><span class="p">.</span><span class="nb">type</span> <span class="o">==</span> <span class="nf">int</span><span class="p">(</span><span class="n">EventType</span><span class="p">.</span><span class="n">EVENT_TYPE_UNSPECIFIED</span><span class="p">):</span>
                    <span class="k">pass</span>
        <span class="k">for</span> <span class="n">room_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">ROOMS</span><span class="p">.</span><span class="nf">items</span><span class="p">():</span>
            <span class="n">room</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bot</span><span class="p">.</span><span class="n">Room</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">await</span> <span class="n">room</span><span class="p">.</span><span class="nf">ready</span><span class="p">()</span>
            <span class="n">ROOMS</span><span class="p">[</span><span class="n">room_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">room</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">room_name</span><span class="p">,</span> <span class="sh">"</span><span class="s">ready!</span><span class="sh">"</span><span class="p">,</span> <span class="n">room</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">ROOMS</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EventLoopThread</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_count</span> <span class="o">=</span> <span class="n">itertools</span><span class="p">.</span><span class="nf">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">started</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Event</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="nf">next</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_count</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">loop</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">loop</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">is_running</span><span class="p">(),</span> <span class="n">loop</span><span class="p">.</span><span class="nf">is_closed</span><span class="p">(),</span> <span class="n">loop</span><span class="p">.</span><span class="nf">get_debug</span><span class="p">()</span>
        <span class="nf">return </span><span class="p">(</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">&lt;</span><span class="si">{</span><span class="nf">type</span><span class="p">(</span><span class="n">self</span><span class="p">).</span><span class="n">__name__</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="si">}</span><span class="s"> id=</span><span class="si">{</span><span class="n">self</span><span class="p">.</span><span class="n">ident</span><span class="si">}</span><span class="s"> </span><span class="sh">"</span>
            <span class="sa">f</span><span class="sh">"</span><span class="s">running=</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s"> closed=</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s"> debug=</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s">&gt;</span><span class="sh">"</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">new_event_loop</span><span class="p">()</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="nf">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">call_later</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">started</span><span class="p">.</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">run_forever</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutdown_asyncgens</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">shutdown_asyncgens</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loop</span><span class="p">.</span><span class="nf">run_until_complete</span><span class="p">(</span><span class="n">shutdown_asyncgens</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutdown_executor</span> <span class="o">=</span> <span class="n">loop</span><span class="p">.</span><span class="nf">shutdown_default_executor</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loop</span><span class="p">.</span><span class="nf">run_until_complete</span><span class="p">(</span><span class="n">shutdown_executor</span><span class="p">)</span>
            <span class="n">asyncio</span><span class="p">.</span><span class="nf">set_event_loop</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">loop</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">loop</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">loop</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">loop</span><span class="p">.</span><span class="nf">call_soon_threadsafe</span><span class="p">(</span><span class="n">loop</span><span class="p">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>


<span class="n">_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="nc">Lock</span><span class="p">()</span>
<span class="n">_loop_thread</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">get_event_loop</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_loop_thread</span>

    <span class="k">if</span> <span class="n">_loop_thread</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_loop_thread</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">_loop_thread</span> <span class="o">=</span> <span class="nc">EventLoopThread</span><span class="p">()</span>
                <span class="n">_loop_thread</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
                <span class="c1"># give the thread up to a second to produce a loop
</span>                <span class="n">_loop_thread</span><span class="p">.</span><span class="n">started</span><span class="p">.</span><span class="nf">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_loop_thread</span><span class="p">.</span><span class="n">loop</span>


<span class="k">def</span> <span class="nf">stop_event_loop</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_loop_thread</span>
    <span class="k">with</span> <span class="n">_lock</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_loop_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_loop_thread</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
            <span class="n">_loop_thread</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">def</span> <span class="nf">run_coroutine</span><span class="p">(</span><span class="n">coro</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Run the coroutine in the event loop running in a separate thread

    Returns a Future, call Future.result() to get the output

    </span><span class="sh">"""</span>
    <span class="k">return</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="nf">get_event_loop</span><span class="p">())</span>





<span class="k">async</span> <span class="k">def</span> <span class="nf">send_wechat_message</span><span class="p">(</span><span class="n">room_str</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">ROOMS</span>
    <span class="n">room</span> <span class="o">=</span> <span class="n">ROOMS</span><span class="p">[</span><span class="n">room_str</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">room</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">room</span><span class="p">.</span><span class="nf">say</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/sendmessage</span><span class="sh">'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">POST</span><span class="sh">'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">send_message</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">json</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">room_str</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sh">'</span><span class="s">room</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sh">'</span><span class="s">message</span><span class="sh">'</span><span class="p">]</span>
            <span class="n">asyncio</span><span class="p">.</span><span class="nf">create_task</span><span class="p">(</span><span class="nf">send_wechat_message</span><span class="p">(</span><span class="n">room_str</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
            <span class="k">return</span> <span class="sh">"</span><span class="s">success</span><span class="sh">"</span>
    <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">send msg fail, error:</span><span class="sh">"</span><span class="p">,</span> <span class="n">traceback</span><span class="p">.</span><span class="nf">format_exc</span><span class="p">())</span>
    <span class="k">return</span> <span class="sh">'</span><span class="s">fail</span><span class="sh">'</span>

<span class="c1"># Group chats you need to send notifications to - you need to get IDs in advance using official examples
</span><span class="n">ROOMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">Happy Family</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">1111111111111@chatroom</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">],</span>
    <span class="sh">"</span><span class="s">Fellow Villagers</span><span class="sh">"</span><span class="p">:</span> <span class="p">[</span><span class="sh">"</span><span class="s">222222222@chatroom</span><span class="sh">"</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="nf">get_event_loop</span><span class="p">()</span>
    <span class="n">asyncio</span><span class="p">.</span><span class="nf">set_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="nc">WechatBot</span><span class="p">()</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="sh">'</span><span class="s">0.0.0.0</span><span class="sh">'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="sh">"</span><span class="s">9999</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div>

<p>At this point, our basic framework is set up. You can implement more complex projects based on this example code.</p>

<h2 id="acknowledgments">Acknowledgments</h2>

<p>Finally, we want to thank all the teams and individuals who provided us with tools and services. Special thanks to the open source project <a href="https://github.com/wechaty/wechaty">Wechaty</a> team and the PadLocal team for providing free services.</p>

<hr />

<blockquote>
  <p>本文也有<a href="/2023/02/18/wechaty-flask-service/">中文版本</a>。</p>
</blockquote>

			</article>

			<!-- Tags -->
			<div class="mb-4">
				<span class="taglist">
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#productivity">productivity</a>
				
				  <a class="sscroll btn btn-light btn-sm font-weight-bold" href="/tags.html#ecosystem">ecosystem</a>
				
				</span>
			</div>

            <!-- Mailchimp Subscribe Form -->
            
			<div class="border p-5 bg-lightblue">
				<div class="row justify-content-between">
					<div class="col-md-6 mb-2 mb-md-0">
						<h5 class="font-weight-bold">Join Newsletter</h5>
						 Get the latest news right in your inbox. We never spam!
					</div>
					<div class="col-md-6">
						<div class="row">
              <form action="https://zixia.us4.list-manage.com/subscribe/post?u=a8584b55dea5aa8bbc14bd1a0&amp;id=d9899f0d70" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate w-100" target="_blank" novalidate>
                <input type="email" placeholder="Enter e-mail address" name="EMAIL" class="required email form-control w-100" id="mce-EMAIL" autocomplete="on" required>
                <input type="text"  placeholder="Name"                 name="FNAME" class="required form-control w-100"       id="mce-FNAME" autocomplete="on" required>
                <button type="submit" value="Subscribe" name="subscribe" class="heart btn btn-success btn-block w-100 mt-2">Subscribe</button>
              </form>
						</div>
					</div>
				</div>
			</div>
            


             <!-- Author Box -->
                
				<div class="row mt-5">
					<div class="col-md-2 align-self-center">
                        
                          <a href="/contributors/houruirui">
                            <img class="rounded-circle" src="/assets/contributors/houruirui/avatar.webp" alt="Hou Rui（侯睿）" width="90"/>
                          </a>
                        
					</div>
					<div class="col-md-10">
                        <h5 class="font-weight-bold">Written by Hou Rui（侯睿） </h5>
						代码爱好者
					</div>
				</div>
                

            <!-- Comments -->
            
                <!--  Don't edit anything here. Set your disqus id in _config.yml -->

<div id="comments" class="mt-5">
    <div id="disqus_thread">
    </div>
    <script type="text/javascript">
        var disqus_shortname = 'wechaty'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
    Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
    </noscript>
</div>
            

		</div>


	</div>
</div>


<!-- Aletbar Prev/Next -->
<div class="alertbar">
    <div class="container">
        <div class="row prevnextlinks small font-weight-bold">
          
            <div class="col-md-6 rightborder pl-0">
                <a class="text-dark" href="/2023/01/18/workpro-immigration-guide/"> <img height="30px" class="mr-1" src="https://wechaty.js.org/assets/2023/01-workpro-immigration-guide-en/workpro.webp">  Wechaty Puppet Service WorkPro 迁移指南</a>
            </div>
          
          
            <div class="col-md-6 text-right pr-0">
                <a class="text-dark" href="/2023/02/18/wechaty-flask-service/"> 使用wechaty与Flask搭建消息通知服务  <img height="30px" class="ml-1" src="https://wechaty.js.org/assets/2023/02-wechaty-flask-service-en/wechaty.webp"> </a>
            </div>
          
        </div>
    </div>
</div>

    </main>


    <!-- Scripts: popper, bootstrap, theme, lunr -->
    <script src="https://cdnjs.loli.net/ajax/libs/popper.js/1.14.6/umd/popper.min.js" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script src="/assets/js/theme.js"></script>


    <!-- Footer -->
    <footer class="bg-white border-top p-3 text-muted small">
        <div class="container">
        <div class="row align-items-center justify-content-between">
            <div>
                <a href="#" class="text-muted navbar-brand mr-2 mb-0">
                  <strong>Wechaty</strong>
                </a>
                <span>Copyright © <script>document.write(new Date().getFullYear())</script></span>
                |
                <a
                  class="text-muted"
                  target="_blank"
                  href="/branding/"
                >
                  Branding
                </a>

                <!--  Github Repo Star Btn-->
                <a class="text-dark ml-1" target="_blank" href="https://github.com/wechaty"><i class="fab fa-github"></i> </a>

            </div>

            <div class="text-gray">
              Powered by
              <a
                class="text-gray font-weight-bold"
                target="_blank"
                href="https://www.wowthemes.net/mundana-jekyll-theme/"
              >
                Mundana Jekyll Theme
              </a>
              .
            </div>
        </div>
        </div>
    </footer>

    <!-- All this area goes before             <script>
                window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };
            </script>
            </body>
 closing tag -->


</body>

</html>
